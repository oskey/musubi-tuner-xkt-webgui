<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wan2.2 LoRA è®­ç»ƒç•Œé¢</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            color: #61dafb;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .header p {
            color: #a0a0a0;
            font-size: 1.1em;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .panel {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid #4a5568;
        }
        
        .panel h2 {
            color: #61dafb;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #61dafb;
            padding-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #e0e0e0;
            font-weight: 500;
            cursor: help;
        }
        
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #4a5568;
            border-radius: 8px;
            background: #1a202c;
            color: #e0e0e0;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: #61dafb;
            box-shadow: 0 0 0 3px rgba(97, 218, 251, 0.1);
        }
        
        .form-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        /* è§†é¢‘è®­ç»ƒé€‰é¡¹æ ·å¼ */
        .video-training-section {
            background: linear-gradient(135deg, #2a4365 0%, #3182ce 100%);
            border: 2px solid #4299e1;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .video-training-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4299e1, #63b3ed, #90cdf4);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .video-training-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .video-training-checkbox:hover {
            background: rgba(66, 153, 225, 0.1);
        }
        
        .video-training-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
            accent-color: #4299e1;
        }
        
        .video-training-checkbox label {
            font-size: 16px;
            font-weight: 600;
            color: #e2e8f0;
            cursor: pointer;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .video-training-checkbox label::before {
            content: 'ğŸ¬';
            font-size: 18px;
        }
        
        .video-duration-settings {
            background: rgba(26, 32, 44, 0.6);
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: none;
            transition: all 0.3s ease;
        }
        
        .video-duration-settings.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .video-duration-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .video-duration-input input {
            width: 80px;
            text-align: center;
            font-weight: bold;
        }
        
        .video-duration-input span {
            color: #a0aec0;
            font-size: 14px;
        }
        
        .form-group small {
            color: #a0a0a0;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }
        
        .btn {
            background: linear-gradient(135deg, #61dafb 0%, #21b4d3 100%);
            color: #1a202c;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(97, 218, 251, 0.3);
        }
        
        .btn:disabled {
            background: #4a5568;
            color: #a0a0a0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
        }
        
        .btn-danger:hover {
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
        }
        
        .log-container {
            background: #1a202c;
            border: 2px solid #4a5568;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-info { color: #61dafb; }
        .log-warning { color: #fbd38d; }
        .log-error { color: #fc8181; }
        .log-success { color: #68d391; }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-ready { background-color: #68d391; }
        .status-running { background-color: #61dafb; }
        .status-error { background-color: #fc8181; }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #4a5568;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #61dafb 0%, #21b4d3 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .config-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .collapsible-section {
            margin-top: 20px;
        }
        
        .collapsible-header {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            border: none;
            border-radius: 8px;
            color: #61dafb;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 15px 0;
        }
        
        .collapsible-content {
            display: none;
            padding: 10px;
            border: 1px solid #4a5568;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .task-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .task-type-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #4a5568;
            border-radius: 8px;
            background: #2d3748;
            color: #e0e0e0;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .task-type-btn.active {
            border-color: #61dafb;
            background: rgba(97, 218, 251, 0.1);
            color: #61dafb;
        }
        
        .input-with-button {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .input-with-button input {
            flex: 1;
        }
        
        .input-with-button button {
            flex-shrink: 0;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .config-layout {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ Wan2.2 LoRA è®­ç»ƒç•Œé¢</h1>
            <p>æ–‡ç”Ÿè§†é¢‘ & å›¾ç”Ÿè§†é¢‘ LoRA è®­ç»ƒå·¥å…·</p>
        </div>
        
        <div class="main-content">
            <!-- æ—¥å¿—é¢æ¿ -->
            <div class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">ğŸ“‹ è®­ç»ƒæ—¥å¿—</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="clearLogs()" class="btn" style="padding: 5px 10px; font-size: 12px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">ğŸ—‘ï¸ æ¸…ç†æ—¥å¿—</button>
                        <button onclick="scrollToBottom()" class="btn" style="padding: 5px 10px; font-size: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">æ»šåŠ¨åˆ°åº•éƒ¨</button>
                    </div>
                </div>
                <div class="log-container" id="log-output">
                    <div class="log-entry log-info">
                        <span style="color: #888;">[ç³»ç»Ÿ]</span> Wan2.2 è®­ç»ƒç•Œé¢å·²å°±ç»ª
                    </div>
                </div>
                
                <!-- çŠ¶æ€å’Œæ“ä½œæŒ‰é’® -->
                <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 15px;">
                    <div style="display: flex; align-items: center;">
                        <div class="status-indicator status-ready" id="status-indicator"></div>
                        <span id="status-text" style="color: #d4d4d4; font-size: 14px;">å°±ç»ª</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                    <button onclick="startTensorBoard()" class="btn" id="tensorboard-btn">ğŸ“Š å¯åŠ¨ TensorBoard</button>
                    <button onclick="startCacheVAE()" class="btn" id="cache-vae-btn">ğŸ”„ é¢„ç¼“å­˜ VAE Latents</button>
                    <button onclick="startCacheTextEncoder()" class="btn" id="cache-te-btn">ğŸ“ é¢„ç¼“å­˜æ–‡æœ¬ç¼–ç å™¨è¾“å‡º</button>
                    <button onclick="startTraining()" class="btn" id="train-btn">ğŸ¯ å¼€å§‹è®­ç»ƒ</button>
                    <button onclick="stopTraining()" class="btn btn-danger" id="stop-btn" disabled>â¹ï¸ åœæ­¢è®­ç»ƒ</button>
                    <button onclick="convertLora()" class="btn" id="convert-lora-btn" style="background-color: #28a745; color: white;">ğŸ”„ è½¬æ¢ LoRA</button>
                </div>
            </div>
            
            <!-- ä»»åŠ¡ç±»å‹é€‰æ‹© -->
            <div class="panel">
                <h2>ğŸ¯ è®­ç»ƒä»»åŠ¡ç±»å‹</h2>
                <div class="task-type-selector">
                    <div class="task-type-btn active" id="t2v-btn" onclick="selectTaskType('t2v')">
                        <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“â¡ï¸ğŸ¬</div>
                        <div><strong>æ–‡ç”Ÿè§†é¢‘ (T2V)</strong></div>
                        <div style="font-size: 12px; color: #a0a0a0; margin-top: 4px;">ä»æ–‡æœ¬æè¿°ç”Ÿæˆè§†é¢‘</div>
                    </div>
                    <div class="task-type-btn" id="i2v-btn" onclick="selectTaskType('i2v')">
                        <div style="font-size: 24px; margin-bottom: 8px;">ğŸ–¼ï¸â¡ï¸ğŸ¬</div>
                        <div><strong>å›¾ç”Ÿè§†é¢‘ (I2V)</strong></div>
                        <div style="font-size: 12px; color: #a0a0a0; margin-top: 4px;">ä»å›¾ç‰‡ç”Ÿæˆè§†é¢‘</div>
                    </div>
                </div>
            </div>
            
            <!-- è™šæ‹Ÿç¯å¢ƒé…ç½® -->
            <div class="panel" style="margin-bottom: 20px;">
                <h2>ğŸ è¿è¡Œç¯å¢ƒ</h2>
                <div class="form-group">
                    <label title="å¯ç”¨è™šæ‹Ÿç¯å¢ƒå¯ä»¥ç¡®ä¿è®­ç»ƒè¿‡ç¨‹ä½¿ç”¨æŒ‡å®šçš„Pythonç¯å¢ƒï¼Œé¿å…ä¾èµ–å†²çªã€‚">å¯ç”¨è™šæ‹Ÿç¯å¢ƒ</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="enable_venv" checked title="å¯ç”¨è™šæ‹Ÿç¯å¢ƒå¯ä»¥ç¡®ä¿è®­ç»ƒè¿‡ç¨‹ä½¿ç”¨æŒ‡å®šçš„Pythonç¯å¢ƒï¼Œé¿å…ä¾èµ–å†²çªã€‚">
                        <span style="color: #666; font-size: 14px;">ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒæ‰§è¡Œè®­ç»ƒå‘½ä»¤</span>
                    </div>
                </div>
                
                <div class="form-group" id="venv_path_group">
                    <label title="è™šæ‹Ÿç¯å¢ƒçš„Pythonå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ã€‚é€šå¸¸ä½äºè™šæ‹Ÿç¯å¢ƒçš„Scriptsç›®å½•ä¸‹ã€‚">è™šæ‹Ÿç¯å¢ƒPythonè·¯å¾„</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="venv_python_path" title="è™šæ‹Ÿç¯å¢ƒçš„Pythonå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ã€‚é€šå¸¸ä½äºè™šæ‹Ÿç¯å¢ƒçš„Scriptsç›®å½•ä¸‹ã€‚" style="flex: 1;">
                        <button type="button" onclick="selectFolder('venv_python_path')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ è™šæ‹Ÿç¯å¢ƒçš„Scriptsç›®å½•è·¯å¾„</small>
                </div>
            </div>
            
            <!-- é…ç½®å¸ƒå±€ -->
            <div class="config-layout">
                <!-- å·¦ä¾§ï¼šåŸºç¡€é…ç½® -->
                <div class="panel">
                    <h2>ğŸ“ åŸºç¡€é…ç½®</h2>
                    <div class="form-group">
                        <label title="TOMLæ ¼å¼çš„æ•°æ®é›†é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰äº†è®­ç»ƒæ•°æ®çš„è·¯å¾„ã€æ ‡ç­¾å’Œé¢„å¤„ç†å‚æ•°ã€‚">æ•°æ®é›†é…ç½®æ–‡ä»¶ (dataset_config)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="dataset_config" title="TOMLæ ¼å¼çš„æ•°æ®é›†é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰äº†è®­ç»ƒæ•°æ®çš„è·¯å¾„ã€æ ‡ç­¾å’Œé¢„å¤„ç†å‚æ•°ã€‚" style="flex: 1;">
                            <button type="button" onclick="selectFileWithDialog('dataset_config')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ åŒ…å«è®­ç»ƒæ•°æ®è·¯å¾„å’Œæ ‡ç­¾çš„TOMLé…ç½®æ–‡ä»¶</small>
                    </div>
                    
                    <div class="form-group">
                        <label title="Wan2.2 DiTæ¨¡å‹è·¯å¾„ã€‚è¿™æ˜¯è®­ç»ƒçš„åŸºç¡€æ¨¡å‹ã€‚">DiTæ¨¡å‹è·¯å¾„ (dit)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="dit" title="Wan2.2 DiTæ¨¡å‹è·¯å¾„ã€‚è¿™æ˜¯è®­ç»ƒçš„åŸºç¡€æ¨¡å‹ã€‚" style="flex: 1;">
                            <button type="button" onclick="selectFileWithDialog('dit')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ Wan2.2çš„DiTæ‰©æ•£å˜æ¢å™¨æ¨¡å‹</small>
                    </div>
                    
                    <div class="form-group">
                        <label title="T5æ–‡æœ¬ç¼–ç å™¨æ¨¡å‹è·¯å¾„ã€‚ç”¨äºå°†æ–‡æœ¬æç¤ºç¼–ç ä¸ºå‘é‡è¡¨ç¤ºã€‚">T5æ–‡æœ¬ç¼–ç å™¨è·¯å¾„ (t5)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="t5" title="T5æ–‡æœ¬ç¼–ç å™¨æ¨¡å‹è·¯å¾„ã€‚ç”¨äºå°†æ–‡æœ¬æç¤ºç¼–ç ä¸ºå‘é‡è¡¨ç¤ºã€‚" style="flex: 1;">
                            <button type="button" onclick="selectFileWithDialog('t5')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ T5æ–‡æœ¬ç¼–ç å™¨ï¼ŒWan2.2æ— éœ€CLIP</small>
                    </div>
                    
                    <div class="form-group">
                        <label title="å˜åˆ†è‡ªç¼–ç å™¨(VAE)æ¨¡å‹è·¯å¾„ã€‚VAEè´Ÿè´£åœ¨åƒç´ ç©ºé—´å’Œæ½œåœ¨ç©ºé—´ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚">VAEæ¨¡å‹è·¯å¾„ (vae)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="vae" title="å˜åˆ†è‡ªç¼–ç å™¨(VAE)æ¨¡å‹è·¯å¾„ã€‚VAEè´Ÿè´£åœ¨åƒç´ ç©ºé—´å’Œæ½œåœ¨ç©ºé—´ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚" style="flex: 1;">
                            <button type="button" onclick="selectFileWithDialog('vae')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ è´Ÿè´£è§†é¢‘çš„ç¼–ç å’Œè§£ç å¤„ç†</small>
                    </div>
                    
                    <div class="form-group">
                        <label title="è¾“å‡ºç›®å½•è·¯å¾„ã€‚è®­ç»ƒå®Œæˆçš„LoRAæ¨¡å‹å°†ä¿å­˜åˆ°æ­¤ç›®å½•ã€‚">è¾“å‡ºç›®å½• (output_dir)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="output_dir" title="è¾“å‡ºç›®å½•è·¯å¾„ã€‚è®­ç»ƒå®Œæˆçš„LoRAæ¨¡å‹å°†ä¿å­˜åˆ°æ­¤ç›®å½•ã€‚" style="flex: 1;">
                            <button type="button" onclick="selectFolder('output_dir')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ è®­ç»ƒå®Œæˆçš„æ¨¡å‹æ–‡ä»¶ä¿å­˜ä½ç½®</small>
                    </div>
                    
                    <div class="form-group">
                        <label title="è¾“å‡ºæ¨¡å‹åç§°ã€‚è®­ç»ƒå®Œæˆåä¿å­˜çš„LoRAæ¨¡å‹æ–‡ä»¶åå‰ç¼€ã€‚">è¾“å‡ºæ¨¡å‹åç§° (output_name)</label>
                        <input type="text" id="output_name" title="è¾“å‡ºæ¨¡å‹åç§°ã€‚è®­ç»ƒå®Œæˆåä¿å­˜çš„LoRAæ¨¡å‹æ–‡ä»¶åå‰ç¼€ã€‚" style="width: 100%;">
                        <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ ä¿å­˜çš„LoRAæ¨¡å‹æ–‡ä»¶åå‰ç¼€</small>
                    </div>
                    
                    <!-- LoRAè½¬æ¢è®¾ç½®åˆ†ç»„ -->
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <h3 style="margin-bottom: 15px; color: #333;">ğŸ”„ LoRAè½¬æ¢è®¾ç½®</h3>
                        
                        <div class="form-group">
                            <label title="å¾…è½¬æ¢çš„LoRAæ–‡ä»¶å®Œæ•´è·¯å¾„ã€‚é€‰æ‹©éœ€è¦è½¬æ¢ä¸ºComfyUIæ ¼å¼çš„LoRAæ–‡ä»¶ã€‚">å¾…è½¬æ¢LoRAæ–‡ä»¶åœ°å€</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="convert_input_file" title="å¾…è½¬æ¢çš„LoRAæ–‡ä»¶å®Œæ•´è·¯å¾„ã€‚é€‰æ‹©éœ€è¦è½¬æ¢ä¸ºComfyUIæ ¼å¼çš„LoRAæ–‡ä»¶ã€‚" style="flex: 1;">
                                <button type="button" onclick="selectFileWithDialog('convert_input_file')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                            </div>
                            <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ é€‰æ‹©è¦è½¬æ¢çš„LoRAæ–‡ä»¶ï¼ˆ.safetensorsæ ¼å¼ï¼‰</small>
                        </div>
                        
                        <div class="form-group">
                            <label title="è½¬æ¢åLoRAæ–‡ä»¶ä¿å­˜çš„ç›®å½•è·¯å¾„ã€‚è½¬æ¢åçš„æ–‡ä»¶å°†ä¿å­˜åˆ°æ­¤ç›®å½•ã€‚">è½¬æ¢åLoRAæ–‡ä»¶åœ°å€</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="convert_output_dir" title="è½¬æ¢åLoRAæ–‡ä»¶ä¿å­˜çš„ç›®å½•è·¯å¾„ã€‚è½¬æ¢åçš„æ–‡ä»¶å°†ä¿å­˜åˆ°æ­¤ç›®å½•ã€‚" style="flex: 1;">
                                <button type="button" onclick="selectFolder('convert_output_dir')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                            </div>
                            <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ è½¬æ¢åçš„ComfyUIæ ¼å¼æ–‡ä»¶ä¿å­˜ç›®å½•</small>
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§è®­ç»ƒå‚æ•°é¢æ¿ -->
                <div class="panel">
                    <h2>ğŸ“ æ ¸å¿ƒè®­ç»ƒå‚æ•°</h2>
                    
                    <!-- è®­ç»ƒç±»å‹é€‰æ‹© -->
                    <div class="form-group">
                        <div class="video-training-section">
                            <div class="video-training-checkbox">
                                <input type="checkbox" id="video_training_checkbox" onchange="toggleVideoSettings()">
                                <label for="video_training_checkbox">è®­ç»ƒç±»å‹ â†’ è§†é¢‘</label>
                            </div>
                            
                            <div id="video_duration_settings" class="video-duration-settings">
                                <label for="video_duration">è§†é¢‘æ€»æ—¶é•¿è®¾ç½®:</label>
                                <div class="video-duration-input">
                                    <input type="number" id="video_duration" value="300" min="1" max="3600" step="1">
                                    <span>ç§’</span>
                                </div>
                                <small>æ‰€æœ‰è§†é¢‘æ–‡ä»¶çš„æ€»æ—¶é•¿ï¼ˆç§’ï¼‰ï¼Œä¼šå½±å“GPTæ¨èçš„å‚æ•°è®¡ç®—ï¼Œç³»ç»Ÿå°†æ ¹æ®æ€»æ—¶é•¿è‡ªåŠ¨è°ƒèŠ‚è®­ç»ƒå‚æ•°</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label title="è®­ç»ƒæ‰¹æ¬¡å¤§å°ã€‚å½±å“æ˜¾å­˜ä½¿ç”¨å’Œè®­ç»ƒé€Ÿåº¦ã€‚">è®­ç»ƒæ‰¹æ¬¡å¤§å° (batch_size)</label>
                        <input type="number" id="batch_size" min="1" max="32" title="è®­ç»ƒæ‰¹æ¬¡å¤§å°ã€‚å½±å“æ˜¾å­˜ä½¿ç”¨å’Œè®­ç»ƒé€Ÿåº¦ã€‚">
                        <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èå€¼ï¼š1-4ï¼Œæ ¹æ®æ˜¾å­˜å¤§å°è°ƒæ•´</small>
                    </div>
                    
                    <div class="form-group">
                        <label title="æ•°æ®é‡å¤æ¬¡æ•° - ä»TOMLé…ç½®æ–‡ä»¶è¯»å–ã€‚æ¨èå€¼20~30ï¼ˆå›¾ç‰‡è¾ƒå°‘æ—¶ï¼‰ï¼Œæ¨¡å‹èƒ½æ›´å®¹æ˜“è®°ä½ç‰¹å¾ã€‚">æ•°æ®é‡å¤æ¬¡æ•° (num_repeats)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="num_repeats" min="1" max="100" title="æ•°æ®é‡å¤æ¬¡æ•° - ä»TOMLé…ç½®æ–‡ä»¶è¯»å–ã€‚æ¨èå€¼20~30ï¼ˆå›¾ç‰‡è¾ƒå°‘æ—¶ï¼‰ï¼Œæ¨¡å‹èƒ½æ›´å®¹æ˜“è®°ä½ç‰¹å¾ã€‚" style="flex: 1;">
                            <button onclick="setRecommendedNumRepeats()" class="btn" style="background: linear-gradient(45deg, #3498db, #2980b9); color: white; padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 6px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'">ğŸ”§ è½¯ä»¶æ¨èå€¼</button>
                            <button onclick="setChatGPTRecommendedNumRepeats()" class="btn" style="background: linear-gradient(45deg, #4ECDC4, #44A08D); color: white; padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 6px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'">ğŸ¤– ChatGPTæ¨èå€¼</button>
                        </div>
                        <div style="margin-top: 5px;">
                            <span style="color: #666; cursor: pointer; user-select: none; display: inline-flex; align-items: center; gap: 5px;" 
                                  onclick="toggleRecommendationTip()" 
                                  onmouseover="this.style.color='#3498db'" 
                                  onmouseout="this.style.color='#666'" 
                                  title="ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†æ¨èé€»è¾‘">
                                <span id="tip-icon">ğŸ’¡</span> <strong>è½¯ä»¶æ¨èæç¤º</strong>
                            </span>
                            <span style="color: #666; cursor: pointer; user-select: none; display: inline-flex; align-items: center; gap: 5px; margin-left: 20px;" 
                                  onclick="toggleChatGPTRecommendationTip()" 
                                  onmouseover="this.style.color='#4ECDC4'" 
                                  onmouseout="this.style.color='#666'" 
                                  title="ç‚¹å‡»æŸ¥çœ‹ChatGPTæ¨èé€»è¾‘">
                                <span id="chatgpt-tip-icon">ğŸ¤–</span> <strong>ChatGPTæ¨èæç¤º</strong>
                            </span>
                            <div id="recommendation-tip" style="display: none; color: #666; margin-top: 8px; line-height: 1.4; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #3498db;">
                                <strong>âš™ï¸ å®ç°çš„åŠŸèƒ½é€»è¾‘</strong><br><br>
                                <strong>éè§†é¢‘è®­ç»ƒæ¨¡å¼</strong>ï¼ˆæœªå‹¾é€‰è§†é¢‘è®­ç»ƒï¼‰ï¼š<br>
                                â€¢ å°æ•°æ®é›†(â‰¤50ä¸ªæ–‡ä»¶)ï¼šæ¨è10æ¬¡é‡å¤<br>
                                â€¢ ä¸­ç­‰æ•°æ®é›†(51-200ä¸ªæ–‡ä»¶)ï¼šæ¨è5æ¬¡é‡å¤<br>
                                â€¢ è¾ƒå¤§æ•°æ®é›†(201-500ä¸ªæ–‡ä»¶)ï¼šæ¨è3æ¬¡é‡å¤<br>
                                â€¢ å¤§æ•°æ®é›†(>500ä¸ªæ–‡ä»¶)ï¼šæ¨è1æ¬¡é‡å¤<br><br>
                                <strong>è§†é¢‘è®­ç»ƒæ¨¡å¼</strong>ï¼ˆå‹¾é€‰è§†é¢‘è®­ç»ƒï¼‰ï¼š<br>
                                â€¢ çŸ­è§†é¢‘(â‰¤5ç§’)ï¼šæ¨è20æ¬¡é‡å¤<br>
                                â€¢ ä¸­çŸ­è§†é¢‘(6-10ç§’)ï¼šæ¨è15æ¬¡é‡å¤<br>
                                â€¢ ä¸­ç­‰è§†é¢‘(11-20ç§’)ï¼šæ¨è10æ¬¡é‡å¤<br>
                                â€¢ è¾ƒé•¿è§†é¢‘(21-30ç§’)ï¼šæ¨è8æ¬¡é‡å¤<br>
                                â€¢ é•¿è§†é¢‘(>30ç§’)ï¼šæ¨è5æ¬¡é‡å¤<br>
                                â€¢ åŒæ—¶è€ƒè™‘æ•°æ®é›†å¤§å°è¿›è¡Œå¾®è°ƒ
                            </div>
                            <div id="chatgpt-recommendation-tip" style="display: none; color: #666; margin-top: 8px; line-height: 1.4; padding: 10px; background: #f0fffe; border-radius: 6px; border-left: 3px solid #4ECDC4;">
                                <strong>ğŸ¤– ChatGPTæ¨èç®—æ³•</strong><br><br>
                                <strong>ğŸ“Š æ ¸å¿ƒè®¡ç®—å…¬å¼ï¼š</strong><br>
                                â€¢ total_steps = ceil((N_images Ã— repeats) / batch_size) Ã— epochs<br>
                                â€¢ steps_per_epoch = ceil((N_images Ã— repeats) / batch_size)<br><br>
                                <strong>ğŸ¯ ç›®æ ‡æ€»æ­¥æ•°èŒƒå›´ï¼š</strong><br>
                                â€¢ å¿«é€Ÿè¯•éªŒï¼š2k-5k steps<br>
                                â€¢ ä¸­ç­‰è´¨é‡ï¼š5k-20k steps<br>
                                â€¢ é«˜ç²¾åº¦è®­ç»ƒï¼š20k-50k+ steps<br><br>
                                <strong>ğŸ“ˆ æ•°æ®é›†å¤§å°æ¨èï¼š</strong><br>
                                â€¢ å°æ•°æ®é›†(â‰¤50æ–‡ä»¶)ï¼šrepeats 50-200ï¼Œé…åˆä½å­¦ä¹ ç‡<br>
                                â€¢ ä¸­ç­‰æ•°æ®é›†(51-200)ï¼šrepeats 10-50<br>
                                â€¢ å¤§æ•°æ®é›†(>500)ï¼šrepeats 1-5<br><br>
                                <strong>ğŸ¬ I2V vs T2Vå·®å¼‚ï¼š</strong><br>
                                â€¢ I2Vï¼šå•æ ·æœ¬åŒ…å«å¤šå¸§ï¼Œéœ€è¦è¾ƒå°‘repeats(1-20)<br>
                                â€¢ T2Vï¼šæ–‡æœ¬æ¡ä»¶å¤šæ ·ï¼Œå¯ç”¨ä¸­ç­‰repeats(10-50)<br><br>
                                <strong>âš ï¸ é‡è¦æé†’ï¼š</strong><br>
                                â€¢ å¢åŠ repeatsæ—¶éœ€é™ä½å­¦ä¹ ç‡(Ã—0.7-0.9)<br>
                                â€¢ ä¼˜å…ˆä½¿ç”¨æ•°æ®å¢å¼ºè€Œéå•çº¯é‡å¤<br>
                                â€¢ å¿…é¡»ç›‘æ§éªŒè¯é›†é˜²æ­¢è¿‡æ‹Ÿåˆ
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label title="å­¦ä¹ ç‡ã€‚æ§åˆ¶æ¨¡å‹å‚æ•°æ›´æ–°çš„æ­¥é•¿ï¼Œæ˜¯è®­ç»ƒä¸­æœ€å…³é”®çš„è¶…å‚æ•°ä¹‹ä¸€ã€‚">å­¦ä¹ ç‡ (learning_rate)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="learning_rate" title="å­¦ä¹ ç‡ã€‚æ§åˆ¶æ¨¡å‹å‚æ•°æ›´æ–°çš„æ­¥é•¿ï¼Œæ˜¯è®­ç»ƒä¸­æœ€å…³é”®çš„è¶…å‚æ•°ä¹‹ä¸€ã€‚" style="flex: 1;">
                            <button onclick="calculateRecommendedLearningRate()" class="btn" style="background: linear-gradient(45deg, #3498db, #2980b9); color: white; padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 6px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'">ğŸ”§ è½¯ä»¶æ¨èå€¼</button>
                            <button onclick="calculateGPTRecommendedLearningRate()" class="btn" style="background: linear-gradient(45deg, #4ECDC4, #44A08D); color: white; padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 6px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'">ğŸ¤– ChatGPTæ¨èå€¼</button>
                        </div>
                        <div style="margin-top: 5px;">
                            <span style="color: #666; cursor: pointer; user-select: none; display: inline-flex; align-items: center; gap: 5px;" 
                                  onclick="toggleLearningRateRecommendationTip()" 
                                  onmouseover="this.style.color='#3498db'" 
                                  onmouseout="this.style.color='#666'" 
                                  title="ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†æ¨èé€»è¾‘">
                                <span id="lr-tip-icon">ğŸ’¡</span> <strong>è½¯ä»¶æ¨èæç¤º</strong>
                            </span>
                            <span style="color: #666; cursor: pointer; user-select: none; display: inline-flex; align-items: center; gap: 5px; margin-left: 20px;" 
                                  onclick="toggleChatGPTLearningRateRecommendationTip()" 
                                  onmouseover="this.style.color='#4ECDC4'" 
                                  onmouseout="this.style.color='#666'" 
                                  title="ç‚¹å‡»æŸ¥çœ‹ChatGPTæ¨èé€»è¾‘">
                                <span id="chatgpt-lr-tip-icon">ğŸ¤–</span> <strong>ChatGPTæ¨èæç¤º</strong>
                            </span>
                            <div id="lr-recommendation-tip" style="display: none; color: #666; margin-top: 8px; line-height: 1.4; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #3498db;">
                                <strong>âš™ï¸ è½¯ä»¶æ¨èç®—æ³•é€»è¾‘</strong><br><br>
                                <strong>ğŸ’¡ å­¦ä¹ ç‡æ¨èï¼ˆåŸºäºWan2.2å®æˆ˜æ¡ˆä¾‹ï¼‰ï¼š</strong><br>
                                â€¢ <strong>Wan2.2 LoRAè®­ç»ƒ</strong>ï¼š3e-4æ˜¯ç»éªŒè¯çš„æœ‰æ•ˆå€¼ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯<br>
                                â€¢ <strong>T2Vä»»åŠ¡</strong>ï¼š1e-4 ~ 3e-4ï¼Œè§†é¢‘ç”Ÿæˆéœ€è¦æ›´ç¨³å®šçš„å­¦ä¹ è¿‡ç¨‹<br>
                                â€¢ <strong>I2Vä»»åŠ¡</strong>ï¼š2e-4 ~ 5e-4ï¼Œå›¾åƒåˆ°è§†é¢‘è½¬æ¢å¯é€‚å½“æé«˜å­¦ä¹ ç‡<br><br>
                                <strong>ğŸ“Š ä¼˜åŒ–å™¨åŒ¹é…ï¼ˆå®æˆ˜éªŒè¯ï¼‰ï¼š</strong><br>
                                â€¢ <strong>AdamW8bit</strong>ï¼š3e-4ï¼Œå†…å­˜å‹å¥½ä¸”æ•ˆæœç¨³å®š<br>
                                â€¢ <strong>Lion</strong>ï¼š1e-4ï¼Œéœ€è¦è¾ƒå°å­¦ä¹ ç‡ä½†æ”¶æ•›æ›´å¿«<br>
                                â€¢ <strong>SGD</strong>ï¼š1e-2ï¼Œéœ€è¦é…åˆåŠ¨é‡ä½¿ç”¨<br><br>
                                <strong>ğŸ¯ æ•°æ®é‡è°ƒæ•´ç­–ç•¥ï¼š</strong><br>
                                â€¢ å°æ•°æ®é›†(â‰¤20å¼ )ï¼šé™ä½è‡³1e-4 ~ 2e-4<br>
                                â€¢ ä¸­ç­‰æ•°æ®é›†(21-100å¼ )ï¼šæ ‡å‡†3e-4<br>
                                â€¢ å¤§æ•°æ®é›†(>100å¼ )ï¼šå¯æå‡è‡³5e-4<br>
                                <span id="lr_calculation_result" style="color: #28a745; font-weight: bold;"></span>
                            </div>
                            <div id="chatgpt-lr-recommendation-tip" style="display: none; color: #666; margin-top: 8px; line-height: 1.4; padding: 10px; background: #f0fffe; border-radius: 6px; border-left: 3px solid #4ECDC4;">
                                <strong>ğŸ¤– ChatGPTæ¨èç®—æ³•</strong><br><br>
                                <strong>ğŸ“Š æ ¸å¿ƒè®¡ç®—å…¬å¼ï¼š</strong><br>
                                â€¢ <strong>åŸºç¡€å­¦ä¹ ç‡</strong> = æ ¹æ®æ•°æ®é›†å¤§å°å’Œä»»åŠ¡ç±»å‹ç¡®å®š<br>
                                â€¢ <strong>è§†é¢‘æ—¶é•¿è°ƒæ•´å› å­</strong> = max(0.5, min(2.0, 10.0 / è§†é¢‘æ—¶é•¿))<br>
                                â€¢ <strong>æœ€ç»ˆå­¦ä¹ ç‡</strong> = åŸºç¡€å­¦ä¹ ç‡ Ã— è§†é¢‘æ—¶é•¿è°ƒæ•´å› å­<br><br>
                                <strong>ğŸ¯ I2Vä¸T2Vå·®å¼‚åŒ–ç­–ç•¥ï¼š</strong><br>
                                â€¢ <strong>I2Vï¼ˆå›¾ç”Ÿè§†é¢‘ï¼‰</strong>ï¼šæ›´ä¿å®ˆçš„å­¦ä¹ ç‡ï¼Œé¿å…å¯¹è¾“å…¥å›¾åƒè¿‡æ‹Ÿåˆ<br>
                                &nbsp;&nbsp;- å°æ•°æ®é›†ï¼š1e-5ï¼Œä¸­ç­‰ï¼š1.5e-5ï¼Œå¤§æ•°æ®é›†ï¼š2e-5ï¼Œè¶…å¤§ï¼š2.5e-5<br>
                                â€¢ <strong>T2Vï¼ˆæ–‡ç”Ÿè§†é¢‘ï¼‰</strong>ï¼šç›¸å¯¹æ›´é«˜çš„å­¦ä¹ ç‡ï¼Œå»ºæ¨¡æ–‡æœ¬åˆ°è§†é¢‘æ˜ å°„<br>
                                &nbsp;&nbsp;- å°æ•°æ®é›†ï¼š2e-5ï¼Œä¸­ç­‰ï¼š3e-5ï¼Œå¤§æ•°æ®é›†ï¼š4e-5ï¼Œè¶…å¤§ï¼š5e-5<br><br>
                                <strong>âš ï¸ é‡è¦æé†’ï¼š</strong><br>
                                â€¢ ä¼˜åŒ–å™¨ç±»å‹ä¼šå½±å“æœ€ç»ˆæ¨èå€¼<br>
                                â€¢ LoRA rankè¶Šé«˜ï¼Œå»ºè®®å­¦ä¹ ç‡é€‚å½“é™ä½<br>
                                â€¢ è§†é¢‘æ—¶é•¿è¿‡çŸ­æˆ–è¿‡é•¿éƒ½éœ€è¦è°ƒæ•´å­¦ä¹ ç‡<br>
                                <span id="chatgpt_lr_calculation_result" style="color: #28a745; font-weight: bold;"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ™ºèƒ½å‚æ•°æ¨èæŒ‰é’®ç»„ -->
                    <div style="margin: 15px 0;">
                        <!-- æŒ‰é’®è¡Œ -->
                        <div style="display: flex; gap: 8px; justify-content: center; align-items: center; flex-wrap: wrap;">
                            <button onclick="calculateChatGPTRecommendedParams()" class="btn" style="background: linear-gradient(45deg, #FF6B6B, #FF8E53); color: white; padding: 10px 16px; border: none; border-radius: 8px; font-size: 13px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.3s ease; font-weight: bold; flex: 1; min-width: 160px; max-width: 180px;" title="ä¸€é”®ChatGPTæ¨èæ‰€æœ‰è®­ç»ƒå‚æ•°">
                                ğŸ¤– ä¸€é”® ChatGPT æ¨è
                            </button>
                            <button onclick="calculateDoubaoRecommendedParams()" class="btn" style="background: linear-gradient(45deg, #4A90E2, #7B68EE); color: white; padding: 10px 16px; border: none; border-radius: 8px; font-size: 13px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.3s ease; font-weight: bold; flex: 1; min-width: 160px; max-width: 180px;" title="ä¸€é”®è±†åŒ…æ¨èæ‰€æœ‰è®­ç»ƒå‚æ•°">
                                ğŸ§  ä¸€é”®è±†åŒ…æ¨è
                            </button>
                            <button onclick="calculateSoftwareRecommendedParams()" class="btn" style="background: linear-gradient(45deg, #28A745, #20C997); color: white; padding: 10px 16px; border: none; border-radius: 8px; font-size: 13px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.3s ease; font-weight: bold; flex: 1; min-width: 160px; max-width: 180px;" title="ä¸€é”®è½¯ä»¶æ¨èæ‰€æœ‰è®­ç»ƒå‚æ•°">
                                âš™ï¸ ä¸€é”®è½¯ä»¶æ¨è
                            </button>
                        </div>
                        
                        <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
                        <div id="chatgpt_params_result" style="margin-top: 8px; font-size: 12px; color: #666; line-height: 1.4; padding: 8px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff; display: none;">
                            <!-- ChatGPTæ¨èç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                        </div>
                        <div id="doubao_params_result" style="margin-top: 8px; font-size: 12px; color: #666; line-height: 1.4; padding: 8px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #4A90E2; display: none;">
                            <!-- è±†åŒ…æ¨èç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                        </div>
                        <div id="software_params_result" style="margin-top: 8px; font-size: 12px; color: #666; line-height: 1.4; padding: 8px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #28A745; display: none;">
                            <!-- è½¯ä»¶æ¨èç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label title="LoRAç»´åº¦ã€‚æ§åˆ¶ä½ç§©çŸ©é˜µçš„ç»´åº¦ï¼Œå½±å“æ¨¡å‹å®¹é‡ã€‚">LoRAç»´åº¦ (network_dim)</label>
                        <input type="number" id="network_dim" min="4" max="128" title="LoRAç»´åº¦ã€‚æ§åˆ¶ä½ç§©çŸ©é˜µçš„ç»´åº¦ï¼Œå½±å“æ¨¡å‹å®¹é‡ã€‚">
                        <small style="color: #666; display: block; margin-top: 5px; line-height: 1.4;">
                            ğŸ’¡ <strong>GPTæ¨èå€¼ï¼š</strong><br>
                            â€¢ <strong>å°æ•°æ®é›†(â‰¤20å¼ )</strong>ï¼š16-32ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ<br>
                            â€¢ <strong>ä¸­ç­‰æ•°æ®é›†(21-100å¼ )</strong>ï¼š32-64ï¼Œå¹³è¡¡æ•ˆæœå’Œè®­ç»ƒç¨³å®šæ€§<br>
                            â€¢ <strong>å¤§æ•°æ®é›†(>100å¼ )</strong>ï¼š64-128ï¼Œå……åˆ†å­¦ä¹ å¤æ‚ç‰¹å¾<br>
                            â€¢ <strong>è§†é¢‘è®­ç»ƒ</strong>ï¼šé€šå¸¸éœ€è¦æ¯”å›¾ç‰‡è®­ç»ƒæ›´é«˜çš„ç»´åº¦<br>
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label title="ç½‘ç»œAlphaå€¼ã€‚æ§åˆ¶LoRAæƒé‡ç¼©æ”¾ã€‚">ç½‘ç»œAlpha (network_alpha)</label>
                        <input type="number" id="network_alpha" min="1" max="1024" value="32" title="ç½‘ç»œAlphaå€¼ã€‚æ§åˆ¶LoRAæƒé‡ç¼©æ”¾ã€‚">
                        <small style="color: #666; display: block; margin-top: 5px; line-height: 1.4;">
                            ğŸ’¡ <strong>GPTæ¨èå€¼ï¼š</strong><br>
                            â€¢ <strong>ç»å…¸é…æ¯”</strong>ï¼šAlpha = Dimï¼Œä¿æŒ1:1æ¯”ä¾‹æ˜¯æœ€ç¨³å®šçš„é€‰æ‹©<br>
                            â€¢ <strong>ä¿å®ˆé…ç½®</strong>ï¼šAlpha = Dim/2ï¼Œé™ä½å­¦ä¹ å¼ºåº¦ï¼Œé€‚åˆç²¾ç»†è°ƒæ•´<br>
                            â€¢ <strong>å¸¸ç”¨ç»„åˆ</strong>ï¼šDim=32æ—¶Alpha=16-32ï¼ŒDim=64æ—¶Alpha=32-64<br>
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label title="æœ€å¤§è®­ç»ƒè½®æ•°ã€‚æ§åˆ¶è®­ç»ƒçš„æ€»è½®æ•°ã€‚">æœ€å¤§è®­ç»ƒè½®æ•° (max_train_epochs)</label>
                        <input type="number" id="max_train_epochs" min="1" max="100" title="æœ€å¤§è®­ç»ƒè½®æ•°ã€‚æ§åˆ¶è®­ç»ƒçš„æ€»è½®æ•°ã€‚">
                        <small style="color: #666; display: block; margin-top: 5px; line-height: 1.4;">
                            ğŸ’¡ <strong>GPTæ¨èå€¼ï¼š</strong><br>
                            â€¢ <strong>å°æ•°æ®é›†(â‰¤20å¼ )</strong>ï¼š200-400è½®ï¼Œéœ€è¦æ›´å¤šè½®æ¬¡å­¦ä¹ ç‰¹å¾<br>
                            â€¢ <strong>ä¸­ç­‰æ•°æ®é›†(21-100å¼ )</strong>ï¼š100-200è½®ï¼Œå¹³è¡¡æ•ˆæœå’Œæ•ˆç‡<br>
                            â€¢ <strong>å¤§æ•°æ®é›†(>100å¼ )</strong>ï¼š50-100è½®ï¼Œé¿å…è¿‡åº¦è®­ç»ƒ<br>
                            â€¢ <strong>è§†é¢‘è®­ç»ƒ</strong>ï¼šé€šå¸¸éœ€è¦æ¯”å›¾ç‰‡è®­ç»ƒæ›´å¤šçš„è½®æ•°<br>
                            â€¢ å»ºè®®ç›‘æ§æŸå¤±æ›²çº¿ï¼Œåœ¨éªŒè¯æŸå¤±ä¸å†ä¸‹é™æ—¶æå‰åœæ­¢<br>
                        </small>
                    </div>
                    
                    <!-- é«˜çº§å‚æ•°æŠ˜å åŒºåŸŸ -->
                    <div class="collapsible-section">
                        <button type="button" class="collapsible-header" onclick="toggleSection('advanced-params')">
                            <span>âš™ï¸ é«˜çº§å‚æ•° (å¯é€‰)</span>
                            <span class="toggle-icon" id="advanced-toggle-icon">â–¼</span>
                        </button>
                        <div class="collapsible-content" id="advanced-params">
                            
                            <div class="form-group">
                                <label title="æ¯Nè½®ä¿å­˜ä¸€æ¬¡æ¨¡å‹æ£€æŸ¥ç‚¹ã€‚">æ¯Nè½®ä¿å­˜ (save_every_n_epochs)</label>
                                <input type="number" id="save_every_n_epochs" min="1" max="10" title="æ¯Nè½®ä¿å­˜ä¸€æ¬¡æ¨¡å‹æ£€æŸ¥ç‚¹ã€‚">
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èå€¼ï¼š5ï¼Œå¹³è¡¡å­˜å‚¨ç©ºé—´å’Œæ£€æŸ¥ç‚¹æ•°é‡</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="éšæœºç§å­ã€‚ç¡®ä¿è®­ç»ƒç»“æœå¯å¤ç°ã€‚">éšæœºç§å­ (seed)</label>
                                <input type="number" id="seed" min="0" title="éšæœºç§å­ã€‚ç¡®ä¿è®­ç»ƒç»“æœå¯å¤ç°ã€‚">
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èå€¼ï¼š42ï¼Œå›ºå®šç§å­ç¡®ä¿ç»“æœå¯å¤ç°</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="æ··åˆç²¾åº¦è®­ç»ƒã€‚èŠ‚çœæ˜¾å­˜ä¸”ä¿æŒè®­ç»ƒç²¾åº¦ã€‚">æ··åˆç²¾åº¦ (mixed_precision)</label>
                                <select id="mixed_precision" title="æ··åˆç²¾åº¦è®­ç»ƒã€‚èŠ‚çœæ˜¾å­˜ä¸”ä¿æŒè®­ç»ƒç²¾åº¦ã€‚">
                                    <option value="bf16" selected>bf16</option>
                                    <option value="fp16">fp16</option>
                                    <option value="no">no</option>
                                </select>
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èå€¼ï¼šbf16ï¼Œæœ€ä½³æ€§èƒ½å’Œç¨³å®šæ€§å¹³è¡¡</small>
                            </div>
                            

                            
                            <div class="form-group">
                                <label title="ä¼˜åŒ–å™¨ç±»å‹ã€‚">ä¼˜åŒ–å™¨ (optimizer_type)</label>
                                <select id="optimizer_type" title="ä¼˜åŒ–å™¨ç±»å‹ã€‚">
                                    <option value="adamw8bit" selected>adamw8bit</option>
                                    <option value="AdamW">AdamW</option>
                                    <option value="Lion">Lion</option>
                                    <option value="SGDNesterov">SGDNesterov</option>
                                    <option value="Adafactor">Adafactor</option>
                                </select>
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èå€¼ï¼šadamw8bitï¼ŒèŠ‚çœå†…å­˜</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="æ—¶é—´æ­¥é‡‡æ ·æ–¹æ³•ã€‚">æ—¶é—´æ­¥é‡‡æ · (timestep_sampling)</label>
                                <select id="timestep_sampling" title="æ—¶é—´æ­¥é‡‡æ ·æ–¹æ³•ã€‚">
                                    <option value="shift" selected>shift</option>
                                    <option value="uniform">uniform</option>
                                    <option value="sigma">sigma</option>
                                    <option value="sigmoid">sigmoid</option>
                                </select>
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èå€¼ï¼šshiftï¼Œé€‚ç”¨äºWan2.2æ¨¡å‹</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="è®­ç»ƒä»»åŠ¡ç±»å‹ã€‚æ ¹æ®é€‰æ‹©çš„ä»»åŠ¡ç±»å‹è‡ªåŠ¨è®¾ç½®ã€‚">ä»»åŠ¡ç±»å‹ (task)</label>
                                <input type="text" id="task" value="t2v-A14B" readonly title="è®­ç»ƒä»»åŠ¡ç±»å‹ã€‚æ ¹æ®é€‰æ‹©çš„ä»»åŠ¡ç±»å‹è‡ªåŠ¨è®¾ç½®ã€‚">
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ è‡ªåŠ¨è®¾ç½®ï¼šT2Vä¸ºt2v-A14Bï¼ŒI2Vä¸ºi2v-A14B</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="æŸå¤±æƒé‡æ–¹æ¡ˆã€‚å®˜æ–¹æ¨èé»˜è®¤å€¼ï¼šnoneã€‚">æƒé‡æ–¹æ¡ˆ (weighting_scheme)</label>
                                <select id="weighting_scheme" title="æŸå¤±æƒé‡æ–¹æ¡ˆã€‚å®˜æ–¹æ¨èé»˜è®¤å€¼ï¼šnoneã€‚">
                                    <option value="none" selected>none</option>
                                    <option value="logit_normal">logit_normal</option>
                                    <option value="mode">mode</option>
                                    <option value="cosmap">cosmap</option>
                                    <option value="sigma_sqrt">sigma_sqrt</option>
                                </select>
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èå€¼ï¼šnoneï¼Œå®˜æ–¹é»˜è®¤æƒé‡æ–¹æ¡ˆ</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="æ—¥å¿—ç›®å½•è·¯å¾„ã€‚å­˜å‚¨è®­ç»ƒæ—¥å¿—å’ŒTensorBoardæ•°æ®ã€‚">æ—¥å¿—ç›®å½• (logging_dir)</label>
                                <input type="text" id="logging_dir" title="æ—¥å¿—ç›®å½•è·¯å¾„ã€‚å­˜å‚¨è®­ç»ƒæ—¥å¿—å’ŒTensorBoardæ•°æ®ã€‚">
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å»ºè®®å€¼ï¼š./logsï¼Œç”¨äºå­˜å‚¨TensorBoardæ—¥å¿—</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="æ—¥å¿—è®°å½•å·¥å…· - å®˜æ–¹é»˜è®¤ï¼štensorboardã€‚">æ—¥å¿—å·¥å…· (log_with)</label>
                                <select id="log_with" title="æ—¥å¿—è®°å½•å·¥å…· - å®˜æ–¹é»˜è®¤ï¼štensorboardã€‚">
                                    <option value="tensorboard" selected>tensorboard</option>
                                    <option value="wandb">wandb</option>
                                    <option value="all">all</option>
                                </select>
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å®˜æ–¹æ¨èï¼štensorboardï¼Œå¯è§†åŒ–è®­ç»ƒè¿‡ç¨‹</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="å¯ç”¨FP8åŸºç¡€æ¨¡å‹é‡åŒ–ã€‚èŠ‚çœæ˜¾å­˜ï¼Œæå‡è®­ç»ƒæ•ˆç‡ã€‚">FP8åŸºç¡€é‡åŒ– (fp8_base)</label>
                                <input type="checkbox" id="fp8_base" checked title="å¯ç”¨FP8åŸºç¡€æ¨¡å‹é‡åŒ–ã€‚èŠ‚çœæ˜¾å­˜ï¼Œæå‡è®­ç»ƒæ•ˆç‡ã€‚">
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èï¼šå¼€å¯ï¼Œæ˜¾è‘—èŠ‚çœæ˜¾å­˜å ç”¨</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="T5ç¼–ç å™¨ä½¿ç”¨FP8ç²¾åº¦ã€‚èŠ‚çœT5ç¼–ç å™¨æ˜¾å­˜å ç”¨ã€‚">T5ç¼–ç å™¨FP8 (fp8_t5)</label>
                                <input type="checkbox" id="fp8_t5" title="T5ç¼–ç å™¨ä½¿ç”¨FP8ç²¾åº¦ã€‚èŠ‚çœT5ç¼–ç å™¨æ˜¾å­˜å ç”¨ã€‚">
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å¯é€‰ï¼šè¿›ä¸€æ­¥èŠ‚çœT5ç¼–ç å™¨æ˜¾å­˜</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="ä½¿ç”¨ç¼©æ”¾FP8ç²¾åº¦ã€‚è¿›ä¸€æ­¥èŠ‚çœæ˜¾å­˜ï¼Œéœ€è¦æ”¯æŒçš„ç¡¬ä»¶ã€‚">ç¼©æ”¾FP8ç²¾åº¦ (fp8_scaled)</label>
                                <input type="checkbox" id="fp8_scaled" title="ä½¿ç”¨ç¼©æ”¾FP8ç²¾åº¦ã€‚è¿›ä¸€æ­¥èŠ‚çœæ˜¾å­˜ï¼Œéœ€è¦æ”¯æŒçš„ç¡¬ä»¶ã€‚">
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ é«˜çº§ï¼šéœ€è¦æ”¯æŒFP8çš„ç¡¬ä»¶</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="æ—¶é—´æ­¥è¾¹ç•Œã€‚T2Vé»˜è®¤875ï¼ŒI2Vé»˜è®¤900ï¼Œç”¨äºåˆ‡æ¢é«˜ä½å™ªå£°æ¨¡å‹ã€‚">æ—¶é—´æ­¥è¾¹ç•Œ (timestep_boundary)</label>
                                <input type="number" id="timestep_boundary" min="0" max="1000" value="875" title="æ—¶é—´æ­¥è¾¹ç•Œã€‚T2Vé»˜è®¤875ï¼ŒI2Vé»˜è®¤900ï¼Œç”¨äºåˆ‡æ¢é«˜ä½å™ªå£°æ¨¡å‹ã€‚">
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ T2Vé»˜è®¤875ï¼ŒI2Vé»˜è®¤900</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="é«˜å™ªå£°DiTæ¨¡å‹è·¯å¾„ã€‚ç”¨äºé«˜å™ªå£°æ—¶é—´æ­¥çš„DiTæ¨¡å‹ï¼Œä¸dité…åˆä½¿ç”¨ã€‚">é«˜å™ªå£°DiTæ¨¡å‹ (dit_high_noise)</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="dit_high_noise" title="é«˜å™ªå£°DiTæ¨¡å‹è·¯å¾„ã€‚ç”¨äºé«˜å™ªå£°æ—¶é—´æ­¥çš„DiTæ¨¡å‹ï¼Œä¸dité…åˆä½¿ç”¨ã€‚" style="flex: 1;">
                                    <button type="button" onclick="selectFileWithDialog('dit_high_noise')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                                </div>
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å¯é€‰ï¼šç”¨äºé«˜å™ªå£°æ—¶é—´æ­¥çš„DiTæ¨¡å‹</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹ã€‚èŠ‚çœæ˜¾å­˜ã€‚">æ¢¯åº¦æ£€æŸ¥ç‚¹ (gradient_checkpointing)</label>
                                <input type="checkbox" id="gradient_checkpointing" checked title="å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹ã€‚èŠ‚çœæ˜¾å­˜ã€‚">
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èï¼šå¼€å¯ï¼ŒèŠ‚çœæ˜¾å­˜</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="ç¦»æ•£æµåç§»ã€‚T2Væ¨è12.0ï¼ŒI2Væ¨è5.0ã€‚">ç¦»æ•£æµåç§» (discrete_flow_shift)</label>
                                <input type="number" id="discrete_flow_shift" step="0.1" min="0" value="12.0" title="ç¦»æ•£æµåç§»ã€‚T2Væ¨è12.0ï¼ŒI2Væ¨è5.0ã€‚">
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ T2V: 12.0, I2V: 5.0</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="æœ€å°æ—¶é—´æ­¥ã€‚é»˜è®¤0ã€‚">æœ€å°æ—¶é—´æ­¥ (min_timestep)</label>
                                <input type="number" id="min_timestep" min="0" max="1000" value="0" title="æœ€å°æ—¶é—´æ­¥ã€‚é»˜è®¤0ã€‚">
                            </div>
                            
                            <div class="form-group">
                                <label title="æœ€å¤§æ—¶é—´æ­¥ã€‚é»˜è®¤1000ã€‚">æœ€å¤§æ—¶é—´æ­¥ (max_timestep)</label>
                                <input type="number" id="max_timestep" min="0" max="1000" value="1000" title="æœ€å¤§æ—¶é—´æ­¥ã€‚é»˜è®¤1000ã€‚">
                            </div>
                            
                            <div class="form-group">
                                <label title="ç½‘ç»œæ¨¡å—ã€‚é»˜è®¤networks.lora_wanã€‚">ç½‘ç»œæ¨¡å— (network_module)</label>
                                <input type="text" id="network_module" value="networks.lora_wan" title="ç½‘ç»œæ¨¡å—ã€‚é»˜è®¤networks.lora_wanã€‚">
                            </div>
                            

                            
                            <div class="form-group">
                                <label title="æ•°æ®åŠ è½½å™¨å·¥ä½œè¿›ç¨‹æ•°ã€‚é»˜è®¤2ã€‚">æ•°æ®åŠ è½½å™¨å·¥ä½œè¿›ç¨‹æ•° (max_data_loader_n_workers)</label>
                                <input type="number" id="max_data_loader_n_workers" min="0" value="2" title="æ•°æ®åŠ è½½å™¨å·¥ä½œè¿›ç¨‹æ•°ã€‚é»˜è®¤2ã€‚">
                            </div>
                            
                            <div class="form-group">
                                <label title="æŒä¹…åŒ–æ•°æ®åŠ è½½å™¨ã€‚é»˜è®¤å…³é—­ã€‚">æŒä¹…åŒ–æ•°æ®åŠ è½½å™¨ (persistent_data_loader_workers)</label>
                                <input type="checkbox" id="persistent_data_loader_workers" title="æŒä¹…åŒ–æ•°æ®åŠ è½½å™¨ã€‚é»˜è®¤å…³é—­ã€‚">
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å¯é€‰ï¼šå¼€å¯å¯èƒ½æå‡æ•°æ®åŠ è½½æ•ˆç‡</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="å¯ç”¨SDPAæ³¨æ„åŠ›æœºåˆ¶ã€‚æ¨èå¼€å¯ã€‚">SDPA (sdpa)</label>
                                <input type="checkbox" id="sdpa" checked title="å¯ç”¨SDPAæ³¨æ„åŠ›æœºåˆ¶ã€‚æ¨èå¼€å¯ã€‚">
                            </div>
                            
                            <div class="form-group">
                                <label title="VAEç¼“å­˜åˆ°CPUã€‚èŠ‚çœæ˜¾å­˜ä½†å½±å“é€Ÿåº¦ã€‚">VAEç¼“å­˜åˆ°CPU (vae_cache_cpu)</label>
                                <input type="checkbox" id="vae_cache_cpu" title="VAEç¼“å­˜åˆ°CPUã€‚èŠ‚çœæ˜¾å­˜ä½†å½±å“é€Ÿåº¦ã€‚">
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æç¤ºï¼šå¼€å¯å¯èŠ‚çœæ˜¾å­˜ä½†ä¼šå½±å“é€Ÿåº¦</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="å†…å­˜ä¼˜åŒ–ç­–ç•¥ã€‚ä¸¤ä¸ªé€‰é¡¹äº’æ–¥ï¼Œåªèƒ½é€‰æ‹©å…¶ä¸­ä¸€ä¸ªã€‚">å†…å­˜ä¼˜åŒ–ç­–ç•¥</label>
                                <select id="memory_optimization_strategy" title="é€‰æ‹©å†…å­˜ä¼˜åŒ–ç­–ç•¥ã€‚offload_inactive_ditå¸è½½éæ´»è·ƒDiTåˆ°CPUï¼Œblocks_to_swapäº¤æ¢æŒ‡å®šæ•°é‡çš„å—åˆ°CPUã€‚">
                                    <option value="offload_inactive_dit" selected>å¸è½½éæ´»è·ƒDiT (offload_inactive_dit)</option>
                                    <option value="blocks_to_swap">å—äº¤æ¢ (blocks_to_swap)</option>
                                </select>
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ é»˜è®¤æ¨èï¼šoffload_inactive_ditï¼Œé€‚åˆå¤§å¤šæ•°é…ç½®</small>
                            </div>
                            
                            <div class="form-group" id="blocks_to_swap_config" style="display: none;">
                                <label title="äº¤æ¢åˆ°CPUçš„å—æ•°é‡ã€‚åœ¨VRAMå’Œå†…å­˜é—´äº¤æ¢æ¨¡å‹å—ä»¥èŠ‚çœæ˜¾å­˜ã€‚">å—äº¤æ¢æ•°é‡</label>
                                <input type="number" id="blocks_to_swap" min="0" max="40" value="20" title="äº¤æ¢åˆ°CPUçš„å—æ•°é‡ã€‚åœ¨VRAMå’Œå†…å­˜é—´äº¤æ¢æ¨¡å‹å—ä»¥èŠ‚çœæ˜¾å­˜ã€‚">
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èå€¼ï¼š20ï¼Œé€‚åˆ4090+98Gå†…å­˜é…ç½®</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="æ¯ä¸ªè¿›ç¨‹çš„CPUçº¿ç¨‹æ•°ã€‚é»˜è®¤1ã€‚">CPUçº¿ç¨‹æ•° (num_cpu_threads_per_process)</label>
                                <input type="number" id="num_cpu_threads_per_process" min="1" value="1" title="æ¯ä¸ªè¿›ç¨‹çš„CPUçº¿ç¨‹æ•°ã€‚é»˜è®¤1ã€‚">
                            </div>
                            
                            <!-- æ–­ç‚¹ç»­è®­é€‰é¡¹ -->
                            <div class="form-group">
                                <label title="å¼€å¯åå ç”¨å¤§é‡ç£ç›˜ç©ºé—´ï¼Œå¯å®ç°çœŸæ­£çš„æ–­ç‚¹ç»­è®­ï¼Œä¿å­˜å®Œæ•´è®­ç»ƒçŠ¶æ€ã€‚">
                                    <input type="checkbox" id="save_state" title="å¼€å¯åå ç”¨å¤§é‡ç£ç›˜ç©ºé—´ï¼Œå¯å®ç°çœŸæ­£çš„æ–­ç‚¹ç»­è®­ï¼Œä¿å­˜å®Œæ•´è®­ç»ƒçŠ¶æ€ã€‚" style="margin-right: 8px;">
                                    ä¿å­˜è®­ç»ƒçŠ¶æ€ (save_state)
                                </label>
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å¼€å¯åå ç”¨å¤§é‡ç£ç›˜ç©ºé—´ï¼Œå¯å®ç°çœŸæ­£çš„æ–­ç‚¹ç»­è®­ï¼Œä¿å­˜å®Œæ•´è®­ç»ƒçŠ¶æ€</small>
                            </div>
                            
                            <div class="form-group">
                                <label title="ä»ä¸Šæ¬¡è®­ç»ƒçŠ¶æ€æ¢å¤ï¼Œéœ€ä¿®æ”¹è½®æ•°ï¼ˆå¦‚ä¹‹å‰è®­ç»ƒ10è½®ï¼Œ5è½®ä¸­æ–­ï¼Œéœ€æ”¹ä¸º5è½®ä»¥å®Œæˆå‰©ä½™è®­ç»ƒï¼Œä¸å¯å†ç”¨10è½®ï¼‰ã€‚">
                                    <input type="checkbox" id="resume_training" onchange="toggleResumeOptions()" title="ä»ä¸Šæ¬¡è®­ç»ƒçŠ¶æ€æ¢å¤ï¼Œéœ€ä¿®æ”¹è½®æ•°ï¼ˆå¦‚ä¹‹å‰è®­ç»ƒ10è½®ï¼Œ5è½®ä¸­æ–­ï¼Œéœ€æ”¹ä¸º5è½®ä»¥å®Œæˆå‰©ä½™è®­ç»ƒï¼Œä¸å¯å†ç”¨10è½®ï¼‰ã€‚" style="margin-right: 8px;">
                                    æ¢å¤è®­ç»ƒçŠ¶æ€ (resume)
                                </label>
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ ä»ä¸Šæ¬¡è®­ç»ƒçŠ¶æ€æ¢å¤ï¼Œéœ€ä¿®æ”¹è½®æ•°ï¼ˆå¦‚ä¹‹å‰è®­ç»ƒ10è½®ï¼Œ5è½®ä¸­æ–­ï¼Œéœ€æ”¹ä¸º5è½®ä»¥å®Œæˆå‰©ä½™è®­ç»ƒï¼Œä¸å¯å†ç”¨10è½®ï¼‰ä¹Ÿå¯ä»¥ç†è§£ä¸ºåœ¨è¿™ä¸ªåŸºç¡€ä¸Šå†è®­ç»ƒå¤šå°‘è½®ï¼</small>
                            </div>
                            
                            <div class="form-group" id="resume_path_group" style="display: none;">
                                <label title="æŒ‡å®šä¹‹å‰ä¿å­˜çš„çŠ¶æ€ç›®å½•ï¼Œå®ç°çœŸæ­£çš„æ–­ç‚¹ç»­è®­ã€‚">æ¢å¤è®­ç»ƒçŠ¶æ€è·¯å¾„</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="resume" title="æŒ‡å®šä¹‹å‰ä¿å­˜çš„çŠ¶æ€ç›®å½•ï¼Œå®ç°çœŸæ­£çš„æ–­ç‚¹ç»­è®­ã€‚" style="flex: 1;">
                                    <button type="button" onclick="selectFolder('resume')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                                </div>
                                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ é€‰æ‹©ä¹‹å‰ä¿å­˜çš„çŠ¶æ€ç›®å½•ï¼Œå¦‚ ./output/wan22-lora-000006-state</small>
                            </div>

                            
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- é…ç½®æ“ä½œé¢æ¿ -->
            <div class="panel">
                <h2>ğŸ’¾ é…ç½®ç®¡ç†</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="saveConfig()" class="btn">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <button onclick="loadConfig()" class="btn">ğŸ“‚ åŠ è½½é…ç½®</button>
                    <button onclick="resetConfig()" class="btn">ğŸ”„ é‡ç½®é…ç½®</button>
                </div>
            </div>
            
            <!-- é¢„ä¼°è®­ç»ƒæ—¶é—´é¢æ¿ -->
            <div class="panel">
                <h2>â±ï¸ é¢„ä¼°è®­ç»ƒæ—¶é—´</h2>
                
                <!-- è¾“å…¥å‚æ•°åŒºåŸŸ -->
                <div class="form-group">
                    <label for="avg_step_time">å¹³å‡æ¯æ­¥è€—æ—¶ (ç§’):</label>
                    <input type="number" id="avg_step_time" step="0.01" value="2.92" placeholder="ä¾‹å¦‚: 2.92">
                    <small style="color: #666; font-size: 12px;">ğŸ’¡ å»ºè®®æ ¹æ®å®é™…è®­ç»ƒç»éªŒè°ƒæ•´æ­¤å€¼</small>
                </div>
                
                <div style="text-align: center; margin: 15px 0;">
                    <button onclick="estimateTrainingTime()" class="btn" style="background: linear-gradient(45deg, #4CAF50, #45a049); color: white; padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'">
                        ğŸ“Š å¼€å§‹ä¼°ç®—è®­ç»ƒæ—¶é—´
                    </button>
                </div>
                
                <!-- è®¡ç®—ç»“æœå±•ç¤ºåŒºåŸŸ -->
                <div id="estimation_results" style="display: none; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 12px; padding: 20px; margin-top: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    
                    <!-- æœ€ç»ˆç»“æœ -->
                    <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.8); border-radius: 8px; border-left: 4px solid #4CAF50;">
                        <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 18px;">ğŸ¯ é¢„ä¼°è®­ç»ƒæ—¶é—´</h3>
                        <div id="final_time_result" style="font-size: 24px; font-weight: bold; color: #27ae60; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">--</div>
                    </div>
                    
                    <!-- è®¡ç®—æ­¥éª¤è¯¦æƒ… -->
                    <div style="background: rgba(255,255,255,0.9); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px;">ğŸ“‹ è®¡ç®—æ­¥éª¤è¯¦æƒ…</h4>
                        
                        <!-- æ•°æ®é›†ä¿¡æ¯ -->
                        <div style="margin-bottom: 12px; padding: 10px; background: #ecf0f1; border-radius: 6px; border-left: 3px solid #3498db;">
                            <div style="font-weight: bold; color: #2c3e50; margin-bottom: 5px;">ğŸ“ æ•°æ®é›†æ–‡ä»¶æ•°é‡</div>
                            <div id="dataset_files_display" style="font-size: 16px; color: #27ae60;">-- ä¸ªæ–‡ä»¶</div>
                            <small style="color: #7f8c8d;">æ¥æº: dataset_config é…ç½®æ–‡ä»¶ä¸­çš„ image_directory è·¯å¾„</small>
                        </div>
                        
                        <!-- è®­ç»ƒå‚æ•° -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                            <div style="padding: 10px; background: #ecf0f1; border-radius: 6px; border-left: 3px solid #e74c3c;">
                                <div style="font-weight: bold; color: #2c3e50; margin-bottom: 5px;">ğŸ”¢ æ‰¹æ¬¡å¤§å°</div>
                                <div id="batch_size_display" style="font-size: 16px; color: #e74c3c;">--</div>
                                <small style="color: #7f8c8d;">æ¥æº: batch_size å‚æ•°</small>
                            </div>
                            <div style="padding: 10px; background: #ecf0f1; border-radius: 6px; border-left: 3px solid #f39c12;">
                                <div style="font-weight: bold; color: #2c3e50; margin-bottom: 5px;">ğŸ”„ é‡å¤æ¬¡æ•°</div>
                                <div id="num_repeats_display" style="font-size: 16px; color: #f39c12;">--</div>
                                <small style="color: #7f8c8d;">æ¥æº: num_repeats å‚æ•°</small>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="padding: 10px; background: #ecf0f1; border-radius: 6px; border-left: 3px solid #9b59b6;">
                                <div style="font-weight: bold; color: #2c3e50; margin-bottom: 5px;">ğŸ¯ è®­ç»ƒè½®æ¬¡</div>
                                <div id="max_epochs_display" style="font-size: 16px; color: #9b59b6;">--</div>
                                <small style="color: #7f8c8d;">æ¥æº: max_train_epochs å‚æ•°</small>
                            </div>
                            <div style="padding: 10px; background: #ecf0f1; border-radius: 6px; border-left: 3px solid #1abc9c;">
                                <div style="font-weight: bold; color: #2c3e50; margin-bottom: 5px;">â±ï¸ æ¯æ­¥è€—æ—¶</div>
                                <div id="step_time_display" style="font-size: 16px; color: #1abc9c;">-- ç§’</div>
                                <small style="color: #7f8c8d;">æ¥æº: ç”¨æˆ·è¾“å…¥çš„å¹³å‡æ¯æ­¥è€—æ—¶</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è®¡ç®—å…¬å¼å±•ç¤º -->
                    <div style="background: rgba(255,255,255,0.9); border-radius: 8px; padding: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: #34495e; border-bottom: 2px solid #e67e22; padding-bottom: 5px;">ğŸ§® è®¡ç®—å…¬å¼</h4>
                        
                        <div style="margin-bottom: 15px; padding: 12px; background: #fdf2e9; border-radius: 6px; border: 1px solid #f39c12;">
                            <div style="font-weight: bold; color: #d35400; margin-bottom: 8px;">ç¬¬ä¸€æ­¥ï¼šè®¡ç®—æ€»æ­¥æ•°</div>
                            <div style="font-family: 'Courier New', monospace; background: #fff; padding: 8px; border-radius: 4px; border-left: 3px solid #f39c12; color: #2c3e50; font-weight: bold;">
                                æ€»æ­¥æ•° = (æ•°æ®é›†æ–‡ä»¶æ•° Ã— é‡å¤æ¬¡æ•° Ã· æ‰¹æ¬¡å¤§å°) Ã— è®­ç»ƒè½®æ¬¡
                            </div>
                            <div id="total_steps_calculation" style="margin-top: 8px; color: #d35400; font-weight: bold;">æ€»æ­¥æ•° = (-- Ã— -- Ã· --) Ã— -- = -- æ­¥</div>
                        </div>
                        
                        <div style="padding: 12px; background: #eaf2f8; border-radius: 6px; border: 1px solid #3498db;">
                            <div style="font-weight: bold; color: #2980b9; margin-bottom: 8px;">ç¬¬äºŒæ­¥ï¼šè®¡ç®—é¢„ä¼°æ—¶é—´</div>
                            <div style="font-family: 'Courier New', monospace; background: #fff; padding: 8px; border-radius: 4px; border-left: 3px solid #3498db; color: #2c3e50; font-weight: bold;">
                                é¢„ä¼°æ—¶é—´ = æ€»æ­¥æ•° Ã— æ¯æ­¥è€—æ—¶
                            </div>
                            <div id="time_calculation" style="margin-top: 8px; color: #2980b9; font-weight: bold;">é¢„ä¼°æ—¶é—´ = -- Ã— -- = -- ç§’</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let isRunning = false;
        let currentTaskType = 't2v'; // é»˜è®¤æ–‡ç”Ÿè§†é¢‘
        let lastLogCount = 0;
        let currentRunningTask = null; // å½“å‰è¿è¡Œçš„ä»»åŠ¡ç±»å‹ï¼š'training', 'caching', null
        
        function selectTaskType(taskType) {
            currentTaskType = taskType;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const t2vBtn = document.getElementById('t2v-btn');
            const i2vBtn = document.getElementById('i2v-btn');
            const currentBtn = document.getElementById(taskType + '-btn');
            
            if (t2vBtn) t2vBtn.classList.remove('active');
            if (i2vBtn) i2vBtn.classList.remove('active');
            if (currentBtn) currentBtn.classList.add('active');
            
            // æ ¹æ®ä»»åŠ¡ç±»å‹è‡ªåŠ¨å¡«å……å‚æ•°å¹¶è®¾ç½®ä¸ºåªè¯»
            const taskInput = document.getElementById('task');
            const discreteFlowShiftInput = document.getElementById('discrete_flow_shift');
            const timestepBoundaryInput = document.getElementById('timestep_boundary');
            
            if (taskType === 'i2v') {
                // I2Vå‚æ•°è®¾ç½®
                if (taskInput) {
                    taskInput.value = 'i2v-A14B';
                    taskInput.readOnly = true;
                }
                if (discreteFlowShiftInput) {
                    discreteFlowShiftInput.value = '5.0';
                    discreteFlowShiftInput.readOnly = true;
                }
                if (timestepBoundaryInput) {
                    timestepBoundaryInput.value = '900';
                    timestepBoundaryInput.readOnly = true;
                }
                
                addLogEntry({
                    level: 'info',
                    message: 'å·²åˆ‡æ¢åˆ°å›¾ç”Ÿè§†é¢‘(I2V)æ¨¡å¼ï¼Œå‚æ•°å·²è‡ªåŠ¨è®¾ç½®ï¼štask=i2v-A14B, discrete_flow_shift=5.0, timestep_boundary=900',
                    timestamp: new Date().toLocaleTimeString()
                });
            } else {
                // T2Vå‚æ•°è®¾ç½®
                if (taskInput) {
                    taskInput.value = 't2v-A14B';
                    taskInput.readOnly = true;
                }
                if (discreteFlowShiftInput) {
                    discreteFlowShiftInput.value = '12.0';
                    discreteFlowShiftInput.readOnly = true;
                }
                if (timestepBoundaryInput) {
                    timestepBoundaryInput.value = '875';
                    timestepBoundaryInput.readOnly = true;
                }
                
                addLogEntry({
                    level: 'info',
                    message: 'å·²åˆ‡æ¢åˆ°æ–‡ç”Ÿè§†é¢‘(T2V)æ¨¡å¼ï¼Œå‚æ•°å·²è‡ªåŠ¨è®¾ç½®ï¼štask=t2v-A14B, discrete_flow_shift=12.0, timestep_boundary=875',
                    timestamp: new Date().toLocaleTimeString()
                });
            }
        }
        
        function setButtonsEnabled(enabled) {
            const buttons = ['cache-vae-btn', 'cache-te-btn', 'train-btn'];
            buttons.forEach(id => {
                document.getElementById(id).disabled = !enabled;
            });
            // åœæ­¢è®­ç»ƒæŒ‰é’®åªåœ¨è®­ç»ƒæ—¶å¯ç”¨
            document.getElementById('stop-btn').disabled = enabled || currentRunningTask !== 'training';
            isRunning = !enabled;
        }
        
        // æ–°å¢ï¼šè®¾ç½®è®­ç»ƒæŒ‰é’®çŠ¶æ€
        function setTrainingButtonsEnabled(enabled) {
            const buttons = ['cache-vae-btn', 'cache-te-btn', 'train-btn'];
            buttons.forEach(id => {
                document.getElementById(id).disabled = !enabled;
            });
            // åœæ­¢è®­ç»ƒæŒ‰é’®åªåœ¨è®­ç»ƒæ—¶å¯ç”¨
            document.getElementById('stop-btn').disabled = enabled;
            isRunning = !enabled;
            currentRunningTask = enabled ? null : 'training';
        }
        
        // æ–°å¢ï¼šè®¾ç½®ç¼“å­˜æŒ‰é’®çŠ¶æ€
        function setCacheButtonsEnabled(enabled) {
            const buttons = ['cache-vae-btn', 'cache-te-btn', 'train-btn'];
            buttons.forEach(id => {
                document.getElementById(id).disabled = !enabled;
            });
            // ç¼“å­˜ä»»åŠ¡æ—¶åœæ­¢è®­ç»ƒæŒ‰é’®ä¿æŒç¦ç”¨
            document.getElementById('stop-btn').disabled = true;
            isRunning = !enabled;
            currentRunningTask = enabled ? null : 'caching';
        }
        
        function updateStatus(status, message) {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            
            indicator.className = `status-indicator status-${status}`;
            text.textContent = message;
        }
        
        function updateProgress(percent) {
            document.getElementById('progress-fill').style.width = percent + '%';
        }
        
        // ä½¿ç”¨ç°ä»£æ–‡ä»¶é€‰æ‹©APIçš„å‡½æ•°
        async function selectFileModern(inputId, fileExtension) {
            if (window.showOpenFilePicker) {
                try {
                    const [fileHandle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'Files',
                            accept: { '*/*': [fileExtension] }
                        }]
                    });
                    const file = await fileHandle.getFile();
                    
                    // ç°ä»£æµè§ˆå™¨APIæ— æ³•è·å–å®Œæ•´è·¯å¾„ï¼Œåªèƒ½è·å–æ–‡ä»¶å
                    // ä¸ºconvert_input_fileæä¾›æ™ºèƒ½è·¯å¾„å»ºè®®
                    if (inputId === 'convert_input_file') {
                        const fileName = file.name;
                        const currentDir = 'C:\\Users\\oskey\\ai\\musubi-tuner';
                        // æä¾›å¸¸è§çš„LoRAæ–‡ä»¶ä½ç½®å»ºè®®
                        const suggestedPath = currentDir + '\\output\\' + fileName;
                        document.getElementById(inputId).value = suggestedPath;
                        
                        // æ›´æ–°æç¤ºä¿¡æ¯ï¼Œä¸ä½¿ç”¨èƒŒæ™¯è‰²
                        const inputElement = document.getElementById(inputId);
                        inputElement.title = 'å·²è‡ªåŠ¨å¡«å…¥å»ºè®®è·¯å¾„: ' + suggestedPath + ' (è¯·æ ¹æ®å®é™…æ–‡ä»¶ä½ç½®ä¿®æ”¹)';
                    } else {
                        document.getElementById(inputId).value = file.name;
                    }
                    return;
                } catch (err) {
                    // ç”¨æˆ·å–æ¶ˆé€‰æ‹©æˆ–APIä¸æ”¯æŒï¼Œå›é€€åˆ°ä¼ ç»Ÿæ–¹å¼
                }
            }
            // å›é€€åˆ°ä¼ ç»Ÿæ–‡ä»¶é€‰æ‹©
            selectFileTraditional(inputId, fileExtension);
        }
        
        function selectFileTraditional(inputId, fileExtension) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = fileExtension;
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    let fullPath;
                    
                    const fileName = file.name;
                    
                    if (file.path) {
                        // å¦‚æœæµè§ˆå™¨æ”¯æŒfile.pathï¼Œç›´æ¥ä½¿ç”¨å®Œæ•´è·¯å¾„
                        fullPath = file.path;
                    } else {
                        // æµè§ˆå™¨ä¸æ”¯æŒfile.pathæ—¶ï¼Œæ ¹æ®æ–‡ä»¶ç±»å‹æ„å»ºé»˜è®¤è·¯å¾„
                        const currentDir = 'C:\\Users\\oskey\\ai\\musubi-tuner';
                        
                        if (fileExtension === '.toml') {
                            fullPath = currentDir + '\\ai_data\\datasets\\' + fileName;
                        } else if (fileExtension === '.safetensors') {
                            if (inputId === 'dit' || inputId === 'dit_high_noise') {
                                fullPath = currentDir + '\\model\\diffusion_models\\' + fileName;
                            } else if (inputId === 't5') {
                                fullPath = currentDir + '\\model\\text_encoders\\' + fileName;
                            } else if (inputId === 'vae') {
                                fullPath = currentDir + '\\model\\vae\\' + fileName;
                            } else if (inputId === 'convert_input_file') {
                                // LoRAè½¬æ¢è¾“å…¥æ–‡ä»¶ï¼Œä¿æŒæ–‡ä»¶åï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘è·¯å¾„
                                fullPath = fileName;
                            } else {
                                // å…¶ä»–æƒ…å†µï¼Œä½¿ç”¨å½“å‰ç›®å½•
                                fullPath = currentDir + '\\' + fileName;
                            }
                        } else {
                            // é.safetensorså’Œ.tomlæ–‡ä»¶ï¼Œä½¿ç”¨å½“å‰ç›®å½•
                            fullPath = currentDir + '\\' + fileName;
                        }
                    }
                    
                    document.getElementById(inputId).value = fullPath;
                    
                    // å¦‚æœæ˜¯æ•°æ®é›†é…ç½®æ–‡ä»¶ï¼Œè‡ªåŠ¨è¯»å–batch_sizeå’Œnum_repeats
                    if (inputId === 'dataset_config' && fileExtension === '.toml') {
                        readBatchSizeFromToml(fullPath);
                        readNumRepeatsFromToml(fullPath);
                        
                        // è‡ªåŠ¨æå–æ–‡ä»¶åå¹¶è®¾ç½®åˆ°output_name
                        const fileNameWithoutExt = fileName.replace(/\.toml$/i, '');
                        const outputNameElement = document.getElementById('output_name');
                        if (outputNameElement) {
                            outputNameElement.value = fileNameWithoutExt;
                        }
                    }
                }
            };
            input.click();
        }
        
        function readBatchSizeFromToml(tomlPath) {
            fetch('/api/read_batch_size_from_toml', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ toml_path: tomlPath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.batch_size !== null) {
                    document.getElementById('batch_size').value = data.batch_size;
                    addLogEntry({
                        level: 'info',
                        message: `å·²ä» ${tomlPath} è¯»å– batch_size: ${data.batch_size}`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'warning',
                        message: data.message || 'æ— æ³•ä»TOMLæ–‡ä»¶è¯»å–batch_size',
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'è¯»å–TOMLæ–‡ä»¶å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function readNumRepeatsFromToml(tomlPath) {
            fetch('/api/read_num_repeats_from_toml', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ toml_path: tomlPath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.num_repeats !== null) {
                    document.getElementById('num_repeats').value = data.num_repeats;
                    addLogEntry({
                        level: 'info',
                        message: `å·²ä» ${tomlPath} è¯»å– num_repeats: ${data.num_repeats}`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'warning',
                        message: data.message || 'æ— æ³•ä»TOMLæ–‡ä»¶è¯»å–num_repeats',
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'è¯»å–TOMLæ–‡ä»¶å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function loadDefaultConfig() {
            // å‰ç«¯é»˜è®¤é…ç½®ï¼Œä¸getConfigå‡½æ•°ä¿æŒä¸€è‡´
            const defaultConfig = {
                // ç¯å¢ƒé…ç½®
                enable_venv: true,
                venv_python_path: './venv/Scripts/',
                
                // æ ¸å¿ƒæ¨¡å‹è·¯å¾„
                dit: './model/diffusion_models/wan2.2_t2v_low_noise_14B_fp16.safetensors',
                dit_high_noise: './model/diffusion_models/wan2.2_t2v_high_noise_14B_fp16.safetensors',
                vae: './model/vae/wan_2.1_vae.safetensors',
                t5: './model/text_encoders/models_t5_umt5-xxl-enc-bf16.pth',
                dataset_config: './ai_data/datasets/lovemf_config_t2v.toml',
                
                // ä»»åŠ¡é…ç½®
                task: 't2v-A14B',
                
                // è®­ç»ƒæ ¸å¿ƒå‚æ•°
                mixed_precision: 'fp16',
                timestep_sampling: 'shift',
                discrete_flow_shift: 3.0,
                timestep_boundary: 0.875,
                min_timestep: 0,
                max_timestep: 1000,
                
                // ä¼˜åŒ–å™¨é…ç½®
                optimizer_type: 'AdamW8bit',
                learning_rate: '2e-4',
                
                // ç½‘ç»œé…ç½®
                network_module: 'networks.lora_wan',
                network_dim: 32,
                network_alpha: 32,
                
                // è®­ç»ƒæ§åˆ¶
                max_train_epochs: 16,
                save_every_n_epochs: 1,
                save_state: false,
                resume_training: false,
                resume: '',
                seed: 42,
                batch_size: 1,
                num_repeats: 1,
                
                // æ•°æ®åŠ è½½
                max_data_loader_n_workers: 2,
                persistent_data_loader_workers: true,
                
                // ä¼˜åŒ–é€‰é¡¹
                sdpa: true,
                gradient_checkpointing: true,
                fp8_base: false,
                fp8_t5: false,
                fp8_scaled: false,
                vae_cache_cpu: false,
                offload_inactive_dit: false,
                blocks_to_swap: 20,
                
                // è¾“å‡ºé…ç½®
                output_dir: './output',
                output_name: 'wan22-lora',
                logging_dir: './logs',
                log_with: 'tensorboard',
                
                // ç³»ç»Ÿé…ç½®
                num_cpu_threads_per_process: 1,

            };
            
            // è®¾ç½®ä»»åŠ¡ç±»å‹
            if (defaultConfig.task) {
                const taskType = defaultConfig.task.includes('i2v') ? 'i2v' : 't2v';
                selectTaskType(taskType);
            }
            
            // å¡«å……è¡¨å•
            Object.keys(defaultConfig).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = defaultConfig[key];
                    } else {
                        element.value = defaultConfig[key];
                    }
                }
            })
            .catch(error => {
                console.error('æ¨èæ•°æ®é‡å¤æ¬¡æ•°è¯·æ±‚å¤±è´¥:', error);
                addLogEntry({
                    level: 'error',
                    message: 'âŒ æ¨èæ•°æ®é‡å¤æ¬¡æ•°è¯·æ±‚å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
            
            addLogEntry({
                level: 'info',
                message: 'å·²åŠ è½½å‰ç«¯é»˜è®¤é…ç½®',
                timestamp: new Date().toLocaleTimeString()
            });
        }
        
        // ä½¿ç”¨åç«¯APIè°ƒç”¨ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†ï¼ˆé€šç”¨ç‰ˆæœ¬ï¼‰
        function selectFileWithDialog(inputId, fileType = 'all', title = 'é€‰æ‹©æ–‡ä»¶', initialDir = 'C:\\Users\\oskey\\ai\\musubi-tuner') {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'é€‰æ‹©ä¸­...';
            button.disabled = true;
            
            // æ ¹æ®è¾“å…¥æ¡†IDè®¾ç½®é»˜è®¤å‚æ•°
            let defaultFileType = fileType;
            let defaultTitle = title;
            let defaultInitialDir = initialDir;
            
            if (inputId === 'convert_input_file') {
                defaultFileType = 'safetensors';
                defaultTitle = 'é€‰æ‹©LoRAæ–‡ä»¶';
                defaultInitialDir = 'C:\\Users\\oskey\\ai\\musubi-tuner\\output';
            } else if (inputId === 'dataset_config') {
                defaultFileType = 'toml';
                defaultTitle = 'é€‰æ‹©æ•°æ®é›†é…ç½®æ–‡ä»¶';
                defaultInitialDir = 'C:\\Users\\oskey\\ai\\musubi-tuner\\ai_data\\datasets';
            } else if (inputId === 'dit' || inputId === 'dit_high_noise') {
                defaultFileType = 'safetensors';
                defaultTitle = 'é€‰æ‹©DiTæ¨¡å‹æ–‡ä»¶';
                defaultInitialDir = 'C:\\Users\\oskey\\ai\\musubi-tuner\\model\\diffusion_models';
            } else if (inputId === 't5') {
                defaultFileType = 'safetensors';
                defaultTitle = 'é€‰æ‹©T5æ–‡æœ¬ç¼–ç å™¨æ–‡ä»¶';
                defaultInitialDir = 'C:\\Users\\oskey\\ai\\musubi-tuner\\model\\text_encoders';
            } else if (inputId === 'vae') {
                defaultFileType = 'safetensors';
                defaultTitle = 'é€‰æ‹©VAEæ¨¡å‹æ–‡ä»¶';
                defaultInitialDir = 'C:\\Users\\oskey\\ai\\musubi-tuner\\model\\vae';
            }
            
            // è°ƒç”¨åç«¯API
            fetch('/api/select_file', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_type: defaultFileType,
                    title: defaultTitle,
                    initial_dir: defaultInitialDir
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.filename) {
                    // å°†é€‰æ‹©çš„æ–‡ä»¶è·¯å¾„å¡«å…¥è¾“å…¥æ¡†
                    document.getElementById(inputId).value = data.filename;
                    
                    // å¦‚æœæ˜¯æ•°æ®é›†é…ç½®æ–‡ä»¶ï¼Œè‡ªåŠ¨è®¾ç½®è¾“å‡ºæ¨¡å‹åç§°
                    if (inputId === 'dataset_config' && data.filename.toLowerCase().endsWith('.toml')) {
                        // å¤„ç†Windowså’ŒUnixè·¯å¾„åˆ†éš”ç¬¦ï¼Œè·å–çº¯æ–‡ä»¶å
                        const fileName = data.filename.split(/[\\\/]/).pop(); // è·å–æ–‡ä»¶å
                        const fileNameWithoutExt = fileName.replace(/\.toml$/i, '');
                        const outputNameElement = document.getElementById('output_name');
                        if (outputNameElement) {
                            outputNameElement.value = fileNameWithoutExt;
                        }
                        
                        // è‡ªåŠ¨è¯»å–batch_sizeå’Œnum_repeats
                        readBatchSizeFromToml(data.filename);
                        readNumRepeatsFromToml(data.filename);
                    }
                    
                    addLogEntry({
                        level: 'info',
                        message: `å·²é€‰æ‹©æ–‡ä»¶: ${data.filename}`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'warning',
                        message: data.message || 'æ–‡ä»¶é€‰æ‹©å¤±è´¥',
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                console.error('æ–‡ä»¶é€‰æ‹©APIè°ƒç”¨å¤±è´¥:', error);
                addLogEntry({
                    level: 'error',
                    message: 'æ–‡ä»¶é€‰æ‹©åŠŸèƒ½è°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡',
                    timestamp: new Date().toLocaleTimeString()
                });
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                button.textContent = originalText;
                button.disabled = false;
            });
        }
        
        function selectFolder(inputId) {
            // è·å–æŒ‰é’®å…ƒç´ å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'é€‰æ‹©ä¸­...';
            button.disabled = true;
            
            // æ ¹æ®è¾“å…¥æ¡†IDè®¾ç½®é»˜è®¤å‚æ•°
            let defaultTitle = 'é€‰æ‹©æ–‡ä»¶å¤¹';
            let defaultInitialDir = 'C:\\Users\\oskey\\ai\\musubi-tuner';
            
            if (inputId === 'output_dir') {
                defaultTitle = 'é€‰æ‹©è¾“å‡ºç›®å½•';
                defaultInitialDir = 'C:\\Users\\oskey\\ai\\musubi-tuner\\output';
            } else if (inputId === 'convert_output_dir') {
                defaultTitle = 'é€‰æ‹©è½¬æ¢åæ–‡ä»¶ä¿å­˜ç›®å½•';
                defaultInitialDir = 'C:\\Users\\oskey\\ai\\musubi-tuner\\output';
            } else if (inputId === 'resume') {
                defaultTitle = 'é€‰æ‹©è®­ç»ƒçŠ¶æ€ç›®å½•';
                defaultInitialDir = 'C:\\Users\\oskey\\ai\\musubi-tuner\\output';
            } else if (inputId === 'venv_python_path') {
                defaultTitle = 'é€‰æ‹©è™šæ‹Ÿç¯å¢ƒScriptsç›®å½•';
                defaultInitialDir = 'C:\\Users\\oskey\\ai\\musubi-tuner\\venv\\Scripts';
            }
            
            // è°ƒç”¨åç«¯API
            fetch('/api/select_folder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: defaultTitle,
                    initial_dir: defaultInitialDir
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.folder_path) {
                    // å°†é€‰æ‹©çš„æ–‡ä»¶å¤¹è·¯å¾„å¡«å…¥è¾“å…¥æ¡†
                    document.getElementById(inputId).value = data.folder_path;
                    
                    addLogEntry({
                        level: 'info',
                        message: `å·²é€‰æ‹©æ–‡ä»¶å¤¹: ${data.folder_path}`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'warning',
                        message: data.message || 'æ–‡ä»¶å¤¹é€‰æ‹©å¤±è´¥',
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                console.error('æ–‡ä»¶å¤¹é€‰æ‹©APIè°ƒç”¨å¤±è´¥:', error);
                addLogEntry({
                    level: 'error',
                    message: 'æ–‡ä»¶å¤¹é€‰æ‹©åŠŸèƒ½è°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡',
                    timestamp: new Date().toLocaleTimeString()
                });
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                button.textContent = originalText;
                button.disabled = false;
            });
        }
        
        function getConfig() {
            function safeGetValue(id, defaultValue = '', isCheckbox = false) {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`Element with id '${id}' not found, using default value:`, defaultValue);
                    return defaultValue;
                }
                return isCheckbox ? element.checked : element.value;
            }
            
            function safeGetIntValue(id, defaultValue = 0) {
                const value = safeGetValue(id, defaultValue.toString());
                return parseInt(value) || defaultValue;
            }
            
            function safeGetFloatValue(id, defaultValue = 0.0) {
                const value = safeGetValue(id, defaultValue.toString());
                return parseFloat(value) || defaultValue;
            }
            
            const config = {
                // ç¯å¢ƒé…ç½®
                enable_venv: safeGetValue('enable_venv', true, true),
                venv_python_path: safeGetValue('venv_python_path', './venv/Scripts/'),
                
                // æ ¸å¿ƒæ¨¡å‹è·¯å¾„
                dit: safeGetValue('dit', ''),
                dit_high_noise: safeGetValue('dit_high_noise', ''),
                vae: safeGetValue('vae', ''),
                t5: safeGetValue('t5', ''),
                dataset_config: safeGetValue('dataset_config', ''),
                
                // ä»»åŠ¡é…ç½®
                task: safeGetValue('task', currentTaskType === 'i2v' ? 'i2v-A14B' : 't2v-A14B'),
                
                // è®­ç»ƒæ ¸å¿ƒå‚æ•°
                mixed_precision: safeGetValue('mixed_precision', 'fp16'),
                timestep_sampling: safeGetValue('timestep_sampling', 'shift'),
                weighting_scheme: safeGetValue('weighting_scheme', 'none'),
                discrete_flow_shift: safeGetFloatValue('discrete_flow_shift', currentTaskType === 'i2v' ? 5.0 : 12.0),
                timestep_boundary: safeGetIntValue('timestep_boundary', currentTaskType === 'i2v' ? 900 : 875),
                min_timestep: safeGetIntValue('min_timestep', 0),
                max_timestep: safeGetIntValue('max_timestep', 1000),
                
                // ä¼˜åŒ–å™¨é…ç½®
                optimizer_type: safeGetValue('optimizer_type', 'adamw8bit'),
                learning_rate: safeGetValue('learning_rate', '2e-4'),
                
                // ç½‘ç»œé…ç½®
                network_module: safeGetValue('network_module', 'networks.lora_wan'),
                network_dim: safeGetIntValue('network_dim', 32),
                network_alpha: safeGetIntValue('network_alpha', 32),
                
                // è®­ç»ƒæ§åˆ¶
                max_train_epochs: safeGetIntValue('max_train_epochs', 16),
                save_every_n_epochs: safeGetIntValue('save_every_n_epochs', 1),
                // è®­ç»ƒçŠ¶æ€ç›¸å…³å‚æ•°ï¼ˆå‚ä¸è®­ç»ƒä½†ä¸å‚ä¸é…ç½®ä¿å­˜/åŠ è½½/é‡ç½®ï¼‰
                save_state: safeGetValue('save_state', false, true),
                resume_training: safeGetValue('resume_training', false, true),
                resume: safeGetValue('resume', ''),
                seed: safeGetIntValue('seed', 42),
                batch_size: safeGetIntValue('batch_size', 1),
                num_repeats: safeGetIntValue('num_repeats', 1),
                
                // è§†é¢‘è®­ç»ƒå‚æ•°
                is_video_training: safeGetValue('video_training_checkbox', false, true),
                video_duration: safeGetIntValue('video_duration', 300),
                
                // æ•°æ®åŠ è½½
                max_data_loader_n_workers: safeGetIntValue('max_data_loader_n_workers', 2),
                persistent_data_loader_workers: safeGetValue('persistent_data_loader_workers', false, true),
                
                // ä¼˜åŒ–é€‰é¡¹
                sdpa: safeGetValue('sdpa', true, true),
                gradient_checkpointing: safeGetValue('gradient_checkpointing', true, true),
                fp8_base: safeGetValue('fp8_base', true, true),
                fp8_t5: safeGetValue('fp8_t5', false, true),
                // å†…å­˜ä¼˜åŒ–ç­–ç•¥å¤„ç†
                memory_optimization_strategy: document.getElementById('memory_optimization_strategy').value,
                ...getMemoryOptimizationConfig(),
                fp8_scaled: safeGetValue('fp8_scaled', false, true),
                vae_cache_cpu: safeGetValue('vae_cache_cpu', false, true),
                
                // è¾“å‡ºé…ç½®
                output_dir: safeGetValue('output_dir', './output'),
                output_name: safeGetValue('output_name', 'wan22-lora'),
                logging_dir: safeGetValue('logging_dir', './logs'),
                log_with: safeGetValue('log_with', 'tensorboard'),
                
                // LoRAè½¬æ¢è®¾ç½®
                convert_input_file: safeGetValue('convert_input_file', ''),
                convert_output_dir: safeGetValue('convert_output_dir', ''),
                
                // ç³»ç»Ÿé…ç½®
                num_cpu_threads_per_process: safeGetIntValue('num_cpu_threads_per_process', 1),
                

            };
            
            return config;
        }
        
        function addLogEntry(entry) {
            const logOutput = document.getElementById('log-output');
            if (!logOutput) return;
            
            const shouldScroll = logOutput.scrollTop + logOutput.clientHeight >= logOutput.scrollHeight - 20;
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry log-' + entry.level;
            logEntry.innerHTML = `<span style="color: #888;">[${entry.timestamp}]</span> ${entry.message}`;
            logOutput.appendChild(logEntry);
            
            lastLogCount++;
            
            if (shouldScroll) {
                setTimeout(() => {
                    logOutput.scrollTop = logOutput.scrollHeight;
                }, 10);
            }
        }
        
        function startCacheVAE() {
            if (isRunning) return;
            
            const config = getConfig();
            setCacheButtonsEnabled(false);
            updateStatus('running', 'æ­£åœ¨é¢„ç¼“å­˜VAE Latents...');
            
            addLogEntry({
                level: 'info',
                message: 'å¼€å§‹é¢„ç¼“å­˜VAE Latents...',
                timestamp: new Date().toLocaleTimeString()
            });
            
            fetch('/api/cache_vae', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isRunning = true;
                    currentRunningTask = 'caching';
                    addLogEntry({
                        level: 'success',
                        message: 'VAE Latentsé¢„ç¼“å­˜å¯åŠ¨æˆåŠŸ',
                        timestamp: new Date().toLocaleTimeString()
                    });
                    pollStatus();
                    startLogPolling(); // å¼€å§‹è½®è¯¢æ—¥å¿—
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'VAE Latentsé¢„ç¼“å­˜å¯åŠ¨å¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                    setCacheButtonsEnabled(true);
                    updateStatus('error', 'é¢„ç¼“å­˜å¤±è´¥');
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'è¯·æ±‚å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
                setCacheButtonsEnabled(true);
                updateStatus('error', 'è¯·æ±‚å¤±è´¥');
            });
        }
        
        function startCacheTextEncoder() {
            if (isRunning) return;
            
            const config = getConfig();
            setCacheButtonsEnabled(false);
            updateStatus('running', 'æ­£åœ¨é¢„ç¼“å­˜æ–‡æœ¬ç¼–ç å™¨è¾“å‡º...');
            
            addLogEntry({
                level: 'info',
                message: 'å¼€å§‹é¢„ç¼“å­˜æ–‡æœ¬ç¼–ç å™¨è¾“å‡º...',
                timestamp: new Date().toLocaleTimeString()
            });
            
            fetch('/api/cache_text_encoder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isRunning = true;
                    currentRunningTask = 'caching';
                    addLogEntry({
                        level: 'success',
                        message: 'æ–‡æœ¬ç¼–ç å™¨è¾“å‡ºé¢„ç¼“å­˜å¯åŠ¨æˆåŠŸ',
                        timestamp: new Date().toLocaleTimeString()
                    });
                    pollStatus();
                    startLogPolling(); // å¼€å§‹è½®è¯¢æ—¥å¿—
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'æ–‡æœ¬ç¼–ç å™¨è¾“å‡ºé¢„ç¼“å­˜å¯åŠ¨å¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                    setCacheButtonsEnabled(true);
                    updateStatus('error', 'é¢„ç¼“å­˜å¤±è´¥');
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'è¯·æ±‚å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
                setCacheButtonsEnabled(true);
                updateStatus('error', 'è¯·æ±‚å¤±è´¥');
            });
        }
        
        function startTraining() {
            if (isRunning) return;
            
            const config = getConfig();
            setTrainingButtonsEnabled(false);
            updateStatus('running', 'æ­£åœ¨å¯åŠ¨è®­ç»ƒ...');
            
            addLogEntry({
                level: 'info',
                message: `å¼€å§‹${currentTaskType === 'i2v' ? 'å›¾ç”Ÿè§†é¢‘' : 'æ–‡ç”Ÿè§†é¢‘'}è®­ç»ƒ...`,
                timestamp: new Date().toLocaleTimeString()
            });
            
            fetch('/api/start_training', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogEntry({
                        level: 'success',
                        message: 'è®­ç»ƒå¯åŠ¨æˆåŠŸ',
                        timestamp: new Date().toLocaleTimeString()
                    });
                    pollStatus();
                    startLogPolling(); // å¼€å§‹è½®è¯¢æ—¥å¿—
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'è®­ç»ƒå¯åŠ¨å¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                    setTrainingButtonsEnabled(true);
                    updateStatus('error', 'è®­ç»ƒå¤±è´¥');
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'è¯·æ±‚å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
                setTrainingButtonsEnabled(true);
                updateStatus('error', 'è¯·æ±‚å¤±è´¥');
            });
        }
        
        function stopTraining() {
            if (!isRunning || currentRunningTask !== 'training') return;
            
            fetch('/api/stop_training', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                addLogEntry({
                    level: 'info',
                    message: 'è®­ç»ƒåœæ­¢è¯·æ±‚å·²å‘é€',
                    timestamp: new Date().toLocaleTimeString()
                });
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'åœæ­¢è®­ç»ƒå¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        

        
        function convertLora() {
            const config = getConfig();
            const inputFile = config.convert_input_file;
            const outputDir = config.convert_output_dir;
            
            if (!inputFile || !outputDir) {
                addLogEntry({
                    level: 'error',
                    message: 'è¯·å…ˆè®¾ç½®å¾…è½¬æ¢LoRAæ–‡ä»¶åœ°å€å’Œè½¬æ¢åLoRAæ–‡ä»¶åœ°å€',
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }
            
            addLogEntry({
                level: 'info',
                message: 'å¼€å§‹è½¬æ¢ LoRA ä¸º ComfyUI å…¼å®¹æ ¼å¼...',
                timestamp: new Date().toLocaleTimeString()
            });
            
            fetch('/api/convert_lora', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    input_file: inputFile,
                    output_dir: outputDir
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogEntry({
                        level: 'success',
                        message: `LoRA è½¬æ¢æˆåŠŸ: ${data.message}`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'LoRA è½¬æ¢å¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'LoRA è½¬æ¢è¯·æ±‚å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function startTensorBoard() {
            const config = getConfig();
            fetch('/api/start_tensorboard', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogEntry({
                        level: 'success',
                        message: `TensorBoardå·²å¯åŠ¨: ${data.url}`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                    if (data.url) {
                        window.open(data.url, '_blank');
                    }
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'TensorBoardå¯åŠ¨å¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'TensorBoardå¯åŠ¨å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        let logPollingInterval = null;
        
        function clearLogs() {
            fetch('/api/clear_logs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const logOutput = document.getElementById('log-output');
                    logOutput.innerHTML = '';
                    addLogEntry({
                        level: 'info',
                        message: 'æ—¥å¿—å·²æ¸…ç©º',
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'æ¸…ç©ºæ—¥å¿—å¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'æ¸…ç©ºæ—¥å¿—å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function scrollToBottom() {
            const logOutput = document.getElementById('log-output');
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        function startLogPolling() {
            // WebSocketæ¨¡å¼ä¸‹ä¸éœ€è¦è½®è¯¢ï¼Œä¿ç•™å‡½æ•°ä»¥å…¼å®¹ç°æœ‰ä»£ç 
            console.log('ä½¿ç”¨WebSocketå®æ—¶æ—¥å¿—ï¼Œæ— éœ€å¯åŠ¨è½®è¯¢');
        }
        
        function stopLogPolling() {
            // WebSocketæ¨¡å¼ä¸‹ä¸éœ€è¦è½®è¯¢ï¼Œä¿ç•™å‡½æ•°ä»¥å…¼å®¹ç°æœ‰ä»£ç 
            console.log('ä½¿ç”¨WebSocketå®æ—¶æ—¥å¿—ï¼Œæ— éœ€åœæ­¢è½®è¯¢');
        }
        
        function pollStatus() {
            if (!isRunning) return;
            
            fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                // æ£€æŸ¥ç¼“å­˜ä»»åŠ¡çŠ¶æ€
                if (data.cache_running) {
                    updateStatus('running', `${data.cache_type}ç¼“å­˜è¿›è¡Œä¸­...`);
                    setTimeout(pollStatus, 2000);
                    return;
                }
                
                // æ£€æŸ¥è®­ç»ƒä»»åŠ¡çŠ¶æ€
                if (data.training_running) {
                    updateStatus('running', data.status || 'è®­ç»ƒè¿›è¡Œä¸­...');
                    if (data.progress !== undefined) {
                        updateProgress(data.progress);
                    }
                    setTimeout(pollStatus, 2000);
                } else {
                    // ä»»åŠ¡å®Œæˆï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
                    isRunning = false;
                    currentRunningTask = null;
                    
                    // æ ¹æ®ä¹‹å‰çš„ä»»åŠ¡ç±»å‹æ¢å¤æŒ‰é’®çŠ¶æ€
                    setTrainingButtonsEnabled(true);
                    setCacheButtonsEnabled(true);
                    setButtonsEnabled(true);
                    
                    updateStatus('ready', 'å°±ç»ª');
                    updateProgress(0);
                    stopLogPolling(); // åœæ­¢æ—¥å¿—è½®è¯¢
                    
                    if (data.training_completed) {
                        addLogEntry({
                            level: 'success',
                            message: 'è®­ç»ƒå®Œæˆ',
                            timestamp: new Date().toLocaleTimeString()
                        });
                    } else if (data.training_error) {
                        addLogEntry({
                            level: 'error',
                            message: 'è®­ç»ƒå¤±è´¥',
                            timestamp: new Date().toLocaleTimeString()
                        });
                    }
                }
            })
            .catch(error => {
                console.error('çŠ¶æ€è½®è¯¢å¤±è´¥:', error);
                setTimeout(pollStatus, 5000);
            });
        }
        
        function fetchLogs() {
            fetch('/api/logs')
            .then(response => response.json())
            .then(data => {
                if (data.logs && data.logs.length > lastLogCount) {
                    const newLogs = data.logs.slice(lastLogCount);
                    newLogs.forEach(log => {
                        addLogEntry(log);
                    });
                    lastLogCount = data.logs.length;
                }
            })
            .catch(error => {
                console.error('è·å–æ—¥å¿—å¤±è´¥:', error);
            });
        }
        
        function saveConfig() {
            const config = getConfig();
            
            fetch('/api/save_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogEntry({
                        level: 'success',
                        message: 'é…ç½®å·²ä¿å­˜',
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'é…ç½®ä¿å­˜å¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'é…ç½®ä¿å­˜å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function loadConfig() {
            fetch('/api/load_config')
            .then(response => response.json())
            .then(data => {
                // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½å°è¯•ä½¿ç”¨è¿”å›çš„é…ç½®ï¼ˆå¤±è´¥æ—¶åç«¯ä¼šè¿”å›é»˜è®¤é…ç½®ï¼‰
                const config = data.config;
                if (config) {
                    // è®¾ç½®ä»»åŠ¡ç±»å‹
                    if (config.task) {
                        selectTaskType(config.task);
                    }
                    
                    // å¡«å……è¡¨å•ï¼ˆè·³è¿‡è®­ç»ƒçŠ¶æ€ç›¸å…³å‚æ•°ï¼‰
                    const skipParams = ['save_state', 'resume_training', 'resume'];
                    Object.keys(config).forEach(key => {
                        // è·³è¿‡è®­ç»ƒçŠ¶æ€ç›¸å…³å‚æ•°ï¼Œä¸å‚ä¸é…ç½®åŠ è½½
                        if (skipParams.includes(key)) {
                            return;
                        }
                        
                        const element = document.getElementById(key);
                        if (element) {
                            if (element.type === 'checkbox') {
                                element.checked = config[key];
                            } else {
                                element.value = config[key];
                            }
                        }
                    });
                    
                    // ç‰¹æ®Šå¤„ç†å†…å­˜ä¼˜åŒ–ç­–ç•¥æ¢å¤
                    if (config.memory_optimization_strategy) {
                        document.getElementById('memory_optimization_strategy').value = config.memory_optimization_strategy;
                    }
                    
                    // è§¦å‘å†…å­˜ä¼˜åŒ–ç­–ç•¥åˆ‡æ¢å¤„ç†
                    handleMemoryOptimizationChange();
                    
                    // è§¦å‘ç»§ç»­è®­ç»ƒé€‰é¡¹æ˜¾ç¤ºå¤„ç†
                    toggleResumeOptions();
                    
                    if (data.success) {
                        addLogEntry({
                            level: 'success',
                            message: 'é…ç½®å·²åŠ è½½',
                            timestamp: new Date().toLocaleTimeString()
                        });
                    } else {
                        addLogEntry({
                            level: 'warning',
                            message: 'ä½¿ç”¨é»˜è®¤é…ç½®: ' + (data.message || 'é…ç½®æ–‡ä»¶ä¸å­˜åœ¨'),
                            timestamp: new Date().toLocaleTimeString()
                        });
                    }
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'é…ç½®åŠ è½½å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'),
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'é…ç½®åŠ è½½å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
                // ç½‘ç»œé”™è¯¯æ—¶ï¼Œä½¿ç”¨å‰ç«¯é»˜è®¤é…ç½®
                loadDefaultConfig();
            });
        }
        
        function resetConfig() {
            if (confirm('ç¡®å®šè¦é‡ç½®é…ç½®å—ï¼Ÿè¿™å°†æ¢å¤æ‰€æœ‰å‚æ•°ä¸ºé»˜è®¤å€¼å¹¶è‡ªåŠ¨ä¿å­˜ã€‚')) {
                fetch('/api/reset_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ä½¿ç”¨è¿”å›çš„é…ç½®æ›´æ–°ç•Œé¢
                        const config = data.config;
                        
                        // æ›´æ–°æ‰€æœ‰è¡¨å•å­—æ®µï¼ˆè·³è¿‡è®­ç»ƒçŠ¶æ€ç›¸å…³å‚æ•°ï¼‰
                        const skipParams = ['save_state', 'resume_training', 'resume'];
                        Object.keys(config).forEach(key => {
                            // è·³è¿‡è®­ç»ƒçŠ¶æ€ç›¸å…³å‚æ•°ï¼Œä¸å‚ä¸é…ç½®é‡ç½®
                            if (skipParams.includes(key)) {
                                return;
                            }
                            
                            const element = document.getElementById(key);
                            if (element) {
                                if (element.type === 'checkbox') {
                                    element.checked = config[key];
                                } else if (element.type === 'number') {
                                    element.value = config[key];
                                } else {
                                    element.value = config[key];
                                }
                            } else {
                                console.warn(`Element with id '${key}' not found when resetting config`);
                            }
                        });
                        
                        // ç‰¹æ®Šå¤„ç†ä»»åŠ¡ç±»å‹
                        if (config.task) {
                            selectTaskType(config.task);
                        }
                        
                        addLogEntry({
                            level: 'info',
                            message: 'âœ… é…ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼å¹¶ä¿å­˜',
                            timestamp: new Date().toLocaleTimeString()
                        });
                    } else {
                        addLogEntry({
                            level: 'error',
                            message: 'âŒ é‡ç½®é…ç½®å¤±è´¥: ' + data.message,
                            timestamp: new Date().toLocaleTimeString()
                        });
                    }
                })
                .catch(error => {
                    console.error('Reset config error:', error);
                    addLogEntry({
                        level: 'error',
                        message: 'âŒ é‡ç½®é…ç½®å¤±è´¥: ' + error.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                });
            }
        }
        
        function estimateTrainingTime() {
            // è·å–è®­ç»ƒå‚æ•°
            const datasetConfig = document.getElementById('dataset_config').value;
            const trainBatchSize = parseInt(document.getElementById('batch_size').value) || 1;
            const numRepeats = parseInt(document.getElementById('num_repeats').value) || 1;
            const maxTrainEpochs = parseInt(document.getElementById('max_train_epochs').value) || 1;
            const saveEveryNEpochs = parseInt(document.getElementById('save_every_n_epochs').value) || 1;
            const outputName = document.getElementById('output_name').value || 'wan22-lora';
            const avgStepTime = parseFloat(document.getElementById('avg_step_time').value) || 2.92;
            
            // è·å–è§†é¢‘è®­ç»ƒç›¸å…³å‚æ•°
            const isVideoTraining = document.getElementById('video_training_checkbox') ? 
                document.getElementById('video_training_checkbox').checked : false;
            const videoDuration = isVideoTraining && document.getElementById('video_duration') ? 
                parseInt(document.getElementById('video_duration').value) || 5 : 0;
            
            if (!datasetConfig) {
                addLogEntry({
                    level: 'warning',
                    message: 'è¯·å…ˆé€‰æ‹©æ•°æ®é›†é…ç½®æ–‡ä»¶',
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const resultsDiv = document.getElementById('estimation_results');
            resultsDiv.style.display = 'block';
            document.getElementById('final_time_result').textContent = 'è®¡ç®—ä¸­...';
            
            // æ¸…é™¤ä¹‹å‰çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingFileList = resultsDiv.querySelector('div[style*="border-left: 4px solid #9b59b6"]');
            if (existingFileList) {
                existingFileList.remove();
            }
            
            // è°ƒç”¨åç«¯APIä¼°ç®—è®­ç»ƒæ—¶é—´
            fetch('/api/estimate_training_time', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dataset_config: datasetConfig,
                    batch_size: trainBatchSize,
                    num_repeats: numRepeats,
                    max_train_epochs: maxTrainEpochs,
                    save_every_n_epochs: saveEveryNEpochs,
                    output_name: outputName,
                    avg_step_time: avgStepTime,
                    is_video_training: isVideoTraining,
                    video_duration: videoDuration
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ—¶é—´æ ¼å¼è½¬æ¢å‡½æ•°
                    function formatTime(seconds) {
                        const hours = Math.floor(seconds / 3600);
                        const minutes = Math.floor((seconds % 3600) / 60);
                        const remainingSeconds = Math.floor(seconds % 60);
                        
                        if (hours > 0) {
                            return `${hours} å°æ—¶ ${minutes} åˆ†é’Ÿ ${remainingSeconds} ç§’`;
                        } else if (minutes > 0) {
                            return `${minutes} åˆ†é’Ÿ ${remainingSeconds} ç§’`;
                        } else {
                            return `${remainingSeconds} ç§’`;
                        }
                    }
                    
                    // è®¡ç®—æ€»ç§’æ•°
                    const totalSeconds = data.total_steps * avgStepTime;
                    const formattedTime = formatTime(totalSeconds);
                    
                    // æ›´æ–°æœ€ç»ˆç»“æœ
                    document.getElementById('final_time_result').textContent = formattedTime;
                    
                    // æ›´æ–°å‚æ•°æ˜¾ç¤º
                    document.getElementById('dataset_files_display').textContent = `${data.dataset_files} ä¸ªæ–‡ä»¶`;
                    document.getElementById('batch_size_display').textContent = trainBatchSize;
                    document.getElementById('num_repeats_display').textContent = numRepeats;
                    document.getElementById('max_epochs_display').textContent = maxTrainEpochs;
                    document.getElementById('step_time_display').textContent = `${avgStepTime} ç§’`;
                    
                    // æ›´æ–°è®¡ç®—å…¬å¼æ˜¾ç¤º
                    let calculationText;
                    if (isVideoTraining && data.video_segments) {
                        // è§†é¢‘è®­ç»ƒæ¨¡å¼ï¼šæ˜¾ç¤ºç‰‡æ®µè®¡ç®—é€»è¾‘
                        calculationText = `æ€»æ­¥æ•° = ${data.video_segments} ä¸ªè§†é¢‘ç‰‡æ®µ Ã· ${trainBatchSize} Ã— ${maxTrainEpochs} = ${data.total_steps} æ­¥`;
                    } else {
                        // å›¾ç‰‡è®­ç»ƒæ¨¡å¼ï¼šä½¿ç”¨åŸæœ‰é€»è¾‘
                        calculationText = `æ€»æ­¥æ•° = (${data.dataset_files} Ã— ${numRepeats} Ã· ${trainBatchSize}) Ã— ${maxTrainEpochs} = ${data.total_steps} æ­¥`;
                    }
                    document.getElementById('total_steps_calculation').textContent = calculationText;
                    
                    document.getElementById('time_calculation').textContent = 
                        `é¢„ä¼°æ—¶é—´ = ${data.total_steps} Ã— ${avgStepTime} = ${totalSeconds.toFixed(1)} ç§’ (${formattedTime})`;
                    
                    // æ˜¾ç¤ºé¢„è®¡ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
                    if (data.predicted_files && data.predicted_files.length > 0) {
                        let fileListHtml = '<div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.9); border-radius: 8px; border-left: 4px solid #9b59b6;"><h4 style="margin: 0 0 15px 0; color: #8e44ad; border-bottom: 2px solid #9b59b6; padding-bottom: 5px;">ğŸ“ é¢„è®¡ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨</h4>';
                        
                        data.predicted_files.forEach((file, index) => {
                            fileListHtml += `
                                <div style="margin-bottom: 8px; padding: 8px 12px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 6px; border-left: 3px solid #9b59b6; font-family: 'Courier New', monospace;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: bold; color: #6f42c1;">${file.filename}</span>
                                        <span style="color: #6c757d; font-size: 12px;">ç¬¬${file.save_count}æ¬¡ä¿å­˜</span>
                                    </div>
                                    <div style="margin-top: 4px; color: #495057; font-size: 13px;">
                                        <span style="background: #e7f3ff; padding: 2px 6px; border-radius: 3px; margin-right: 8px;">è½®æ¬¡: ${file.epoch}</span>
                                        <span style="background: #fff2e7; padding: 2px 6px; border-radius: 3px;">æ­¥æ•°: ${file.step_range}</span>
                                    </div>
                                </div>
                            `;
                        });
                        
                        fileListHtml += '</div>';
                        
                        // å°†æ–‡ä»¶åˆ—è¡¨æ·»åŠ åˆ°ç»“æœåŒºåŸŸ
                        const resultsDiv = document.getElementById('estimation_results');
                        resultsDiv.insertAdjacentHTML('beforeend', fileListHtml);
                    }
                    
                    addLogEntry({
                        level: 'info',
                        message: `âœ… è®­ç»ƒæ—¶é—´ä¼°ç®—å®Œæˆ: ${formattedTime} (æ€»æ­¥æ•°: ${data.total_steps}, æ•°æ®é›†æ–‡ä»¶æ•°: ${data.dataset_files}, é¢„è®¡ç”Ÿæˆ${data.predicted_files ? data.predicted_files.length : 0}ä¸ªæ–‡ä»¶)`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    // éšè—ç»“æœåŒºåŸŸå¹¶æ˜¾ç¤ºé”™è¯¯
                    resultsDiv.style.display = 'none';
                    addLogEntry({
                        level: 'error',
                        message: 'âŒ è®­ç»ƒæ—¶é—´ä¼°ç®—å¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'è®­ç»ƒæ—¶é—´ä¼°ç®—å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function setRecommendedNumRepeats() {
            // è·å–å¿…è¦çš„å‚æ•°
            const datasetConfig = document.getElementById('dataset_config').value;
            const videoTrainingCheckbox = document.getElementById('video_training_checkbox');
            const isVideoTraining = videoTrainingCheckbox ? videoTrainingCheckbox.checked : false;
            const videoDurationInput = document.getElementById('video_duration');
            const videoDuration = videoDurationInput ? (parseFloat(videoDurationInput.value) || 5) : 5;
            const batchSizeInput = document.getElementById('batch_size');
            const batchSize = batchSizeInput ? (parseInt(batchSizeInput.value) || 1) : 1;
            
            console.log('setRecommendedNumRepeats - datasetConfig:', datasetConfig);
            console.log('setRecommendedNumRepeats - isVideoTraining:', isVideoTraining);
            console.log('setRecommendedNumRepeats - videoDuration:', videoDuration);
            
            if (!datasetConfig) {
                addLogEntry({
                    level: 'warning',
                    message: 'è¯·å…ˆé€‰æ‹©æ•°æ®é›†é…ç½®æ–‡ä»¶',
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }
            
            // è°ƒç”¨åç«¯APIè·å–æ¨èçš„num_repeatså€¼
            fetch('/api/calculate_recommended_num_repeats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dataset_config: datasetConfig,
                    task_type: currentTaskType,
                    is_video_training: isVideoTraining,
                    video_duration: videoDuration,
                    batch_size: batchSize
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('APIå“åº”æ•°æ®:', data);
                if (data.success) {
                    // è®¾ç½®æ¨èçš„num_repeatså€¼åˆ°è¾“å…¥æ¡†
                    const numRepeatsInput = document.getElementById('num_repeats');
                    if (numRepeatsInput && data.recommended_repeats !== undefined) {
                        numRepeatsInput.value = data.recommended_repeats;
                    }
                    
                    let message;
                    const recommendedValue = data.recommended_repeats || 'N/A';
                    const datasetFiles = data.dataset_files || 'N/A';
                    const actualVideoDuration = data.video_duration || videoDuration;
                    
                    if (isVideoTraining) {
                        message = `âœ… æ¨èæ•°æ®é‡å¤æ¬¡æ•°: ${recommendedValue} (è§†é¢‘è®­ç»ƒæ¨¡å¼, è§†é¢‘æ—¶é•¿: ${actualVideoDuration}ç§’, æ•°æ®é›†: ${datasetFiles}ä¸ªæ–‡ä»¶)`;
                    } else {
                        message = `âœ… æ¨èæ•°æ®é‡å¤æ¬¡æ•°: ${recommendedValue} (å›¾ç‰‡è®­ç»ƒæ¨¡å¼, æ•°æ®é›†: ${datasetFiles}ä¸ªæ–‡ä»¶)`;
                    }
                    
                    addLogEntry({
                        level: 'success',
                        message: message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'âŒ æ¨èæ•°æ®é‡å¤æ¬¡æ•°è®¡ç®—å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'),
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'æ¨èæ•°æ®é‡å¤æ¬¡æ•°è®¡ç®—å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function calculateRecommendedLearningRate() {
            // è·å–å¿…è¦çš„å‚æ•°
            const datasetConfig = document.getElementById('dataset_config').value;
            const trainBatchSize = parseInt(document.getElementById('batch_size').value) || 1;
            const optimizerType = document.getElementById('optimizer_type').value || 'adamw8bit';
            
            if (!datasetConfig) {
                addLogEntry({
                    level: 'warning',
                    message: 'è¯·å…ˆé€‰æ‹©æ•°æ®é›†é…ç½®æ–‡ä»¶',
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘è®­ç»ƒ
            const isVideoTraining = document.getElementById('video_training_checkbox') ? 
                document.getElementById('video_training_checkbox').checked : false;
            
            // è·å–è§†é¢‘æ—¶é•¿
            const videoDuration = parseFloat(document.getElementById('video_duration').value) || 5;
            
            // æ˜¾ç¤ºè®¡ç®—ä¸­çŠ¶æ€
            const resultSpan = document.getElementById('lr_calculation_result');
            if (resultSpan) {
                resultSpan.textContent = 'è®¡ç®—ä¸­...';
                resultSpan.style.color = '#ffc107';
            }
            
            // è°ƒç”¨åç«¯APIè®¡ç®—æ¨èå­¦ä¹ ç‡
            fetch('/api/calculate_recommended_learning_rate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dataset_config: datasetConfig,
                    batch_size: trainBatchSize,
                    optimizer_type: optimizerType,
                    task_type: currentTaskType,
                    is_video_training: isVideoTraining,
                    video_duration: videoDuration
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // è®¾ç½®æ¨èå­¦ä¹ ç‡åˆ°è¾“å…¥æ¡†
                    document.getElementById('learning_rate').value = data.recommended_lr;
                    
                    // æ˜¾ç¤ºè®¡ç®—è¿‡ç¨‹
                    if (resultSpan) {
                        // æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘è®­ç»ƒæ¨¡å¼
                        const isVideoTraining = document.getElementById('video_training_checkbox') ? 
                            document.getElementById('video_training_checkbox').checked : false;
                        
                        let datasetInfo;
                        if (isVideoTraining && data.video_duration) {
                            datasetInfo = `ğŸ¬ è§†é¢‘æ—¶é•¿: ${data.video_duration}ç§’`;
                        } else {
                            datasetInfo = `ğŸ“ æ•°æ®é›†: ${data.dataset_files}ä¸ªæ–‡ä»¶`;
                        }
                        
                        resultSpan.innerHTML = `
                            ğŸ“Š ${data.calculation}<br>
                            ${datasetInfo} | ğŸ”§ ä¼˜åŒ–å™¨: ${data.optimizer_type}<br>
                            ğŸ’¡ ${data.optimizer_description}
                        `;
                        resultSpan.style.color = '#28a745';
                    }
                    
                    addLogEntry({
                        level: 'success',
                        message: `âœ… æ¨èå­¦ä¹ ç‡è®¡ç®—å®Œæˆ: ${data.recommended_lr} (ä¼˜åŒ–å™¨: ${data.optimizer_type}, æ•°æ®é›†: ${data.dataset_files}ä¸ªæ–‡ä»¶)`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    if (resultSpan) {
                        resultSpan.textContent = 'è®¡ç®—å¤±è´¥: ' + data.message;
                        resultSpan.style.color = '#dc3545';
                    }
                    
                    addLogEntry({
                        level: 'error',
                        message: 'âŒ æ¨èå­¦ä¹ ç‡è®¡ç®—å¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                if (resultSpan) {
                    resultSpan.textContent = 'è®¡ç®—å¤±è´¥: ' + error.message;
                    resultSpan.style.color = '#dc3545';
                }
                
                addLogEntry({
                    level: 'error',
                    message: 'âŒ æ¨èå­¦ä¹ ç‡è®¡ç®—å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function calculateGPTRecommendedLearningRate() {
            // è·å–å¿…è¦çš„å‚æ•°
            const datasetConfig = document.getElementById('dataset_config').value;
            
            if (!datasetConfig) {
                addLogEntry({
                    level: 'warning',
                    message: 'è¯·å…ˆé€‰æ‹©æ•°æ®é›†é…ç½®æ–‡ä»¶',
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘è®­ç»ƒ
            const isVideoTraining = document.getElementById('video_training_checkbox') ? 
                document.getElementById('video_training_checkbox').checked : false;
            
            // è·å–è§†é¢‘æ—¶é•¿ï¼ˆåªæœ‰åœ¨è§†é¢‘è®­ç»ƒæ¨¡å¼ä¸‹æ‰è·å–ï¼‰
            const videoDuration = isVideoTraining && document.getElementById('video_duration') ? 
                parseInt(document.getElementById('video_duration').value) || 5 : 0;
            
            // è·å–ä¼˜åŒ–å™¨ç±»å‹
            const optimizer = document.getElementById('optimizer_type') ? 
                document.getElementById('optimizer_type').value : 'AdamW';
            
            // è·å–LoRA rank
            const loraRank = document.getElementById('network_dim') ? 
                parseInt(document.getElementById('network_dim').value) || 8 : 8;
            
            // æ˜¾ç¤ºè®¡ç®—ä¸­çŠ¶æ€
            const chatgptResultSpan = document.getElementById('chatgpt_lr_calculation_result');
            if (chatgptResultSpan) {
                chatgptResultSpan.textContent = 'è®¡ç®—ä¸­...';
                chatgptResultSpan.style.color = '#ffc107';
            }
            
            // è°ƒç”¨åç«¯APIè®¡ç®—GPTæ¨èå­¦ä¹ ç‡
            fetch('/api/calculate_gpt_recommended_learning_rate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dataset_config: datasetConfig,
                    task_type: currentTaskType,
                    is_video_training: isVideoTraining,
                    video_duration: videoDuration,
                    optimizer: optimizer,
                    lora_rank: loraRank
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // è®¾ç½®æ¨èå­¦ä¹ ç‡å’Œè®­ç»ƒè½®æ•°åˆ°è¾“å…¥æ¡†
                    document.getElementById('learning_rate').value = data.recommended_lr;
                    document.getElementById('max_train_epochs').value = data.recommended_epochs;
                    
                    // æ˜¾ç¤ºæ™ºèƒ½æ¨èç»“æœ
                    addLogEntry({
                        level: 'success',
                        message: `ğŸ¤– ChatGPTæ™ºèƒ½æ¨èå®Œæˆ! å­¦ä¹ ç‡: ${data.recommended_lr}, è®­ç»ƒè½®æ•°: ${data.recommended_epochs}`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                    
                    // æ˜¾ç¤ºæ¨èè¯¦æƒ…
                    addLogEntry({
                        level: 'info',
                        message: `ğŸ“Š ${data.description}`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                    
                    // æ˜¾ç¤ºè®¡ç®—è¿‡ç¨‹åœ¨ChatGPTæ¨èæç¤ºæ¡†ä¸­
                    if (chatgptResultSpan) {
                        // æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘è®­ç»ƒæ¨¡å¼
                        const isVideoTraining = document.getElementById('video_training_checkbox') ? 
                            document.getElementById('video_training_checkbox').checked : false;
                        
                        let datasetInfo;
                        if (isVideoTraining && data.video_duration) {
                            datasetInfo = `ğŸ¬ è§†é¢‘æ—¶é•¿: ${data.video_duration}ç§’`;
                        } else {
                            datasetInfo = `ğŸ“ æ•°æ®é›†: ${data.txt_count || data.dataset_files || 'N/A'}ä¸ªæ–‡ä»¶`;
                        }
                        
                        chatgptResultSpan.innerHTML = `
                            ğŸ“Š ${data.description}<br>
                            ${datasetInfo} | ğŸ”§ ä¼˜åŒ–å™¨: ${data.optimizer || optimizer}<br>
                            ğŸ¤– ChatGPTæ™ºèƒ½ç®—æ³•: åŸºäºæ•°æ®è§„æ¨¡åŠ¨æ€è°ƒæ•´å­¦ä¹ ç‡
                        `;
                        chatgptResultSpan.style.color = '#28a745';
                    }
                    
                    // æ˜¾ç¤ºè®¡ç®—å…¬å¼
                    if (data.recommendation_details && data.recommendation_details.formula) {
                        addLogEntry({
                            level: 'info',
                            message: `ğŸ§® è®¡ç®—å…¬å¼: ${data.recommendation_details.formula}`,
                            timestamp: new Date().toLocaleTimeString()
                        });
                    }
                    
                    // æ˜¾ç¤ºå®‰å…¨è¾¹ç•Œå’Œwarmupå»ºè®®
                    if (data.recommendation_details) {
                        if (data.recommendation_details.safety_bounds) {
                            addLogEntry({
                                level: 'info',
                                message: `ğŸ›¡ï¸ ${data.recommendation_details.safety_bounds}`,
                                timestamp: new Date().toLocaleTimeString()
                            });
                        }
                        if (data.recommendation_details.warmup_suggestion) {
                            addLogEntry({
                                level: 'info',
                                message: `ğŸ”¥ ${data.recommendation_details.warmup_suggestion}`,
                                timestamp: new Date().toLocaleTimeString()
                            });
                        }
                    }
                    
                    // æ˜¾ç¤ºè®­ç»ƒè½®æ•°æ¨èç†ç”±
                    addLogEntry({
                        level: 'info',
                        message: `ğŸ”„ ${data.epoch_reason}`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    if (chatgptResultSpan) {
                        chatgptResultSpan.textContent = 'è®¡ç®—å¤±è´¥: ' + data.message;
                        chatgptResultSpan.style.color = '#dc3545';
                    }
                    
                    addLogEntry({
                        level: 'error',
                        message: 'âŒ ChatGPTæ¨èå­¦ä¹ ç‡è®¡ç®—å¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                if (chatgptResultSpan) {
                    chatgptResultSpan.textContent = 'è®¡ç®—å¤±è´¥: ' + error.message;
                    chatgptResultSpan.style.color = '#dc3545';
                }
                
                addLogEntry({
                    level: 'error',
                    message: 'âŒ GPTæ¨èå­¦ä¹ ç‡è®¡ç®—å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function calculateRecommendedLoRADim() {
            const datasetConfig = document.getElementById('dataset_config').value;
            
            if (!datasetConfig) {
                addLogEntry({
                    level: 'warning',
                    message: 'è¯·å…ˆé€‰æ‹©æ•°æ®é›†é…ç½®æ–‡ä»¶',
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘è®­ç»ƒ
            const isVideoTraining = document.getElementById('video_training_checkbox') ? 
                document.getElementById('video_training_checkbox').checked : true;
            
            fetch('/api/calculate_recommended_lora_params', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dataset_config: datasetConfig,
                    param_type: 'network_dim',
                    task_type: currentTaskType,
                    is_video_training: isVideoTraining
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('network_dim').value = data.recommended_value;
                    
                    addLogEntry({
                        level: 'success',
                        message: `âœ… æ¨èLoRAç»´åº¦: ${data.recommended_value} (æ•°æ®é›†: ${data.dataset_files}ä¸ªæ–‡ä»¶) - ${data.reason}`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'âŒ LoRAç»´åº¦æ¨èå¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'âŒ LoRAç»´åº¦æ¨èå¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function calculateRecommendedLoRAAlpha() {
            const datasetConfig = document.getElementById('dataset_config').value;
            const currentDim = parseInt(document.getElementById('network_dim').value) || 8;
            
            if (!datasetConfig) {
                addLogEntry({
                    level: 'warning',
                    message: 'è¯·å…ˆé€‰æ‹©æ•°æ®é›†é…ç½®æ–‡ä»¶',
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘è®­ç»ƒ
            const isVideoTraining = document.getElementById('video_training_checkbox') ? 
                document.getElementById('video_training_checkbox').checked : true;
            
            fetch('/api/calculate_recommended_lora_params', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dataset_config: datasetConfig,
                    param_type: 'network_alpha',
                    current_dim: currentDim,
                    task_type: currentTaskType,
                    is_video_training: isVideoTraining
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('network_alpha').value = data.recommended_value;
                    
                    addLogEntry({
                        level: 'success',
                        message: `âœ… æ¨èLoRA Alpha: ${data.recommended_value} (å½“å‰ç»´åº¦: ${data.current_dim}) - ${data.reason}`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'âŒ LoRA Alphaæ¨èå¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'âŒ LoRA Alphaæ¨èå¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function calculateRecommendedEpochs() {
            const datasetConfig = document.getElementById('dataset_config').value;
            const trainBatchSize = parseInt(document.getElementById('batch_size').value) || 1;
            const isVideoTraining = document.getElementById('video_training_checkbox') ? 
                document.getElementById('video_training_checkbox').checked : false;
            const videoDuration = parseFloat(document.getElementById('video_duration').value) || 5;
            
            if (!datasetConfig) {
                addLogEntry({
                    level: 'warning',
                    message: 'è¯·å…ˆé€‰æ‹©æ•°æ®é›†é…ç½®æ–‡ä»¶',
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }
            
            fetch('/api/calculate_recommended_epochs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dataset_config: datasetConfig,
                    batch_size: trainBatchSize,
                    task_type: currentTaskType,
                    is_video_training: isVideoTraining,
                    video_duration: videoDuration
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('max_train_epochs').value = data.recommended_value;
                    
                    const timeHours = Math.floor(data.estimated_time_minutes / 60);
                    const timeMinutes = data.estimated_time_minutes % 60;
                    const timeStr = timeHours > 0 ? `${timeHours}å°æ—¶${timeMinutes}åˆ†é’Ÿ` : `${timeMinutes}åˆ†é’Ÿ`;
                    
                    addLogEntry({
                        level: 'success',
                        message: `âœ… æ¨èè®­ç»ƒè½®æ•°: ${data.recommended_value} (æ•°æ®é›†: ${data.dataset_files}å¼ , é¢„ä¼°æ—¶é—´: ${timeStr}) - ${data.reason}`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'âŒ è®­ç»ƒè½®æ•°æ¨èå¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'âŒ è®­ç»ƒè½®æ•°æ¨èå¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function calculateChatGPTRecommendedParams() {
            const datasetConfig = document.getElementById('dataset_config').value;
            
            if (!datasetConfig) {
                addLogEntry({
                    level: 'warning',
                    message: 'è¯·å…ˆé€‰æ‹©æ•°æ®é›†é…ç½®æ–‡ä»¶',
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘è®­ç»ƒ
            const isVideoTraining = document.getElementById('video_training_checkbox') ? 
                document.getElementById('video_training_checkbox').checked : true;
            
            // è·å–è§†é¢‘æ—¶é•¿ï¼ˆå¦‚æœæ˜¯è§†é¢‘è®­ç»ƒï¼‰
            const videoDuration = isVideoTraining && document.getElementById('video_duration') ? 
                parseInt(document.getElementById('video_duration').value) || 5 : 5;
            
            // è·å–æ‰¹æ¬¡å¤§å°
            const batchSize = document.getElementById('batch_size') ?
                parseInt(document.getElementById('batch_size').value) || 1 : 1;
            
            // æ˜¾ç¤ºè®¡ç®—ä¸­çŠ¶æ€
            const resultDiv = document.getElementById('chatgpt_params_result');
            if (resultDiv) {
                resultDiv.innerHTML = 'ğŸ¤– ChatGPTæ­£åœ¨è®¡ç®—æ¨èå‚æ•°...';
                resultDiv.style.display = 'block';
                resultDiv.style.color = '#ffc107';
            }
            
            fetch('/api/calculate_chatgpt_recommended_params', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dataset_config: datasetConfig,
                    task_type: currentTaskType,
                    is_video_training: isVideoTraining,
                    video_duration: videoDuration,
                    batch_size: batchSize
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // è‡ªåŠ¨å¡«å…¥æ‰€æœ‰æ¨èçš„å‚æ•°å€¼
                    if (data.num_repeats && document.getElementById('num_repeats')) {
                        document.getElementById('num_repeats').value = data.num_repeats;
                    }
                    if (data.learning_rate && document.getElementById('learning_rate')) {
                        document.getElementById('learning_rate').value = data.learning_rate;
                    }
                    if (data.network_dim && document.getElementById('network_dim')) {
                        document.getElementById('network_dim').value = data.network_dim;
                    }
                    if (data.network_alpha && document.getElementById('network_alpha')) {
                        document.getElementById('network_alpha').value = data.network_alpha;
                    }
                    if (data.max_train_epochs && document.getElementById('max_train_epochs')) {
                        document.getElementById('max_train_epochs').value = data.max_train_epochs;
                    }
                    
                    // æ˜¾ç¤ºæ¨èç»“æœå’Œè®¡ç®—å…¬å¼
                    if (resultDiv) {
                        let datasetInfo;
                        if (isVideoTraining && data.video_duration) {
                            datasetInfo = `ğŸ¬ è§†é¢‘æ—¶é•¿: ${data.video_duration}ç§’`;
                        } else {
                            datasetInfo = `ğŸ“ æ•°æ®é›†: ${data.dataset_files || 'N/A'}ä¸ªæ–‡ä»¶`;
                        }
                        
                        resultDiv.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 8px;">ğŸ¤– ChatGPTæ™ºèƒ½æ¨èå®Œæˆ</div>
                            <div style="margin-bottom: 6px;">${datasetInfo} | ğŸ“‹ ä»»åŠ¡: ${data.task_type || currentTaskType}</div>
                            <div style="margin-bottom: 8px; padding: 6px; background: #e3f2fd; border-radius: 4px;">
                                ğŸ“Š <strong>æ¨èå‚æ•°:</strong><br>
                                â€¢ æ•°æ®é‡å¤æ¬¡æ•°: ${data.num_repeats || 'N/A'}<br>
                                â€¢ å­¦ä¹ ç‡: ${data.learning_rate || 'N/A'}<br>
                                â€¢ LoRAç»´åº¦: ${data.network_dim || 'N/A'}<br>
                                â€¢ ç½‘ç»œAlpha: ${data.network_alpha || 'N/A'}<br>
                                â€¢ æœ€å¤§è®­ç»ƒè½®æ•°: ${data.max_train_epochs || 'N/A'}<br>
                                â€¢ æ‰¹æ¬¡å¤§å°: ${data.batch_size || 'N/A'}
                            </div>
                            <div style="font-size: 11px; color: #666;">
                                ğŸ§® <strong>ChatGPTè®¡ç®—å…¬å¼:</strong><br>
                                ${data.formula || 'åŸºäºæ•°æ®è§„æ¨¡å’Œä»»åŠ¡ç±»å‹çš„æ™ºèƒ½ç®—æ³•'}
                            </div>
                        `;
                        resultDiv.style.color = '#28a745';
                    }
                    
                    addLogEntry({
                        level: 'success',
                        message: `ğŸ¤– ChatGPTå‚æ•°æ¨èå®Œæˆ! å·²è‡ªåŠ¨å¡«å…¥æ‰€æœ‰æ¨èå‚æ•°`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                    
                    // æ˜¾ç¤ºæ¯ä¸ªå‚æ•°çš„æ¨èç†ç”±
                    if (data.reasons) {
                        Object.keys(data.reasons).forEach(param => {
                            addLogEntry({
                                level: 'info',
                                message: `ğŸ“ ${param}: ${data.reasons[param]}`,
                                timestamp: new Date().toLocaleTimeString()
                            });
                        });
                    }
                } else {
                    if (resultDiv) {
                        resultDiv.innerHTML = 'âŒ ChatGPTå‚æ•°æ¨èå¤±è´¥: ' + data.message;
                        resultDiv.style.color = '#dc3545';
                    }
                    addLogEntry({
                        level: 'error',
                        message: 'âŒ ChatGPTå‚æ•°æ¨èå¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                if (resultDiv) {
                    resultDiv.innerHTML = 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message;
                    resultDiv.style.color = '#dc3545';
                }
                addLogEntry({
                    level: 'error',
                    message: 'âŒ ChatGPTå‚æ•°æ¨èå¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function calculateDoubaoRecommendedParams() {
            const datasetConfig = document.getElementById('dataset_config').value;
            
            if (!datasetConfig) {
                addLogEntry({
                    level: 'warning',
                    message: 'è¯·å…ˆé€‰æ‹©æ•°æ®é›†é…ç½®æ–‡ä»¶',
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘è®­ç»ƒ
            const isVideoTraining = document.getElementById('video_training_checkbox') ? 
                document.getElementById('video_training_checkbox').checked : true;
            
            // è·å–è§†é¢‘æ—¶é•¿ï¼ˆå¦‚æœæ˜¯è§†é¢‘è®­ç»ƒï¼‰
            const videoDuration = isVideoTraining && document.getElementById('video_duration') ? 
                parseInt(document.getElementById('video_duration').value) || 5 : 5;
            
            // è·å–æ‰¹æ¬¡å¤§å°
            const batchSize = document.getElementById('batch_size') ?
                parseInt(document.getElementById('batch_size').value) || 1 : 1;
            
            // æ˜¾ç¤ºè®¡ç®—ä¸­çŠ¶æ€
            const resultDiv = document.getElementById('doubao_params_result');
            if (resultDiv) {
                resultDiv.innerHTML = 'ğŸ§  è±†åŒ…æ­£åœ¨è®¡ç®—æ¨èå‚æ•°...';
                resultDiv.style.display = 'block';
                resultDiv.style.color = '#ffc107';
            }
            
            fetch('/api/calculate_doubao_recommended_params', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dataset_config: datasetConfig,
                    task_type: currentTaskType,
                    is_video_training: isVideoTraining,
                    video_duration: videoDuration,
                    batch_size: batchSize
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // è‡ªåŠ¨å¡«å…¥æ‰€æœ‰æ¨èçš„å‚æ•°å€¼
                    if (data.recommended_params.num_repeats && document.getElementById('num_repeats')) {
                        document.getElementById('num_repeats').value = data.recommended_params.num_repeats;
                    }
                    if (data.recommended_params.learning_rate && document.getElementById('learning_rate')) {
                        document.getElementById('learning_rate').value = data.recommended_params.learning_rate;
                    }
                    if (data.recommended_params.network_dim && document.getElementById('network_dim')) {
                        document.getElementById('network_dim').value = data.recommended_params.network_dim;
                    }
                    if (data.recommended_params.network_alpha && document.getElementById('network_alpha')) {
                        document.getElementById('network_alpha').value = data.recommended_params.network_alpha;
                    }
                    if (data.recommended_params.max_train_epochs && document.getElementById('max_train_epochs')) {
                        document.getElementById('max_train_epochs').value = data.recommended_params.max_train_epochs;
                    }
                    if (data.recommended_params.batch_size && document.getElementById('batch_size')) {
                        document.getElementById('batch_size').value = data.recommended_params.batch_size;
                    }
                    
                    // æ˜¾ç¤ºæ¨èç»“æœ
                    if (resultDiv) {
                        resultDiv.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 8px;">ğŸ§  è±†åŒ…æ™ºèƒ½æ¨èå®Œæˆ</div>
                            <div style="margin-bottom: 8px; padding: 6px; background: #e8f4fd; border-radius: 4px;">
                                ğŸ“Š <strong>æ¨èå‚æ•°:</strong><br>
                                â€¢ å­¦ä¹ ç‡: ${data.recommended_params.learning_rate || 'N/A'}<br>
                                â€¢ LoRAç»´åº¦: ${data.recommended_params.network_dim || 'N/A'}<br>
                                â€¢ LoRA Alpha: ${data.recommended_params.network_alpha || 'N/A'}<br>
                                â€¢ è®­ç»ƒè½®æ•°: ${data.recommended_params.max_train_epochs || 'N/A'}<br>
                                â€¢ é‡å¤æ¬¡æ•°: ${data.recommended_params.num_repeats || 'N/A'}<br>
                                â€¢ æ‰¹æ¬¡å¤§å°: ${data.recommended_params.batch_size || 'N/A'}
                            </div>
                            <div style="font-size: 11px; color: #666; white-space: pre-line;">
                                ${data.reasoning || 'è±†åŒ…æ•°å­¦å»ºæ¨¡ç®—æ³•æ¨è'}
                            </div>
                        `;
                        resultDiv.style.color = '#4A90E2';
                    }
                    
                    addLogEntry({
                        level: 'success',
                        message: `ğŸ§  è±†åŒ…å‚æ•°æ¨èå®Œæˆ! å·²è‡ªåŠ¨å¡«å…¥æ‰€æœ‰æ¨èå‚æ•°`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    if (resultDiv) {
                        resultDiv.innerHTML = 'âŒ è±†åŒ…å‚æ•°æ¨èå¤±è´¥: ' + data.message;
                        resultDiv.style.color = '#dc3545';
                    }
                    addLogEntry({
                        level: 'error',
                        message: 'âŒ è±†åŒ…å‚æ•°æ¨èå¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                if (resultDiv) {
                    resultDiv.innerHTML = 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message;
                    resultDiv.style.color = '#dc3545';
                }
                addLogEntry({
                    level: 'error',
                    message: 'âŒ è±†åŒ…å‚æ•°æ¨èå¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function calculateSoftwareRecommendedParams() {
            const datasetConfig = document.getElementById('dataset_config').value;
            
            if (!datasetConfig) {
                addLogEntry({
                    level: 'warning',
                    message: 'è¯·å…ˆé€‰æ‹©æ•°æ®é›†é…ç½®æ–‡ä»¶',
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }
            
            // å¼¹çª—é€‰æ‹©LoRAç±»å‹
            const loraTypeModal = document.createElement('div');
            loraTypeModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                text-align: center;
                max-width: 400px;
                width: 90%;
            `;
            
            modalContent.innerHTML = `
                <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">âš™ï¸ é€‰æ‹©LoRAè®­ç»ƒç±»å‹</h3>
                <p style="margin: 0 0 25px 0; color: #666; line-height: 1.5;">è¯·é€‰æ‹©æ‚¨è¦è®­ç»ƒçš„LoRAç±»å‹ï¼Œè½¯ä»¶å°†æ ¹æ®ä¸åŒç±»å‹æä¾›ä¸“é—¨ä¼˜åŒ–çš„å‚æ•°ï¼š</p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button id="realistic-btn" style="
                        background: linear-gradient(45deg, #FF6B6B, #FF8E53);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: bold;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                    ">ğŸ“¸ å†™å®é£æ ¼</button>
                    <button id="anime-btn" style="
                        background: linear-gradient(45deg, #4A90E2, #7B68EE);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: bold;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                    ">ğŸ¨ åŠ¨æ¼«é£æ ¼</button>
                </div>
                <button id="cancel-btn" style="
                    background: #6c757d;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 12px;
                    margin-top: 15px;
                ">å–æ¶ˆ</button>
            `;
            
            loraTypeModal.appendChild(modalContent);
            document.body.appendChild(loraTypeModal);
            
            // æ·»åŠ æŒ‰é’®äº‹ä»¶
            document.getElementById('realistic-btn').onclick = () => {
                document.body.removeChild(loraTypeModal);
                performSoftwareRecommendation('realistic');
            };
            
            document.getElementById('anime-btn').onclick = () => {
                document.body.removeChild(loraTypeModal);
                performSoftwareRecommendation('anime');
            };
            
            document.getElementById('cancel-btn').onclick = () => {
                document.body.removeChild(loraTypeModal);
            };
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            loraTypeModal.onclick = (e) => {
                if (e.target === loraTypeModal) {
                    document.body.removeChild(loraTypeModal);
                }
            };
        }
        
        function performSoftwareRecommendation(loraType) {
            const datasetConfig = document.getElementById('dataset_config').value;
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘è®­ç»ƒ
            const isVideoTraining = document.getElementById('video_training_checkbox') ? 
                document.getElementById('video_training_checkbox').checked : false;
            
            // è·å–è§†é¢‘æ—¶é•¿ï¼ˆå¦‚æœæ˜¯è§†é¢‘è®­ç»ƒï¼‰
            const videoDuration = isVideoTraining && document.getElementById('video_duration') ? 
                parseInt(document.getElementById('video_duration').value) || 0 : 0;
            
            // è·å–æ‰¹æ¬¡å¤§å°
            const batchSize = document.getElementById('batch_size') ?
                parseInt(document.getElementById('batch_size').value) || 1 : 1;
            
            // æ˜¾ç¤ºè®¡ç®—ä¸­çŠ¶æ€
            const resultDiv = document.getElementById('software_params_result');
            if (resultDiv) {
                const loraTypeName = loraType === 'realistic' ? 'å†™å®é£æ ¼' : 'åŠ¨æ¼«é£æ ¼';
                resultDiv.innerHTML = `âš™ï¸ è½¯ä»¶æ­£åœ¨ä¸º${loraTypeName}è®¡ç®—æ¨èå‚æ•°...`;
                resultDiv.style.display = 'block';
                resultDiv.style.color = '#ffc107';
            }
            
            fetch('/api/calculate_software_recommended_params', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dataset_config: datasetConfig,
                    task_type: currentTaskType,
                    is_video_training: isVideoTraining,
                    video_duration: videoDuration,
                    batch_size: batchSize,
                    lora_type: loraType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // è‡ªåŠ¨å¡«å…¥æ‰€æœ‰æ¨èçš„å‚æ•°å€¼
                    if (data.recommended_params.num_repeats && document.getElementById('num_repeats')) {
                        document.getElementById('num_repeats').value = data.recommended_params.num_repeats;
                    }
                    if (data.recommended_params.learning_rate && document.getElementById('learning_rate')) {
                        document.getElementById('learning_rate').value = data.recommended_params.learning_rate;
                    }
                    if (data.recommended_params.network_dim && document.getElementById('network_dim')) {
                        document.getElementById('network_dim').value = data.recommended_params.network_dim;
                    }
                    if (data.recommended_params.network_alpha && document.getElementById('network_alpha')) {
                        document.getElementById('network_alpha').value = data.recommended_params.network_alpha;
                    }
                    if (data.recommended_params.max_train_epochs && document.getElementById('max_train_epochs')) {
                        document.getElementById('max_train_epochs').value = data.recommended_params.max_train_epochs;
                    }
                    
                    // æ˜¾ç¤ºæ¨èç»“æœ
                    if (resultDiv) {
                        const loraTypeName = loraType === 'realistic' ? 'å†™å®é£æ ¼' : 'åŠ¨æ¼«é£æ ¼';
                        resultDiv.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 8px;">âš™ï¸ è½¯ä»¶æ™ºèƒ½æ¨èå®Œæˆ (${loraTypeName})</div>
                            <div style="margin-bottom: 8px; padding: 6px; background: #e8f5e8; border-radius: 4px;">
                                ğŸ“Š <strong>æ¨èå‚æ•°:</strong><br>
                                â€¢ å­¦ä¹ ç‡: ${data.recommended_params.learning_rate || 'N/A'}<br>
                                â€¢ LoRAç»´åº¦: ${data.recommended_params.network_dim || 'N/A'}<br>
                                â€¢ LoRA Alpha: ${data.recommended_params.network_alpha || 'N/A'}<br>
                                â€¢ è®­ç»ƒè½®æ•°: ${data.recommended_params.max_train_epochs || 'N/A'}<br>
                                â€¢ é‡å¤æ¬¡æ•°: ${data.recommended_params.num_repeats || 'N/A'}
                            </div>
                            <div style="font-size: 11px; color: #666; white-space: pre-line;">
                                ${data.reasoning || 'è½¯ä»¶ä¸“ä¸šå‚æ•°æ¨è'}
                            </div>
                        `;
                        resultDiv.style.color = '#28A745';
                    }
                    
                    const loraTypeName = loraType === 'realistic' ? 'å†™å®é£æ ¼' : 'åŠ¨æ¼«é£æ ¼';
                    addLogEntry({
                        level: 'success',
                        message: `âš™ï¸ è½¯ä»¶å‚æ•°æ¨èå®Œæˆ(${loraTypeName})! å·²è‡ªåŠ¨å¡«å…¥æ‰€æœ‰æ¨èå‚æ•°`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    if (resultDiv) {
                        resultDiv.innerHTML = 'âŒ è½¯ä»¶å‚æ•°æ¨èå¤±è´¥: ' + data.message;
                        resultDiv.style.color = '#dc3545';
                    }
                    addLogEntry({
                        level: 'error',
                        message: 'âŒ è½¯ä»¶å‚æ•°æ¨èå¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                if (resultDiv) {
                    resultDiv.innerHTML = 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message;
                    resultDiv.style.color = '#dc3545';
                }
                addLogEntry({
                    level: 'error',
                    message: 'âŒ è½¯ä»¶å‚æ•°æ¨èå¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function setRecommendedNetworkDim() {
            const datasetConfig = document.getElementById('dataset_config').value;
            
            if (!datasetConfig) {
                addLogEntry({
                    level: 'warning',
                    message: 'è¯·å…ˆé€‰æ‹©æ•°æ®é›†é…ç½®æ–‡ä»¶',
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }
            
            const isVideoTraining = document.getElementById('video_training_checkbox') ? 
                document.getElementById('video_training_checkbox').checked : false;
            const videoDuration = parseFloat(document.getElementById('video_duration').value) || 5;
            
            fetch('/api/calculate_recommended_network_dim', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dataset_config: datasetConfig,
                    task_type: currentTaskType,
                    is_video_training: isVideoTraining,
                    video_duration: videoDuration
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('network_dim').value = data.recommended_dim;
                    
                    let message;
                    if (isVideoTraining) {
                        message = `âœ… æ¨èLoRAç»´åº¦: ${data.recommended_dim} (è§†é¢‘è®­ç»ƒæ¨¡å¼, è§†é¢‘æ—¶é•¿: ${videoDuration}ç§’, æ•°æ®é›†: ${data.dataset_files || 'N/A'}ä¸ªæ–‡ä»¶)`;
                    } else {
                        message = `âœ… æ¨èLoRAç»´åº¦: ${data.recommended_dim} (å›¾ç‰‡è®­ç»ƒæ¨¡å¼, æ•°æ®é›†: ${data.dataset_files}ä¸ªæ–‡ä»¶)`;
                    }
                    
                    addLogEntry({
                        level: 'success',
                        message: message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'âŒ LoRAç»´åº¦æ¨èå¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'LoRAç»´åº¦æ¨èå¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function setRecommendedNetworkAlpha() {
            const datasetConfig = document.getElementById('dataset_config').value;
            const networkDim = parseInt(document.getElementById('network_dim').value) || 16;
            
            if (!datasetConfig) {
                addLogEntry({
                    level: 'warning',
                    message: 'è¯·å…ˆé€‰æ‹©æ•°æ®é›†é…ç½®æ–‡ä»¶',
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }
            
            const isVideoTraining = document.getElementById('video_training_checkbox') ? 
                document.getElementById('video_training_checkbox').checked : false;
            const videoDuration = parseFloat(document.getElementById('video_duration').value) || 5;
            
            fetch('/api/calculate_recommended_network_alpha', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dataset_config: datasetConfig,
                    task_type: currentTaskType,
                    is_video_training: isVideoTraining,
                    video_duration: videoDuration,
                    network_dim: networkDim
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('network_alpha').value = data.recommended_alpha;
                    
                    let message;
                    if (isVideoTraining) {
                        message = `âœ… æ¨èLoRA Alpha: ${data.recommended_alpha} (è§†é¢‘è®­ç»ƒæ¨¡å¼, ç»´åº¦: ${networkDim}, è§†é¢‘æ—¶é•¿: ${videoDuration}ç§’)`;
                    } else {
                        message = `âœ… æ¨èLoRA Alpha: ${data.recommended_alpha} (å›¾ç‰‡è®­ç»ƒæ¨¡å¼, ç»´åº¦: ${networkDim}, æ•°æ®é›†: ${data.dataset_files}ä¸ªæ–‡ä»¶)`;
                    }
                    
                    addLogEntry({
                        level: 'success',
                        message: message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'âŒ LoRA Alphaæ¨èå¤±è´¥: ' + data.message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'LoRA Alphaæ¨èå¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId.replace('-params', '-toggle-icon'));
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.textContent = 'â–²';
            } else {
                content.style.display = 'none';
                icon.textContent = 'â–¼';
            }
        }
        
        // å†…å­˜ä¼˜åŒ–ç­–ç•¥åˆ‡æ¢å¤„ç†
        function handleMemoryOptimizationChange() {
            const strategy = document.getElementById('memory_optimization_strategy').value;
            const blocksConfig = document.getElementById('blocks_to_swap_config');
            
            if (strategy === 'blocks_to_swap') {
                blocksConfig.style.display = 'block';
            } else {
                blocksConfig.style.display = 'none';
            }
        }
        
        // åˆ‡æ¢æ–­ç‚¹ç»­è®­é€‰é¡¹æ˜¾ç¤º
        function toggleResumeOptions() {
            const resumeCheckbox = document.getElementById('resume_training');
            const resumePathGroup = document.getElementById('resume_path_group');
            
            if (resumeCheckbox.checked) {
                resumePathGroup.style.display = 'block';
            } else {
                resumePathGroup.style.display = 'none';
                // æ¸…ç©ºè·¯å¾„è¾“å…¥æ¡†
                document.getElementById('resume').value = '';
            }
        }
        
        // è·å–å†…å­˜ä¼˜åŒ–é…ç½®
        function getMemoryOptimizationConfig() {
            const strategy = document.getElementById('memory_optimization_strategy').value;
            
            if (strategy === 'blocks_to_swap') {
                const blocksValue = parseInt(document.getElementById('blocks_to_swap').value) || 20;
                return {
                    blocks_to_swap: blocksValue,
                    offload_inactive_dit: false
                };
            } else {
                return {
                    blocks_to_swap: 0,
                    offload_inactive_dit: true
                };
            }
        }
        
        // åˆ‡æ¢çŠ¶æ€æ–‡ä»¶å¤¹è·¯å¾„è¾“å…¥æ¡†æ˜¾ç¤º/éšè—

        
        // åˆ‡æ¢è§†é¢‘è®¾ç½®æ˜¾ç¤º/éšè—
        function toggleVideoSettings() {
            const checkbox = document.getElementById('video_training_checkbox');
            const settings = document.getElementById('video_duration_settings');
            
            if (checkbox.checked) {
                settings.style.display = 'block';
                // æ·»åŠ å±•å¼€åŠ¨ç”»æ•ˆæœ
                settings.style.opacity = '0';
                settings.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    settings.style.transition = 'all 0.3s ease';
                    settings.style.opacity = '1';
                    settings.style.transform = 'translateY(0)';
                }, 10);
            } else {
                settings.style.transition = 'all 0.3s ease';
                settings.style.opacity = '0';
                settings.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    settings.style.display = 'none';
                }, 300);
            }
        }
        
        // Socket.IOå®¢æˆ·ç«¯è¿æ¥
        let socket = null;
        
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                addLogEntry({
                    level: 'success',
                    message: 'WebSocketè¿æ¥å·²å»ºç«‹ï¼Œå¼€å§‹æ¥æ”¶å®æ—¶æ—¥å¿—',
                    timestamp: new Date().toLocaleTimeString()
                });
            });
            
            socket.on('disconnect', function() {
                console.log('WebSocketè¿æ¥å·²æ–­å¼€');
                addLogEntry({
                    level: 'warning',
                    message: 'WebSocketè¿æ¥å·²æ–­å¼€',
                    timestamp: new Date().toLocaleTimeString()
                });
            });
            
            socket.on('log_message', function(logEntry) {
                addLogEntry(logEntry);
            });
            
            socket.on('connect_error', function(error) {
                console.error('WebSocketè¿æ¥é”™è¯¯:', error);
                addLogEntry({
                    level: 'error',
                    message: 'WebSocketè¿æ¥é”™è¯¯ï¼Œå›é€€åˆ°è½®è¯¢æ¨¡å¼',
                    timestamp: new Date().toLocaleTimeString()
                });
                // å¦‚æœWebSocketè¿æ¥å¤±è´¥ï¼Œå›é€€åˆ°è½®è¯¢æ¨¡å¼
                setInterval(fetchLogs, 2000);
            });
        }
        
        function toggleRecommendationTip() {
            const tip = document.getElementById('recommendation-tip');
            const icon = document.getElementById('tip-icon');
            
            if (tip.style.display === 'none' || tip.style.display === '') {
                tip.style.display = 'block';
                icon.textContent = 'ğŸ“–';
            } else {
                tip.style.display = 'none';
                icon.textContent = 'ğŸ’¡';
            }
        }
        
        function toggleLearningRateRecommendationTip() {
            const tip = document.getElementById('lr-recommendation-tip');
            const icon = document.getElementById('lr-tip-icon');
            
            if (tip.style.display === 'none' || tip.style.display === '') {
                tip.style.display = 'block';
                icon.textContent = 'ğŸ“–';
            } else {
                tip.style.display = 'none';
                icon.textContent = 'ğŸ’¡';
            }
        }
        
        function toggleChatGPTLearningRateRecommendationTip() {
            const tip = document.getElementById('chatgpt-lr-recommendation-tip');
            const icon = document.getElementById('chatgpt-lr-tip-icon');
            
            if (tip.style.display === 'none' || tip.style.display === '') {
                tip.style.display = 'block';
                icon.textContent = 'ğŸ“š';
            } else {
                tip.style.display = 'none';
                icon.textContent = 'ğŸ¤–';
            }
        }
        
        function toggleChatGPTRecommendationTip() {
            const tip = document.getElementById('chatgpt-recommendation-tip');
            const icon = document.getElementById('chatgpt-tip-icon');
            
            if (tip.style.display === 'none' || tip.style.display === '') {
                tip.style.display = 'block';
                icon.textContent = 'ğŸ“š';
            } else {
                tip.style.display = 'none';
                icon.textContent = 'ğŸ¤–';
            }
        }
        
        function setChatGPTRecommendedNumRepeats() {
            // è·å–å¿…è¦çš„å‚æ•°
            const datasetConfig = document.getElementById('dataset_config').value;
            const videoTrainingCheckbox = document.getElementById('video_training_checkbox');
            const isVideoTraining = videoTrainingCheckbox ? videoTrainingCheckbox.checked : false;
            const videoDurationInput = document.getElementById('video_duration');
            const videoDuration = videoDurationInput ? (parseFloat(videoDurationInput.value) || 5) : 5;
            const batchSizeInput = document.getElementById('batch_size');
            const batchSize = batchSizeInput ? (parseInt(batchSizeInput.value) || 8) : 8;
            const epochsInput = document.getElementById('max_train_epochs');
            const epochs = epochsInput ? (parseInt(epochsInput.value) || 10) : 10;
            
            console.log('setChatGPTRecommendedNumRepeats - datasetConfig:', datasetConfig);
            console.log('setChatGPTRecommendedNumRepeats - isVideoTraining:', isVideoTraining);
            console.log('setChatGPTRecommendedNumRepeats - videoDuration:', videoDuration);
            
            if (!datasetConfig) {
                addLogEntry({
                    level: 'warning',
                    message: 'è¯·å…ˆé€‰æ‹©æ•°æ®é›†é…ç½®æ–‡ä»¶',
                    timestamp: new Date().toLocaleTimeString()
                });
                return;
            }
            
            // è°ƒç”¨åç«¯APIè·å–ChatGPTæ¨èçš„num_repeatså€¼
            fetch('/api/calculate_chatgpt_recommended_num_repeats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dataset_config: datasetConfig,
                    task_type: currentTaskType,
                    is_video_training: isVideoTraining,
                    video_duration: videoDuration,
                    batch_size: batchSize,
                    epochs: epochs
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('ChatGPT APIå“åº”æ•°æ®:', data);
                if (data.success) {
                    // è®¾ç½®æ¨èçš„num_repeatså€¼åˆ°è¾“å…¥æ¡†
                    const numRepeatsInput = document.getElementById('num_repeats');
                    if (numRepeatsInput && data.recommended_repeats !== undefined) {
                        numRepeatsInput.value = data.recommended_repeats;
                    }
                    
                    let message;
                    const recommendedValue = data.recommended_repeats || 'N/A';
                    const datasetFiles = data.dataset_files || 'N/A';
                    const targetSteps = data.target_steps || 'N/A';
                    const stepsPerEpoch = data.steps_per_epoch || 'N/A';
                    
                    if (isVideoTraining) {
                        message = `ğŸ¤– ChatGPTæ¨èæ•°æ®é‡å¤æ¬¡æ•°: ${recommendedValue} (${currentTaskType.toUpperCase()}æ¨¡å¼, è§†é¢‘æ—¶é•¿: ${videoDuration}ç§’, æ•°æ®é›†: ${datasetFiles}ä¸ªæ–‡ä»¶, ç›®æ ‡æ­¥æ•°: ${targetSteps}, æ¯è½®æ­¥æ•°: ${stepsPerEpoch})`;
                    } else {
                        message = `ğŸ¤– ChatGPTæ¨èæ•°æ®é‡å¤æ¬¡æ•°: ${recommendedValue} (${currentTaskType.toUpperCase()}æ¨¡å¼, æ•°æ®é›†: ${datasetFiles}ä¸ªæ–‡ä»¶, ç›®æ ‡æ­¥æ•°: ${targetSteps}, æ¯è½®æ­¥æ•°: ${stepsPerEpoch})`;
                    }
                    
                    addLogEntry({
                        level: 'success',
                        message: message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'error',
                        message: 'âŒ ChatGPTæ¨èæ•°æ®é‡å¤æ¬¡æ•°è®¡ç®—å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'),
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'ChatGPTæ¨èæ•°æ®é‡å¤æ¬¡æ•°è®¡ç®—å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®é»˜è®¤ä»»åŠ¡ç±»å‹ä¸ºT2V
            selectTaskType('t2v');
            
            // æ·»åŠ å†…å­˜ä¼˜åŒ–ç­–ç•¥åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('memory_optimization_strategy').addEventListener('change', handleMemoryOptimizationChange);
            
            // åˆå§‹åŒ–å†…å­˜ä¼˜åŒ–ç­–ç•¥æ˜¾ç¤º
            handleMemoryOptimizationChange();
            
            // åŠ è½½é…ç½®
            loadConfig();
            
            // åˆå§‹åŒ–WebSocketè¿æ¥
            initializeSocket();
            
            addLogEntry({
                level: 'info',
                message: 'Wan2.2è®­ç»ƒç•Œé¢åˆå§‹åŒ–å®Œæˆ',
                timestamp: new Date().toLocaleTimeString()
            });
        });
    </script>
</body>
</html>