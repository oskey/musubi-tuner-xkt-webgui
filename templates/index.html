<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen-Image Web UI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        .config-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .training-actions {
            grid-column: 1 / -1;
        }
        
        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(79, 172, 254, 0.1);
        }
        
        .panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #4facfe;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            cursor: help;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .config-section {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .section-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.2s ease;
        }
        
        .section-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        
        .toggle-icon {
            font-size: 12px;
            transition: transform 0.2s ease;
        }
        
        .section-content {
            padding: 16px;
            background: #fff;
            transition: max-height 0.3s ease, padding 0.3s ease;
            max-height: 2000px;
            overflow: hidden;
        }
        
        .section-content.collapsed {
            max-height: 0;
            padding: 0 16px;
        }
        
        .collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .log-container {
            grid-column: 1 / -1;
            background: #1e1e1e;
            border-radius: 15px;
            padding: 20px;
            height: 600px;
            min-height: 600px;
            font-family: 'Consolas', 'Monaco', monospace;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        #log-output {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #2d2d2d;
            border-radius: 8px;
            border: 1px solid #444;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .log-info { color: #61dafb; }
        .log-success { color: #98fb98; background: rgba(152, 251, 152, 0.1); }
        .log-error { color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }
        .log-warning { color: #ffa500; background: rgba(255, 165, 0, 0.1); }
        .log-output { color: #d4d4d4; }
        .log-debug { color: #888; }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-idle { background: #95a5a6; }
        .status-running { background: #f39c12; animation: pulse 1.5s infinite; }
        .status-success { background: #27ae60; }
        .status-error { background: #e74c3c; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e1e8ed;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ Qwen-Image Web UI</h1>
            <p>ç°ä»£åŒ–çš„Qwen-Imageè®­ç»ƒç®¡ç†ç•Œé¢</p>
        </div>
        
        <div class="main-content">
            <!-- æ—¥å¿—é¢æ¿ -->
            <div class="log-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="color: #61dafb; margin: 0;">ğŸ“‹ å®æ—¶æ—¥å¿—</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="clearLogs()" class="btn" style="padding: 5px 10px; font-size: 12px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">ğŸ—‘ï¸ æ¸…ç†æ—¥å¿—</button>
                        <button onclick="scrollToBottom()" class="btn" style="padding: 5px 10px; font-size: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">æ»šåŠ¨åˆ°åº•éƒ¨</button>
                    </div>
                </div>
                <div id="log-output"></div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
            <div class="operation-panel" style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="color: #61dafb; margin: 0;">ğŸ® è®­ç»ƒæ§åˆ¶</h2>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="status-indicator" id="status-indicator"></div>
                        <span id="status-text" style="color: #d4d4d4; font-size: 14px;">å°±ç»ª</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                    <button onclick="startTensorBoard()" class="btn" id="tensorboard-btn">ğŸ“Š å¯åŠ¨ TensorBoard</button>
                    <button onclick="startCacheVAE()" class="btn" id="cache-vae-btn">ğŸ”„ é¢„ç¼“å­˜ VAE Latents</button>
                    <button onclick="startCacheTextEncoder()" class="btn" id="cache-te-btn">ğŸ“ é¢„ç¼“å­˜æ–‡æœ¬ç¼–ç å™¨è¾“å‡º</button>
                    <button onclick="startTraining()" class="btn" id="train-btn">ğŸ¯ å¼€å§‹è®­ç»ƒ</button>
                    <button onclick="stopTraining()" class="btn btn-danger" id="stop-btn" disabled>â¹ï¸ åœæ­¢è®­ç»ƒ</button>
                </div>
            </div>
            
            <!-- è™šæ‹Ÿç¯å¢ƒé…ç½® -->
            <div class="panel" style="margin-bottom: 20px;">
                <h2>ğŸ è¿è¡Œç¯å¢ƒ</h2>
                <div class="form-group">
                    <label title="å¯ç”¨è™šæ‹Ÿç¯å¢ƒå¯ä»¥ç¡®ä¿è®­ç»ƒè¿‡ç¨‹ä½¿ç”¨æŒ‡å®šçš„Pythonç¯å¢ƒï¼Œé¿å…ä¾èµ–å†²çªã€‚">å¯ç”¨è™šæ‹Ÿç¯å¢ƒ</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="enable_venv" checked title="å¯ç”¨è™šæ‹Ÿç¯å¢ƒå¯ä»¥ç¡®ä¿è®­ç»ƒè¿‡ç¨‹ä½¿ç”¨æŒ‡å®šçš„Pythonç¯å¢ƒï¼Œé¿å…ä¾èµ–å†²çªã€‚">
                        <span style="color: #666; font-size: 14px;">ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒæ‰§è¡Œè®­ç»ƒå‘½ä»¤</span>
                    </div>
                </div>
                
                <div class="form-group" id="venv_path_group">
                    <label title="è™šæ‹Ÿç¯å¢ƒçš„Pythonå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ã€‚é€šå¸¸ä½äºè™šæ‹Ÿç¯å¢ƒçš„Scriptsç›®å½•ä¸‹ã€‚">è™šæ‹Ÿç¯å¢ƒPythonè·¯å¾„</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="venv_python_path" title="è™šæ‹Ÿç¯å¢ƒçš„Pythonå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ã€‚é€šå¸¸ä½äºè™šæ‹Ÿç¯å¢ƒçš„Scriptsç›®å½•ä¸‹ã€‚" style="flex: 1;">
                        <button type="button" onclick="selectFolder('venv_python_path')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ è™šæ‹Ÿç¯å¢ƒçš„Scriptsç›®å½•è·¯å¾„</small>
                </div>
            </div>
            
            <!-- é…ç½®å¸ƒå±€ -->
            <div class="config-layout">
                <!-- å·¦ä¾§ï¼šåŸºç¡€é…ç½® -->
                <div class="panel">
                    <h2>ğŸ“ åŸºç¡€é…ç½®</h2>
                        <div class="form-group">
                            <label title="TOMLæ ¼å¼çš„æ•°æ®é›†é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰äº†è®­ç»ƒæ•°æ®çš„è·¯å¾„ã€æ ‡ç­¾å’Œé¢„å¤„ç†å‚æ•°ã€‚è¯¥æ–‡ä»¶æŒ‡å®šäº†å›¾ç‰‡ä½ç½®ã€å¯¹åº”çš„æ–‡æœ¬æè¿°ã€é‡å¤æ¬¡æ•°ç­‰è®­ç»ƒæ‰€éœ€çš„æ‰€æœ‰æ•°æ®ä¿¡æ¯ã€‚">æ•°æ®é›†é…ç½®æ–‡ä»¶ (dataset_config)</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="dataset_config" title="TOMLæ ¼å¼çš„æ•°æ®é›†é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰äº†è®­ç»ƒæ•°æ®çš„è·¯å¾„ã€æ ‡ç­¾å’Œé¢„å¤„ç†å‚æ•°ã€‚è¯¥æ–‡ä»¶æŒ‡å®šäº†å›¾ç‰‡ä½ç½®ã€å¯¹åº”çš„æ–‡æœ¬æè¿°ã€é‡å¤æ¬¡æ•°ç­‰è®­ç»ƒæ‰€éœ€çš„æ‰€æœ‰æ•°æ®ä¿¡æ¯ã€‚" style="flex: 1;">
                                <button type="button" onclick="selectFile('dataset_config', '.toml')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                            </div>
                            <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ åŒ…å«è®­ç»ƒæ•°æ®è·¯å¾„å’Œæ ‡ç­¾çš„TOMLé…ç½®æ–‡ä»¶</small>
                        </div>
                        
                        <div class="form-group">
                            <label title="é¢„è®­ç»ƒçš„Qwen-Imageæ‰©æ•£æ¨¡å‹è·¯å¾„ã€‚è¿™æ˜¯è®­ç»ƒçš„åŸºç¡€æ¨¡å‹ï¼Œé€šå¸¸æ˜¯ä»Hugging Faceä¸‹è½½çš„æ¨¡å‹æ–‡ä»¶æˆ–æœ¬åœ°ä¿å­˜çš„æ¨¡å‹è·¯å¾„ã€‚">é¢„è®­ç»ƒæ¨¡å‹è·¯å¾„ (pretrained_model_name_or_path)</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="pretrained_model_name_or_path" title="é¢„è®­ç»ƒçš„Qwen-Imageæ‰©æ•£æ¨¡å‹è·¯å¾„ã€‚è¿™æ˜¯è®­ç»ƒçš„åŸºç¡€æ¨¡å‹ï¼Œé€šå¸¸æ˜¯ä»Hugging Faceä¸‹è½½çš„æ¨¡å‹æ–‡ä»¶æˆ–æœ¬åœ°ä¿å­˜çš„æ¨¡å‹è·¯å¾„ã€‚" style="flex: 1;">
                                <button type="button" onclick="selectFile('pretrained_model_name_or_path', '.safetensors')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                            </div>
                            <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ Qwenå›¾åƒç”Ÿæˆçš„åŸºç¡€æ¨¡å‹æ–‡ä»¶</small>
                        </div>
                        
                        <div class="form-group">
                            <label title="Qwenæ–‡æœ¬ç¼–ç å™¨æ¨¡å‹è·¯å¾„ã€‚ç”¨äºå°†æ–‡æœ¬æç¤ºç¼–ç ä¸ºå‘é‡è¡¨ç¤ºï¼Œæ˜¯æ–‡æœ¬åˆ°å›¾åƒç”Ÿæˆçš„å…³é”®ç»„ä»¶ã€‚">æ–‡æœ¬ç¼–ç å™¨è·¯å¾„ (text_encoder_path)</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="text_encoder_path" title="Qwenæ–‡æœ¬ç¼–ç å™¨æ¨¡å‹è·¯å¾„ã€‚ç”¨äºå°†æ–‡æœ¬æç¤ºç¼–ç ä¸ºå‘é‡è¡¨ç¤ºï¼Œæ˜¯æ–‡æœ¬åˆ°å›¾åƒç”Ÿæˆçš„å…³é”®ç»„ä»¶ã€‚" style="flex: 1;">
                                <button type="button" onclick="selectFile('text_encoder_path', '.safetensors')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                            </div>
                            <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å°†æ–‡æœ¬æç¤ºè½¬æ¢ä¸ºå‘é‡è¡¨ç¤ºçš„æ¨¡å‹</small>
                        </div>
                        
                        <div class="form-group">
                            <label title="å˜åˆ†è‡ªç¼–ç å™¨(VAE)æ¨¡å‹è·¯å¾„ã€‚VAEè´Ÿè´£åœ¨åƒç´ ç©ºé—´å’Œæ½œåœ¨ç©ºé—´ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼Œæ˜¯æ‰©æ•£æ¨¡å‹è®­ç»ƒçš„é‡è¦ç»„ä»¶ã€‚">VAEæ¨¡å‹è·¯å¾„ (vae_path)</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="vae_path" title="å˜åˆ†è‡ªç¼–ç å™¨(VAE)æ¨¡å‹è·¯å¾„ã€‚VAEè´Ÿè´£åœ¨åƒç´ ç©ºé—´å’Œæ½œåœ¨ç©ºé—´ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼Œæ˜¯æ‰©æ•£æ¨¡å‹è®­ç»ƒçš„é‡è¦ç»„ä»¶ã€‚" style="flex: 1;">
                                <button type="button" onclick="selectFile('vae_path', '.safetensors')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                            </div>
                            <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ è´Ÿè´£å›¾åƒçš„ç¼–ç å’Œè§£ç å¤„ç†</small>
                        </div>
                        
                        <div class="form-group">
                            <label title="è¾“å‡ºç›®å½•è·¯å¾„ã€‚è®­ç»ƒå®Œæˆçš„LoRAæ¨¡å‹å°†ä¿å­˜åˆ°æ­¤ç›®å½•ã€‚">è¾“å‡ºç›®å½• (output_dir)</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="output_dir" title="è¾“å‡ºç›®å½•è·¯å¾„ã€‚è®­ç»ƒå®Œæˆçš„LoRAæ¨¡å‹å°†ä¿å­˜åˆ°æ­¤ç›®å½•ã€‚" style="flex: 1;">
                                <button type="button" onclick="selectFolder('output_dir')" class="btn" style="padding: 8px 12px; font-size: 12px;">ğŸ“ é€‰æ‹©</button>
                            </div>
                            <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ è®­ç»ƒå®Œæˆçš„æ¨¡å‹æ–‡ä»¶ä¿å­˜ä½ç½®</small>
                        </div>
                        
                        <div class="form-group">
                            <label title="è¾“å‡ºæ¨¡å‹åç§°ã€‚è®­ç»ƒå®Œæˆåä¿å­˜çš„LoRAæ¨¡å‹æ–‡ä»¶åå‰ç¼€ã€‚">è¾“å‡ºæ¨¡å‹åç§° (output_name)</label>
                            <input type="text" id="output_name" title="è¾“å‡ºæ¨¡å‹åç§°ã€‚è®­ç»ƒå®Œæˆåä¿å­˜çš„LoRAæ¨¡å‹æ–‡ä»¶åå‰ç¼€ã€‚" style="width: 100%;">
                            <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ ä¿å­˜çš„LoRAæ¨¡å‹æ–‡ä»¶åå‰ç¼€</small>
                        </div>
                </div>
                
                <!-- å³ä¾§è®­ç»ƒå‚æ•°é¢æ¿ -->
                <div class="panel">
                    <h2>ğŸ“ æ ¸å¿ƒè®­ç»ƒå‚æ•° (å®˜æ–¹é»˜è®¤)</h2>
                    
                        <!-- æ ¸å¿ƒå‚æ•°ï¼šè®­ç»ƒæ‰¹æ¬¡å¤§å° -->
                        <div class="form-group">
                            <label title="è®­ç»ƒæ‰¹æ¬¡å¤§å° - ä»TOMLé…ç½®æ–‡ä»¶è¯»å–ã€‚">è®­ç»ƒæ‰¹æ¬¡å¤§å° (batch_size)</label>
                            <input type="number" id="batch_size" min="1" max="32" title="è®­ç»ƒæ‰¹æ¬¡å¤§å° - ä»TOMLé…ç½®æ–‡ä»¶è¯»å–ã€‚">
                            <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ ä»TOMLæ–‡ä»¶çš„[general]éƒ¨åˆ†è¯»å–ï¼Œå½±å“æ˜¾å­˜ä½¿ç”¨å’Œè®­ç»ƒé€Ÿåº¦</small>
                        </div>
                        
                        <!-- æ ¸å¿ƒå‚æ•°ï¼šæ•°æ®é‡å¤æ¬¡æ•° -->
                        <div class="form-group">
                            <label title="æ•°æ®é‡å¤æ¬¡æ•° - ä»TOMLé…ç½®æ–‡ä»¶è¯»å–ã€‚æ¨èå€¼20~30ï¼ˆå›¾ç‰‡è¾ƒå°‘æ—¶ï¼‰ï¼Œæ¨¡å‹èƒ½æ›´å®¹æ˜“è®°ä½ç‰¹å¾ã€‚">æ•°æ®é‡å¤æ¬¡æ•° (num_repeats)</label>
                            <input type="number" id="num_repeats" min="1" max="100" title="æ•°æ®é‡å¤æ¬¡æ•° - ä»TOMLé…ç½®æ–‡ä»¶è¯»å–ã€‚æ¨èå€¼20~30ï¼ˆå›¾ç‰‡è¾ƒå°‘æ—¶ï¼‰ï¼Œæ¨¡å‹èƒ½æ›´å®¹æ˜“è®°ä½ç‰¹å¾ã€‚">
                            <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ ä»TOMLæ–‡ä»¶çš„[[datasets]]éƒ¨åˆ†è¯»å–ã€‚æ¨èå€¼20~30ï¼ˆå›¾ç‰‡è¾ƒå°‘æ—¶ï¼‰ï¼Œæ•°æ®å°‘æ—¶æé«˜é‡å¤æ¬¡æ•°å¯æœ‰æ•ˆæå‡è®­ç»ƒæ•ˆæœ</small>
                        </div>
                        
                        <!-- æ ¸å¿ƒå‚æ•°ï¼šå­¦ä¹ ç‡ -->
                        <div class="form-group">
                            <label title="å­¦ä¹ ç‡ - æ¨èå€¼ï¼š5e-05ã€‚æ§åˆ¶æ¨¡å‹å‚æ•°æ›´æ–°çš„æ­¥é•¿ï¼Œæ˜¯è®­ç»ƒä¸­æœ€é‡è¦çš„è¶…å‚æ•°ã€‚æ•°æ®å°‘æ—¶ï¼Œè¿‡é«˜ä¼šå¯¼è‡´è¿‡æ‹Ÿåˆï¼Œè¿‡ä½åˆéš¾å­¦åˆ°ã€‚">å­¦ä¹ ç‡ (learning_rate)</label>
                <input type="text" id="learning_rate" title="å­¦ä¹ ç‡ - æ¨èå€¼ï¼š5e-05ã€‚æ§åˆ¶æ¨¡å‹å‚æ•°æ›´æ–°çš„æ­¥é•¿ï¼Œæ˜¯è®­ç»ƒä¸­æœ€é‡è¦çš„è¶…å‚æ•°ã€‚æ•°æ®å°‘æ—¶ï¼Œè¿‡é«˜ä¼šå¯¼è‡´è¿‡æ‹Ÿåˆï¼Œè¿‡ä½åˆéš¾å­¦åˆ°ã€‚">
                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èåŒºé—´ï¼š2e-4 ~ 1e-4ï¼ˆè§¦å‘å®¹æ˜“ï¼Œæ•ˆæœç«‹ç«¿è§å½±ï¼‰ã€‚æ•°æ®å°‘æ—¶ï¼Œè¿‡é«˜ä¼šå¯¼è‡´è¿‡æ‹Ÿåˆï¼Œè¿‡ä½åˆéš¾å­¦åˆ°</small>
                        </div>
                        
                        <!-- æ ¸å¿ƒå‚æ•°ï¼šLoRAç»´åº¦ -->
                        <div class="form-group">
                            <label title="LoRAç»´åº¦ - æ¨èå€¼ï¼š8ã€‚æ§åˆ¶ä½ç§©çŸ©é˜µçš„ç»´åº¦ï¼Œå½±å“æ¨¡å‹å®¹é‡å’Œè®­ç»ƒæ•ˆæœã€‚å¦‚æœåªè®­ç»ƒå•ä¸€è§’è‰²/é£æ ¼ï¼Œ64æ›´åˆé€‚ã€‚">LoRAç»´åº¦ (network_dim)</label>
                <input type="number" id="network_dim" min="4" max="128" title="LoRAç»´åº¦ - æ¨èå€¼ï¼š8ã€‚æ§åˆ¶ä½ç§©çŸ©é˜µçš„ç»´åº¦ï¼Œå½±å“æ¨¡å‹å®¹é‡å’Œè®­ç»ƒæ•ˆæœã€‚å¦‚æœåªè®­ç»ƒå•ä¸€è§’è‰²/é£æ ¼ï¼Œ64æ›´åˆé€‚ã€‚">
                <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èå€¼ï¼š8ï¼Œå¹³è¡¡æ¨¡å‹å®¹é‡å’Œè®­ç»ƒæ•ˆç‡ã€‚å¦‚æœåªè®­ç»ƒå•ä¸€è§’è‰²/é£æ ¼ï¼Œ64æ›´åˆé€‚</small>
                        </div>
                        
                        <!-- æ ¸å¿ƒå‚æ•°ï¼šè®­ç»ƒè½®æ•° -->
                        <div class="form-group">
                            <label title="æœ€å¤§è®­ç»ƒè½®æ•° - æ¨èå€¼ï¼š10ã€‚æ§åˆ¶è®­ç»ƒçš„æ€»è½®æ•°ã€‚æ•°æ®å°‘æ—¶ï¼Œæé«˜è½®æ•°å¯ä»¥æœ‰æ•ˆæå‡è®­ç»ƒæ•ˆæœã€‚">æœ€å¤§è®­ç»ƒè½®æ•° (max_train_epochs)</label>
                            <input type="number" id="max_train_epochs" min="1" max="100" title="æœ€å¤§è®­ç»ƒè½®æ•° - æ¨èå€¼ï¼š10ã€‚æ§åˆ¶è®­ç»ƒçš„æ€»è½®æ•°ã€‚æ•°æ®å°‘æ—¶ï¼Œæé«˜è½®æ•°å¯ä»¥æœ‰æ•ˆæå‡è®­ç»ƒæ•ˆæœã€‚">
                            <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èå€¼ï¼š10ï¼Œé€‚åˆå¿«é€Ÿè®­ç»ƒå’Œæµ‹è¯•ã€‚æ•°æ®å°‘æ—¶ï¼Œæé«˜è½®æ•°å¯ä»¥æœ‰æ•ˆæå‡è®­ç»ƒæ•ˆæœ</small>
                        </div>
                        
                        
                        <!-- é«˜çº§å‚æ•°æŠ˜å åŒºåŸŸ -->
                        <div class="collapsible-section">
                            <button type="button" class="collapsible-header" onclick="toggleSection('advanced-params')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%); border: none; border-radius: 8px; color: #61dafb; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: space-between; margin: 15px 0;">
                                <span>âš™ï¸ é«˜çº§å‚æ•° (å¯é€‰)</span>
                                <span class="toggle-icon" id="advanced-toggle-icon">â–¼</span>
                            </button>
                            <div class="collapsible-content" id="advanced-params" style="display: none; padding: 10px; border: 1px solid #4a5568; border-radius: 8px; margin-top: 10px;">
                                
                                <!-- ä¿å­˜é—´éš” -->
                                <div class="form-group">
                                    <label title="æ¯Nè½®ä¿å­˜ä¸€æ¬¡ - å®˜æ–¹é»˜è®¤å€¼ï¼š1ã€‚æ§åˆ¶æ¨¡å‹æ£€æŸ¥ç‚¹çš„ä¿å­˜é¢‘ç‡ã€‚">æ¯Nè½®ä¿å­˜ (save_every_n_epochs)</label>
                                    <input type="number" id="save_every_n_epochs" min="1" max="10" title="æ¯Nè½®ä¿å­˜ä¸€æ¬¡ - å®˜æ–¹é»˜è®¤å€¼ï¼š1ã€‚æ§åˆ¶æ¨¡å‹æ£€æŸ¥ç‚¹çš„ä¿å­˜é¢‘ç‡ã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å®˜æ–¹æ¨èå€¼ï¼š1ï¼Œæ¯è½®éƒ½ä¿å­˜ä¾¿äºé€‰æ‹©æœ€ä½³æ£€æŸ¥ç‚¹</small>
                                </div>
                                
                                <!-- éšæœºç§å­ -->
                                <div class="form-group">
                                    <label title="éšæœºç§å­ - å®˜æ–¹é»˜è®¤å€¼ï¼š42ã€‚ç¡®ä¿è®­ç»ƒç»“æœå¯å¤ç°ã€‚">éšæœºç§å­ (seed)</label>
                                    <input type="number" id="seed" min="0" title="éšæœºç§å­ - å®˜æ–¹é»˜è®¤å€¼ï¼š42ã€‚ç¡®ä¿è®­ç»ƒç»“æœå¯å¤ç°ã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å®˜æ–¹æ¨èå€¼ï¼š42ï¼Œå›ºå®šç§å­ç¡®ä¿ç»“æœå¯å¤ç°</small>
                                </div>
                                
                                <!-- æ··åˆç²¾åº¦ -->
                                <div class="form-group">
                                    <label title="æ··åˆç²¾åº¦è®­ç»ƒ - å®˜æ–¹é»˜è®¤å€¼ï¼šbf16ã€‚èŠ‚çœæ˜¾å­˜ä¸”ä¿æŒè®­ç»ƒç²¾åº¦ã€‚">æ··åˆç²¾åº¦ (mixed_precision)</label>
                                    <select id="mixed_precision" title="æ··åˆç²¾åº¦è®­ç»ƒ - å®˜æ–¹é»˜è®¤å€¼ï¼šbf16ã€‚èŠ‚çœæ˜¾å­˜ä¸”ä¿æŒè®­ç»ƒç²¾åº¦ã€‚">
                                        <option value="bf16" selected>bf16</option>
                                        <option value="fp16">fp16</option>
                                        <option value="no">no</option>
                                    </select>
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å®˜æ–¹æ¨èå€¼ï¼šbf16ï¼Œæœ€ä½³æ€§èƒ½å’Œç¨³å®šæ€§å¹³è¡¡</small>
                                </div>
                                
                                <!-- æ‰¹æ¬¡å’Œç´¯ç§¯å‚æ•° -->
                                <div class="form-group">
                                    <label title="æ¢¯åº¦ç´¯ç§¯æ­¥æ•°ã€‚æ¨¡æ‹Ÿæ›´å¤§æ‰¹æ¬¡å¤§å°è€Œä¸å¢åŠ æ˜¾å­˜å ç”¨ã€‚">æ¢¯åº¦ç´¯ç§¯æ­¥æ•° (gradient_accumulation_steps)</label>
                                    <input type="number" id="gradient_accumulation_steps" min="1" title="æ¢¯åº¦ç´¯ç§¯æ­¥æ•°ã€‚æ¨¡æ‹Ÿæ›´å¤§æ‰¹æ¬¡å¤§å°è€Œä¸å¢åŠ æ˜¾å­˜å ç”¨ã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å»ºè®®å€¼ï¼š1-4ï¼Œç”¨äºæ¨¡æ‹Ÿæ›´å¤§æ‰¹æ¬¡</small>
                                </div>
                                
                                <!-- LoRA Alphaå‚æ•° -->
                                <div class="form-group">
                                    <label title="LoRA Alphaå€¼ã€‚é€šå¸¸è®¾ç½®ä¸ºç½‘ç»œç»´åº¦çš„ä¸€åŠæˆ–ç›¸ç­‰ã€‚">LoRA Alpha (network_alpha)</label>
                                    <input type="number" id="network_alpha" min="1" title="LoRA Alphaå€¼ã€‚é€šå¸¸è®¾ç½®ä¸ºç½‘ç»œç»´åº¦çš„ä¸€åŠæˆ–ç›¸ç­‰ã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å»ºè®®å€¼ï¼šé€šå¸¸ä¸ºç»´åº¦çš„ä¸€åŠ</small>
                                </div>
                                
                                <!-- ä¼˜åŒ–å™¨é€‰æ‹© -->
                                <div class="form-group">
                                    <label title="ä¼˜åŒ–å™¨ç±»å‹ - å®˜æ–¹é»˜è®¤ï¼šadamw8bitã€‚">ä¼˜åŒ–å™¨ (optimizer_type)</label>
                                    <select id="optimizer_type" title="ä¼˜åŒ–å™¨ç±»å‹ - å®˜æ–¹é»˜è®¤ï¼šadamw8bitã€‚">
                                        <option value="adamw8bit" selected>adamw8bit</option>
                                        <option value="AdamW">AdamW</option>
                                        <option value="Lion">Lion</option>
                                        <option value="SGDNesterov">SGDNesterov</option>
                                        <option value="Adafactor">Adafactor</option>
                                    </select>
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å®˜æ–¹æ¨èå€¼ï¼šadamw8bitï¼ŒèŠ‚çœå†…å­˜</small>
                                </div>
                                
                                <!-- æ—¶é—´æ­¥é‡‡æ · -->
                                <div class="form-group">
                                    <label title="æ—¶é—´æ­¥é‡‡æ ·æ–¹æ³• - å®˜æ–¹é»˜è®¤ï¼šshiftã€‚">æ—¶é—´æ­¥é‡‡æ · (timestep_sampling)</label>
                                    <select id="timestep_sampling" title="æ—¶é—´æ­¥é‡‡æ ·æ–¹æ³• - å®˜æ–¹é»˜è®¤ï¼šshiftã€‚">
                                        <option value="shift" selected>shift</option>
                                        <option value="uniform">uniform</option>
                                        <option value="sigma">sigma</option>
                                        <option value="sigmoid">sigmoid</option>
                                    </select>
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å®˜æ–¹æ¨èå€¼ï¼šshiftï¼Œé€‚ç”¨äºQwenæ¨¡å‹</small>
                                </div>
                                
                                <!-- æƒé‡æ–¹æ¡ˆ -->
                                <div class="form-group">
                                    <label title="æƒé‡æ–¹æ¡ˆ - å®˜æ–¹é»˜è®¤ï¼šnoneã€‚">æƒé‡æ–¹æ¡ˆ (weighting_scheme)</label>
                                    <select id="weighting_scheme" title="æƒé‡æ–¹æ¡ˆ - å®˜æ–¹é»˜è®¤ï¼šnoneã€‚">
                                        <option value="none" selected>none</option>
                                        <option value="logit_normal">logit_normal</option>
                                        <option value="mode">mode</option>
                                        <option value="cosmap">cosmap</option>
                                    </select>
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å®˜æ–¹æ¨èå€¼ï¼šnoneï¼Œä¿æŒé»˜è®¤</small>
                                </div>
                                
                                <!-- ç¦»æ•£æµåç§» -->
                                <div class="form-group">
                                    <label title="ç¦»æ•£æµåç§» - å®˜æ–¹é»˜è®¤ï¼š2.2ã€‚">ç¦»æ•£æµåç§» (discrete_flow_shift)</label>
                                    <input type="number" id="discrete_flow_shift" step="0.1" title="ç¦»æ•£æµåç§» - å®˜æ–¹é»˜è®¤ï¼š2.2ã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å®˜æ–¹æ¨èå€¼ï¼š2.2ï¼ŒQwenæ¨¡å‹ä¸“ç”¨å‚æ•°</small>
                                </div>
                                
                                <!-- æ•°æ®åŠ è½½å™¨å·¥ä½œè¿›ç¨‹æ•° -->
                                <div class="form-group">
                                    <label title="æ•°æ®åŠ è½½å™¨å·¥ä½œè¿›ç¨‹æ•° - å®˜æ–¹é»˜è®¤ï¼š2ã€‚">æ•°æ®åŠ è½½å™¨å·¥ä½œè¿›ç¨‹æ•° (max_data_loader_n_workers)</label>
                                    <input type="number" id="max_data_loader_n_workers" min="0" title="æ•°æ®åŠ è½½å™¨å·¥ä½œè¿›ç¨‹æ•° - å®˜æ–¹é»˜è®¤ï¼š2ã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å®˜æ–¹æ¨èå€¼ï¼š2ï¼Œå¹³è¡¡æ€§èƒ½å’Œèµ„æºå ç”¨</small>
                                </div>
                                
                                
                                <!-- ç½‘ç»œæ¨¡å— -->
                                <div class="form-group">
                                    <label title="ç½‘ç»œæ¨¡å— - å®˜æ–¹é»˜è®¤ï¼šnetworks.lora_qwen_imageã€‚">ç½‘ç»œæ¨¡å— (network_module)</label>
                                    <input type="text" id="network_module" title="ç½‘ç»œæ¨¡å— - å®˜æ–¹é»˜è®¤ï¼šnetworks.lora_qwen_imageã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å®˜æ–¹æ¨èå€¼ï¼šnetworks.lora_qwen_imageï¼ŒQwenä¸“ç”¨LoRAæ¨¡å—</small>
                                </div>
                                
                                <!-- ç½‘ç»œé¢å¤–å‚æ•° -->
                                <div class="form-group">
                                    <label title="LoRAç½‘ç»œé¢å¤–å‚æ•° - ç”¨äºé…ç½®LoRA+ç­‰é«˜çº§åŠŸèƒ½ã€‚">ç½‘ç»œé¢å¤–å‚æ•° (network_args)</label>
                                    <input type="text" id="network_args" title="LoRAç½‘ç»œé¢å¤–å‚æ•° - ç”¨äºé…ç½®LoRA+ç­‰é«˜çº§åŠŸèƒ½ã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èå€¼ï¼šloraplus_lr_ratio=4ï¼Œå¦‚æœä½ æƒ³è®©LoRAæ›´å®¹æ˜“è§¦å‘ï¼Œæé«˜è¯¥å€¼ã€‚ä¸ºLoRAçš„Aå’ŒBçŸ©é˜µè®¾ç½®ä¸åŒå­¦ä¹ ç‡æ¯”ä¾‹</small>
                                </div>
                                
                                <!-- å¼€å…³é€‰é¡¹ -->
                                <div class="form-group">
                                    <label title="å¯ç”¨SDPAæ³¨æ„åŠ›æœºåˆ¶ - å®˜æ–¹é»˜è®¤ï¼šå¼€å¯ã€‚">SDPA (sdpa)</label>
                                    <input type="checkbox" id="sdpa" checked title="å¯ç”¨SDPAæ³¨æ„åŠ›æœºåˆ¶ - å®˜æ–¹é»˜è®¤ï¼šå¼€å¯ã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å®˜æ–¹æ¨èï¼šå¼€å¯ï¼Œæå‡è®­ç»ƒæ€§èƒ½</small>
                                </div>
                                
                                <div class="form-group">
                                    <label title="å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹ - å®˜æ–¹é»˜è®¤ï¼šå¼€å¯ã€‚">æ¢¯åº¦æ£€æŸ¥ç‚¹ (gradient_checkpointing)</label>
                                    <input type="checkbox" id="gradient_checkpointing" checked title="å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹ - å®˜æ–¹é»˜è®¤ï¼šå¼€å¯ã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å®˜æ–¹æ¨èï¼šå¼€å¯ï¼ŒèŠ‚çœæ˜¾å­˜</small>
                                </div>
                                
                                <div class="form-group">
                                    <label title="æŒä¹…åŒ–æ•°æ®åŠ è½½å™¨ - å®˜æ–¹é»˜è®¤ï¼šå¼€å¯ã€‚">æŒä¹…åŒ–æ•°æ®åŠ è½½å™¨ (persistent_data_loader_workers)</label>
                                    <input type="checkbox" id="persistent_data_loader_workers" checked title="æŒä¹…åŒ–æ•°æ®åŠ è½½å™¨ - å®˜æ–¹é»˜è®¤ï¼šå¼€å¯ã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å®˜æ–¹æ¨èï¼šå¼€å¯ï¼Œæå‡æ•°æ®åŠ è½½æ•ˆç‡</small>
                                </div>
                                
                                <!-- FP8é‡åŒ–é€‰é¡¹ -->
                                <div class="form-group">
                                    <label title="å¯ç”¨FP8åŸºç¡€æ¨¡å‹é‡åŒ– - èŠ‚çœæ˜¾å­˜ï¼Œæå‡è®­ç»ƒæ•ˆç‡ã€‚">FP8åŸºç¡€é‡åŒ– (fp8_base)</label>
                                    <input type="checkbox" id="fp8_base" checked title="å¯ç”¨FP8åŸºç¡€æ¨¡å‹é‡åŒ– - èŠ‚çœæ˜¾å­˜ï¼Œæå‡è®­ç»ƒæ•ˆç‡ã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èï¼šå¼€å¯ï¼Œæ˜¾è‘—èŠ‚çœæ˜¾å­˜å ç”¨</small>
                                </div>
                                
                                <div class="form-group">
                                    <label title="å¯ç”¨FP8ç¼©æ”¾é‡åŒ– - è¿›ä¸€æ­¥ä¼˜åŒ–æ˜¾å­˜ä½¿ç”¨ã€‚">FP8ç¼©æ”¾é‡åŒ– (fp8_scaled)</label>
                                    <input type="checkbox" id="fp8_scaled" checked title="å¯ç”¨FP8ç¼©æ”¾é‡åŒ– - è¿›ä¸€æ­¥ä¼˜åŒ–æ˜¾å­˜ä½¿ç”¨ã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èï¼šå¼€å¯ï¼Œä¸FP8åŸºç¡€é‡åŒ–é…åˆä½¿ç”¨</small>
                                </div>
                                
                                <!-- å†…å­˜ä¼˜åŒ–å‚æ•° -->
                                <div class="form-group">
                                    <label title="äº¤æ¢åˆ°CPUçš„Transformerå—æ•°é‡ - èŠ‚çœæ˜¾å­˜ï¼Œä½†ä¼šå½±å“è®­ç»ƒé€Ÿåº¦ã€‚">CPUäº¤æ¢å—æ•° (blocks_to_swap)</label>
                                    <input type="number" id="blocks_to_swap" min="0" max="50" title="äº¤æ¢åˆ°CPUçš„Transformerå—æ•°é‡ - èŠ‚çœæ˜¾å­˜ï¼Œä½†ä¼šå½±å“è®­ç»ƒé€Ÿåº¦ã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ æ¨èå€¼ï¼š20ï¼Œå¹³è¡¡æ˜¾å­˜èŠ‚çœå’Œè®­ç»ƒé€Ÿåº¦</small>
                                </div>
                                
                                <!-- TensorBoardæ—¥å¿—é…ç½® -->
                                <div class="form-group">
                                    <label title="æ—¥å¿—ç›®å½•è·¯å¾„ - å­˜å‚¨è®­ç»ƒæ—¥å¿—å’ŒTensorBoardæ•°æ®ã€‚">æ—¥å¿—ç›®å½• (logging_dir)</label>
                                    <input type="text" id="logging_dir" title="æ—¥å¿—ç›®å½•è·¯å¾„ - å­˜å‚¨è®­ç»ƒæ—¥å¿—å’ŒTensorBoardæ•°æ®ã€‚">
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å»ºè®®å€¼ï¼š./logsï¼Œç”¨äºå­˜å‚¨TensorBoardæ—¥å¿—</small>
                                </div>
                                
                                <div class="form-group">
                                    <label title="æ—¥å¿—è®°å½•å·¥å…· - å®˜æ–¹é»˜è®¤ï¼štensorboardã€‚">æ—¥å¿—å·¥å…· (log_with)</label>
                                    <select id="log_with" title="æ—¥å¿—è®°å½•å·¥å…· - å®˜æ–¹é»˜è®¤ï¼štensorboardã€‚">
                                        <option value="tensorboard" selected>tensorboard</option>
                                        <option value="wandb">wandb</option>
                                        <option value="all">all</option>
                                    </select>
                                    <small style="color: #666; display: block; margin-top: 5px;">ğŸ’¡ å®˜æ–¹æ¨èï¼štensorboardï¼Œå¯è§†åŒ–è®­ç»ƒè¿‡ç¨‹</small>
                                </div>
                                
                            </div>
                        </div>

                </div>
            </div>
            
            <!-- é…ç½®æ“ä½œé¢æ¿ -->
            <div class="config-actions">
                <div class="panel">
                    <h2>ğŸ’¾ é…ç½®ç®¡ç†</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="saveConfig()" class="btn">ğŸ’¾ ä¿å­˜é…ç½®</button>
                        <button onclick="loadConfig()" class="btn">ğŸ“‚ åŠ è½½é…ç½®</button>
                        <button onclick="resetConfig()" class="btn">ğŸ”„ é‡ç½®é…ç½®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let isRunning = false;
        
        function setButtonsEnabled(enabled) {
            const buttons = ['cache-vae-btn', 'cache-te-btn', 'train-btn'];
            buttons.forEach(id => {
                document.getElementById(id).disabled = !enabled;
            });
            document.getElementById('stop-btn').disabled = enabled;
            isRunning = !enabled;
        }
        
        function updateStatus(status, message) {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            
            indicator.className = `status-indicator status-${status}`;
            text.textContent = message;
        }
        
        function updateProgress(percent) {
            document.getElementById('progress-fill').style.width = percent + '%';
        }
        
        function selectFile(inputId, fileExtension) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = fileExtension;
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„URLæ¥è¯»å–æ–‡ä»¶å†…å®¹å¹¶è·å–è·¯å¾„ä¿¡æ¯
                    const reader = new FileReader();
                    
                    // å°è¯•è·å–å®Œæ•´è·¯å¾„
                    let fullPath = file.name;
                    
                    // åœ¨æ”¯æŒçš„ç¯å¢ƒä¸­è·å–å®Œæ•´è·¯å¾„
                    if (file.path) {
                        fullPath = file.path;
                    } else if (file.webkitRelativePath) {
                        fullPath = file.webkitRelativePath;
                    } else {
                        // åœ¨æ ‡å‡†Webç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬æ— æ³•è·å–å®Œæ•´è·¯å¾„
                        // ä½†å¯ä»¥æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥æˆ–ä½¿ç”¨ç›¸å¯¹è·¯å¾„
                        const currentDir = 'C:\\Users\\oskey\\ai\\musubi-tuner';
                        const fileName = file.name;
                        
                        // æ ¹æ®æ–‡ä»¶ç±»å‹æ¨æµ‹å¯èƒ½çš„è·¯å¾„
                        if (fileExtension === '.toml') {
                            fullPath = currentDir + '\\ai_data\\datasets\\' + fileName;
                        } else if (fileExtension === '.safetensors') {
                            if (inputId === 'pretrained_model_name_or_path') {
                                fullPath = currentDir + '\\model\\diffusion_models\\' + fileName;
                            } else if (inputId === 'text_encoder_path') {
                                fullPath = currentDir + '\\model\\text_encoders\\' + fileName;
                            } else if (inputId === 'vae_path') {
                                fullPath = currentDir + '\\model\\vae\\' + fileName;
                            }
                        }
                    }
                    
                    document.getElementById(inputId).value = fullPath;
                    
                    // å¦‚æœæ˜¯æ•°æ®é›†é…ç½®æ–‡ä»¶ï¼Œè‡ªåŠ¨è¯»å–batch_sizeå’Œnum_repeats
                    if (inputId === 'dataset_config' && fileExtension === '.toml') {
                        readBatchSizeFromToml(fullPath);
                        readNumRepeatsFromToml(fullPath);
                    }
                }
            };
            input.click();
        }
        
        function selectFolder(inputId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.webkitdirectory = true;
            input.onchange = function(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    let folderPath;
                    
                    // å°è¯•è·å–å®Œæ•´è·¯å¾„
                    if (files[0].path) {
                        // ä»å®Œæ•´è·¯å¾„ä¸­æå–æ–‡ä»¶å¤¹è·¯å¾„
                        const fullPath = files[0].path;
                        const pathParts = fullPath.split(/[\\\/]/);
                        pathParts.pop(); // ç§»é™¤æ–‡ä»¶å
                        folderPath = pathParts.join('\\') + '\\';
                    } else if (files[0].webkitRelativePath) {
                        // åœ¨æ ‡å‡†Webç¯å¢ƒä¸­ï¼Œæ„å»ºå®Œæ•´è·¯å¾„
                        const relativePath = files[0].webkitRelativePath;
                        // ä¿®å¤BUGï¼šè·å–å®Œæ•´çš„æ–‡ä»¶å¤¹è·¯å¾„ï¼Œè€Œä¸æ˜¯åªå–ç¬¬ä¸€éƒ¨åˆ†
                        const pathParts = relativePath.split('/');
                        pathParts.pop(); // ç§»é™¤æ–‡ä»¶å
                        const folderRelativePath = pathParts.join('\\');
                        const currentDir = 'C:\\Users\\oskey\\ai\\musubi-tuner';
                        folderPath = currentDir + '\\' + folderRelativePath + '\\';
                    } else {
                        // å›é€€åˆ°ç›¸å¯¹è·¯å¾„
                        const path = files[0].webkitRelativePath ? files[0].webkitRelativePath.split('/')[0] : 'selected_folder';
                        folderPath = './' + path + '/';
                    }
                    
                    document.getElementById(inputId).value = folderPath;
                }
            };
            input.click();
        }
        
        function readBatchSizeFromToml(tomlPath) {
            fetch('/api/read_batch_size_from_toml', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ toml_path: tomlPath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.batch_size !== null) {
                    document.getElementById('batch_size').value = data.batch_size;
                    addLogEntry({
                        level: 'info',
                        message: `å·²ä» ${tomlPath} è¯»å– batch_size: ${data.batch_size}`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'warning',
                        message: data.message || 'æ— æ³•ä»TOMLæ–‡ä»¶è¯»å–batch_size',
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'è¯»å–TOMLæ–‡ä»¶å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function readNumRepeatsFromToml(tomlPath) {
            fetch('/api/read_num_repeats_from_toml', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ toml_path: tomlPath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.num_repeats !== null) {
                    document.getElementById('num_repeats').value = data.num_repeats;
                    addLogEntry({
                        level: 'info',
                        message: `å·²ä» ${tomlPath} è¯»å– num_repeats: ${data.num_repeats}`,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    addLogEntry({
                        level: 'warning',
                        message: data.message || 'æ— æ³•ä»TOMLæ–‡ä»¶è¯»å–num_repeats',
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            })
            .catch(error => {
                addLogEntry({
                    level: 'error',
                    message: 'è¯»å–TOMLæ–‡ä»¶å¤±è´¥: ' + error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
            });
        }
        
        function getConfig() {
            // è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è·å–å…ƒç´ å€¼
            function safeGetValue(id, defaultValue = '', isCheckbox = false) {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`Element with id '${id}' not found, using default value:`, defaultValue);
                    return defaultValue;
                }
                return isCheckbox ? element.checked : element.value;
            }
            
            function safeGetIntValue(id, defaultValue = 0) {
                const value = safeGetValue(id, defaultValue.toString());
                return parseInt(value) || defaultValue;
            }
            
            function safeGetFloatValue(id, defaultValue = 0.0) {
                const value = safeGetValue(id, defaultValue.toString());
                return parseFloat(value) || defaultValue;
            }
            
            const config = {
                enable_venv: safeGetValue('enable_venv', true, true),
                venv_python_path: safeGetValue('venv_python_path', './venv/Scripts/'),
                dataset_config: safeGetValue('dataset_config', './dataset_config.toml'),
                output_dir: safeGetValue('output_dir', './output'),
                pretrained_model_name_or_path: safeGetValue('pretrained_model_name_or_path', './model/diffusion_models/qwen_image_bf16.safetensors'),
                text_encoder_path: safeGetValue('text_encoder_path', './model/text_encoders/qwen_2.5_vl_7b.safetensors'),
                vae_path: safeGetValue('vae_path', './model/vae/qwen_image_vae.safetensors'),
                learning_rate: (() => {
                    const value = safeGetValue('learning_rate', '5e-05');
                    // å¦‚æœæ˜¯æ•°å­—æ ¼å¼(å¦‚0.00005)ï¼Œè½¬æ¢ä¸ºç§‘å­¦è®¡æ•°æ³•æ ¼å¼
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue) && numValue === 0.00005) {
                        return '5e-05';
                    }
                    return value;
                })(),
                batch_size: safeGetIntValue('batch_size', 1),
                num_repeats: safeGetIntValue('num_repeats', 5),
                gradient_accumulation_steps: safeGetIntValue('gradient_accumulation_steps', 1),
                mixed_precision: safeGetValue('mixed_precision', 'bf16'),
                network_dim: safeGetIntValue('network_dim', 8),
                network_alpha: safeGetIntValue('network_alpha', 16),
                optimizer_type: safeGetValue('optimizer_type', 'AdamW8bit'),
                lr_scheduler: safeGetValue('lr_scheduler', 'cosine'),
                lr_warmup_steps: safeGetIntValue('lr_warmup_steps', 100),
                discrete_flow_shift: safeGetFloatValue('discrete_flow_shift', 2.2),
                max_data_loader_n_workers: safeGetIntValue('max_data_loader_n_workers', 2),
                max_train_epochs: safeGetIntValue('max_train_epochs', 10),
                save_every_n_epochs: safeGetIntValue('save_every_n_epochs', 1),
                num_cpu_threads_per_process: safeGetIntValue('num_cpu_threads_per_process', 1),
                timestep_sampling: safeGetValue('timestep_sampling', 'uniform'),
                weighting_scheme: safeGetValue('weighting_scheme', 'logit_normal'),
                network_module: safeGetValue('network_module', 'networks.lora_qwen_image'),
                network_args: safeGetValue('network_args', 'loraplus_lr_ratio=4'),
                seed: safeGetIntValue('seed', 42),
                output_name: safeGetValue('output_name', 'lovemf_lora'),
                blocks_to_swap: safeGetIntValue('blocks_to_swap', 20),
                logging_dir: safeGetValue('logging_dir', './logs'),
                log_with: safeGetValue('log_with', 'tensorboard')
            };
            
            // ä¿å­˜æ‰€æœ‰checkboxçš„çŠ¶æ€ï¼ˆåŒ…æ‹¬æœªå‹¾é€‰çš„falseå€¼ï¼‰
            config.sdpa = safeGetValue('sdpa', false, true);
            config.gradient_checkpointing = safeGetValue('gradient_checkpointing', false, true);
            config.persistent_data_loader_workers = safeGetValue('persistent_data_loader_workers', false, true);
            config.enable_venv = safeGetValue('enable_venv', false, true);
            
            // æ–°å¢å‚æ•°çš„checkboxçŠ¶æ€
            config.fp8_base = safeGetValue('fp8_base', false, true);
            config.fp8_scaled = safeGetValue('fp8_scaled', false, true);
            
            return config;
        }
        
        function addLogEntry(entry) {
            const logOutput = document.getElementById('log-output');
            if (!logOutput) return;
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨åº•éƒ¨æˆ–æ¥è¿‘åº•éƒ¨ï¼ˆå®¹å·®20pxï¼‰
            const shouldScroll = logOutput.scrollTop + logOutput.clientHeight >= logOutput.scrollHeight - 20;
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry log-' + entry.level;
            logEntry.innerHTML = `<span style="color: #888;">[${entry.timestamp}]</span> ${entry.message}`;
            logOutput.appendChild(logEntry);
            
            // æ›´æ–°æ—¥å¿—è®¡æ•°
            lastLogCount++;
            
            // å¦‚æœç”¨æˆ·åœ¨åº•éƒ¨æˆ–æ¥è¿‘åº•éƒ¨ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—
            if (shouldScroll) {
                // ä½¿ç”¨setTimeoutç¡®ä¿DOMæ›´æ–°åå†æ»šåŠ¨
                setTimeout(() => {
                    logOutput.scrollTop = logOutput.scrollHeight;
                }, 10);
            }
        }
        
        function startCacheVAE() {
            if (isRunning) return;
            
            setButtonsEnabled(false);
            updateStatus('running', 'æ­£åœ¨é¢„ç¼“å­˜ VAE Latents...');
            
            const config = getConfig();
            
            fetch('/api/cache_vae', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatus('success', 'VAE Latents ç¼“å­˜å®Œæˆ');
                } else {
                    updateStatus('error', 'VAE ç¼“å­˜å¤±è´¥: ' + data.message);
                }
                setButtonsEnabled(true);
            })
            .catch(error => {
                updateStatus('error', 'è¯·æ±‚å¤±è´¥: ' + error.message);
                setButtonsEnabled(true);
            });
        }
        
        function startCacheTextEncoder() {
            if (isRunning) return;
            
            setButtonsEnabled(false);
            updateStatus('running', 'æ­£åœ¨é¢„ç¼“å­˜æ–‡æœ¬ç¼–ç å™¨è¾“å‡º...');
            
            const config = getConfig();
            
            fetch('/api/cache_text_encoder', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatus('success', 'æ–‡æœ¬ç¼–ç å™¨è¾“å‡ºç¼“å­˜å®Œæˆ');
                } else {
                    updateStatus('error', 'æ–‡æœ¬ç¼–ç å™¨ç¼“å­˜å¤±è´¥: ' + data.message);
                }
                setButtonsEnabled(true);
            })
            .catch(error => {
                updateStatus('error', 'è¯·æ±‚å¤±è´¥: ' + error.message);
                setButtonsEnabled(true);
            });
        }
        
        function startTraining() {
            if (isRunning) return;
            
            setButtonsEnabled(false);
            updateStatus('running', 'æ­£åœ¨å¼€å§‹è®­ç»ƒ...');
            
            const config = getConfig();
            
            fetch('/api/start_training', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatus('running', 'è®­ç»ƒè¿›è¡Œä¸­...');
                } else {
                    updateStatus('error', 'è®­ç»ƒå¯åŠ¨å¤±è´¥: ' + data.message);
                    setButtonsEnabled(true);
                }
            })
            .catch(error => {
                updateStatus('error', 'è¯·æ±‚å¤±è´¥: ' + error.message);
                setButtonsEnabled(true);
            });
        }
        
        function stopTraining() {
            fetch('/api/stop_training', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatus('idle', 'è®­ç»ƒå·²åœæ­¢');
                } else {
                    updateStatus('error', 'åœæ­¢è®­ç»ƒå¤±è´¥: ' + data.message);
                }
                setButtonsEnabled(true);
            })
            .catch(error => {
                updateStatus('error', 'è¯·æ±‚å¤±è´¥: ' + error.message);
            });
        }
        
        function startTensorBoard() {
            fetch('/api/start_tensorboard', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('âœ… TensorBoardå¯åŠ¨æˆåŠŸï¼\nè®¿é—®åœ°å€: http://localhost:6006');
                    // è‡ªåŠ¨æ‰“å¼€TensorBoardé¡µé¢
                    window.open('http://localhost:6006', '_blank');
                } else {
                    alert('âŒ TensorBoardå¯åŠ¨å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                alert('âŒ å¯åŠ¨TensorBoardæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            });
        }
        
        // å®šæœŸè·å–æ—¥å¿—
        let lastLogCount = 0;
        
        function fetchLogs() {
            fetch('/api/logs', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                cache: 'no-cache'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const logOutput = document.getElementById('log-output');
                if (!logOutput || !data.logs) return;
                
                // é‡ç½®é”™è¯¯è®¡æ•°å™¨ï¼ˆæˆåŠŸè·å–æ—¥å¿—ï¼‰
                window.logFetchErrorCount = 0;
                
                // åªå¤„ç†æ–°çš„æ—¥å¿—æ¡ç›®
                if (data.logs.length > lastLogCount) {
                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨åº•éƒ¨æˆ–æ¥è¿‘åº•éƒ¨ï¼ˆå®¹å·®50pxï¼‰
                    const isAtBottom = logOutput.scrollTop + logOutput.clientHeight >= logOutput.scrollHeight - 50;
                    
                    // åªæ·»åŠ æ–°çš„æ—¥å¿—æ¡ç›®
                    const newLogs = data.logs.slice(lastLogCount);
                    newLogs.forEach(entry => {
                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry log-' + entry.level;
                        logEntry.innerHTML = `<span style="color: #888;">[${entry.timestamp}]</span> ${entry.message}`;
                        logOutput.appendChild(logEntry);
                        
                        // æ£€æµ‹è®­ç»ƒå®ŒæˆçŠ¶æ€
                        if (entry.message.includes('âœ… LoRAè®­ç»ƒ å®Œæˆ') || 
                            entry.message.includes('âœ…') && (entry.message.includes('è®­ç»ƒ') || entry.message.includes('å®Œæˆ')) && entry.level === 'success') {
                            // è®­ç»ƒå®Œæˆï¼Œæ›´æ–°ç•Œé¢çŠ¶æ€
                            updateStatus('success', 'è®­ç»ƒå·²å®Œæˆ');
                            setButtonsEnabled(true);
                        }
                        
                        // æ£€æµ‹è®­ç»ƒå¤±è´¥çŠ¶æ€
                        if (entry.message.includes('âŒ') && (entry.message.includes('è®­ç»ƒ') || entry.message.includes('å¤±è´¥')) && entry.level === 'error') {
                            // è®­ç»ƒå¤±è´¥ï¼Œæ›´æ–°ç•Œé¢çŠ¶æ€
                            updateStatus('error', 'è®­ç»ƒå¤±è´¥');
                            setButtonsEnabled(true);
                        }
                    });
                    
                    lastLogCount = data.logs.length;
                    
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—ï¼ˆå¢åŠ å®¹å·®å¹¶ä½¿ç”¨æ›´å¯é çš„æ»šåŠ¨æ–¹æ³•ï¼‰
                    if (isAtBottom) {
                        // ä½¿ç”¨requestAnimationFrameç¡®ä¿DOMæ›´æ–°å®Œæˆåå†æ»šåŠ¨
                        requestAnimationFrame(() => {
                            logOutput.scrollTop = logOutput.scrollHeight;
                            // åŒé‡ä¿é™©ï¼Œå†æ¬¡æ»šåŠ¨
                            setTimeout(() => {
                                logOutput.scrollTop = logOutput.scrollHeight;
                            }, 50);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('è·å–æ—¥å¿—å¤±è´¥:', error);
                // åªåœ¨è¿ç»­å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯ï¼ˆé¿å…é¢‘ç¹æ˜¾ç¤ºé”™è¯¯ï¼‰
                if (!window.logFetchErrorCount) window.logFetchErrorCount = 0;
                window.logFetchErrorCount++;
                
                if (window.logFetchErrorCount <= 3) {
                    const logOutput = document.getElementById('log-output');
                    if (logOutput) {
                        const errorEntry = document.createElement('div');
                        errorEntry.className = 'log-entry log-error';
                        errorEntry.innerHTML = `<span style="color: #888;">[${new Date().toLocaleString()}]</span> è·å–æ—¥å¿—å¤±è´¥ (${window.logFetchErrorCount}/3): ${error.message}`;
                        logOutput.appendChild(errorEntry);
                        
                        // è‡ªåŠ¨æ»šåŠ¨åˆ°é”™è¯¯ä¿¡æ¯
                        setTimeout(() => {
                            logOutput.scrollTop = logOutput.scrollHeight;
                        }, 100);
                    }
                }
            });
        }
        
        // æ»šåŠ¨åˆ°åº•éƒ¨å‡½æ•°
        function scrollToBottom() {
            const logOutput = document.getElementById('log-output');
            if (logOutput) {
                logOutput.scrollTop = logOutput.scrollHeight;
            }
        }
        
        // æ¸…ç†æ—¥å¿—å‡½æ•°
        function clearLogs() {
            fetch('/api/clear_logs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const logOutput = document.getElementById('log-output');
                    if (logOutput) {
                        logOutput.innerHTML = '';
                        lastLogCount = 0;
                        // æ·»åŠ æ¸…ç†æˆåŠŸæç¤º
                        addLogEntry({
                            level: 'info',
                            timestamp: new Date().toLocaleString(),
                            message: 'æ—¥å¿—å·²æ¸…ç† ğŸ§¹'
                        });
                        // æ»šåŠ¨åˆ°åº•éƒ¨
                        setTimeout(() => {
                            logOutput.scrollTop = logOutput.scrollHeight;
                        }, 100);
                    }
                } else {
                    console.error('æ¸…ç†æ—¥å¿—å¤±è´¥:', data.message);
                }
            })
            .catch(error => {
                console.error('æ¸…ç†æ—¥å¿—è¯·æ±‚å¤±è´¥:', error);
            });
        }
        
        // åˆå§‹åŒ–
        updateStatus('idle', 'å°±ç»ª');
        // åˆå§‹è·å–æ—¥å¿—å¹¶æ»šåŠ¨åˆ°åº•éƒ¨
        fetchLogs();
        setTimeout(scrollToBottom, 500);
        setInterval(fetchLogs, 1000);
        
        function saveConfig() {
            const config = getConfig();
            
            fetch('/api/save_config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('âœ… é…ç½®ä¿å­˜æˆåŠŸï¼');
                } else {
                    alert('âŒ é…ç½®ä¿å­˜å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                alert('âŒ ä¿å­˜é…ç½®æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            });
        }
        
        function loadConfig(silent = false) {
            fetch('/api/load_config')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.config) {
                    const config = data.config;
                    
                    // æ›´æ–°æ‰€æœ‰è¡¨å•å­—æ®µ
                    Object.keys(config).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            if (element.type === 'checkbox') {
                                element.checked = config[key];
                            } else {
                                // ç‰¹æ®Šå¤„ç†learning_rateï¼Œç¡®ä¿æ˜¾ç¤ºä¸ºç§‘å­¦è®¡æ•°æ³•æ ¼å¼
                                if (key === 'learning_rate') {
                                    const numValue = parseFloat(config[key]);
                                    if (!isNaN(numValue) && numValue === 0.00005) {
                                        element.value = '5e-05';
                                    } else {
                                        element.value = config[key];
                                    }
                                } else {
                                    element.value = config[key];
                                }
                            }
                        } else {
                            console.warn(`Element with id '${key}' not found when loading config`);
                        }
                    });
                    
                    if (!silent) {
                        alert('âœ… é…ç½®åŠ è½½æˆåŠŸï¼');
                    }
                } else {
                    if (!silent) {
                        alert('âŒ é…ç½®åŠ è½½å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                }
            })
            .catch(error => {
                if (!silent) {
                    alert('âŒ åŠ è½½é…ç½®æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
                }
            });
        }
        
        function toggleSection(sectionId) {
             const section = document.getElementById(sectionId);
             const header = section.previousElementSibling;
             const icon = header.querySelector('.toggle-icon');
             
             if (section.classList.contains('collapsed')) {
                 section.classList.remove('collapsed');
                 header.classList.remove('collapsed');
                 icon.textContent = 'â–¼';
             } else {
                 section.classList.add('collapsed');
                 header.classList.add('collapsed');
                 icon.textContent = 'â–¶';
             }
         }
         
         function loadConfigSilently() {
             loadConfig(true);
         }
         
         function resetConfig() {
             if (confirm('ç¡®å®šè¦é‡ç½®é…ç½®å—ï¼Ÿè¿™å°†æ¢å¤æ‰€æœ‰å‚æ•°ä¸ºé»˜è®¤å€¼å¹¶è‡ªåŠ¨ä¿å­˜ã€‚')) {
                 fetch('/api/reset_config', {
                     method: 'POST'
                 })
                 .then(response => response.json())
                 .then(config => {
                     Object.keys(config).forEach(key => {
                         const element = document.getElementById(key);
                         if (element) {
                             if (element.type === 'checkbox') {
                                 element.checked = config[key];
                             } else {
                                 // ç‰¹æ®Šå¤„ç†learning_rateï¼Œç¡®ä¿æ˜¾ç¤ºä¸ºç§‘å­¦è®¡æ•°æ³•æ ¼å¼
                                 if (key === 'learning_rate') {
                                     const numValue = parseFloat(config[key]);
                                     if (!isNaN(numValue) && numValue === 0.00005) {
                                         element.value = '5e-05';
                                     } else {
                                         element.value = config[key];
                                     }
                                 } else {
                                     element.value = config[key];
                                 }
                             }
                         } else {
                             console.warn(`Element with id '${key}' not found when resetting config`);
                         }
                     });
                     // é‡ç½®åè‡ªåŠ¨ä¿å­˜é…ç½®
                     saveConfig();
                     alert('âœ… é…ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼å¹¶ä¿å­˜');
                 })
                 .catch(error => {
                     alert('âŒ é‡ç½®é…ç½®å¤±è´¥: ' + error.message);
                 });
             }
         }
         
         function checkFiles() {
             fetch('/api/check_files')
                 .then(response => response.json())
                 .then(data => {
                     let message = 'æ–‡ä»¶æ£€æŸ¥ç»“æœ:\n';
                     if (data.dataset_exists) {
                         message += 'âœ“ æ•°æ®é›†é…ç½®æ–‡ä»¶å­˜åœ¨\n';
                     } else {
                         message += 'âœ— æ•°æ®é›†é…ç½®æ–‡ä»¶ä¸å­˜åœ¨\n';
                     }
                     if (data.model_exists) {
                         message += 'âœ“ æ¨¡å‹æ–‡ä»¶å­˜åœ¨\n';
                     } else {
                         message += 'âœ— æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨\n';
                     }
                     if (data.vae_exists) {
                         message += 'âœ“ VAEæ¨¡å‹æ–‡ä»¶å­˜åœ¨\n';
                     } else {
                         message += 'âœ— VAEæ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨\n';
                     }
                     alert(message);
                 })
                 .catch(error => {
                     alert('æ£€æŸ¥æ–‡ä»¶å¤±è´¥: ' + error.message);
                 });
         }
         
         // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
         // é«˜çº§å‚æ•°æŠ˜å åŠŸèƒ½
         function toggleSection(sectionId) {
             const content = document.getElementById(sectionId);
             const icon = document.getElementById('advanced-toggle-icon');
             
             if (content.style.display === 'none' || content.style.display === '') {
                 content.style.display = 'block';
                 icon.textContent = 'â–²';
             } else {
                 content.style.display = 'none';
                 icon.textContent = 'â–¼';
             }
         }
         
         // åˆå§‹åŒ–é»˜è®¤å€¼å‡½æ•°
         function initializeDefaults() {
             const defaults = {
                 enable_venv: true,
                 venv_python_path: './venv/Scripts/',
                 dataset_config: './ai_data/datasets/lovemf_config.toml',
                 dit_path: './model/diffusion_models/qwen_image_bf16.safetensors',
                 vae_path: './model/vae/qwen_image_vae.safetensors',
                 text_encoder_path: './model/text_encoders/qwen_2.5_vl_7b.safetensors',
                 output_dir: './output',
                 output_name: 'lovemf_lora',
                 mixed_precision: 'bf16',
                 timestep_sampling: 'shift',
                 weighting_scheme: 'none',
                 discrete_flow_shift: 2.2,
                 optimizer_type: 'adamw8bit',
                 learning_rate: '5e-05',
                 max_data_loader_n_workers: 2,
                 batch_size: 1,
                 num_repeats: 5,
                 network_module: 'networks.lora_qwen_image',
                 network_dim: 8,
                 network_args: 'loraplus_lr_ratio=4',
                 max_train_epochs: 8,
                 save_every_n_epochs: 1,
                 seed: 42,
                 num_cpu_threads_per_process: 1,
                 sdpa: true,
                 gradient_checkpointing: true,
                 persistent_data_loader_workers: true,
                 fp8_base: true,
                 fp8_scaled: true,
                 blocks_to_swap: 20,
                 logging_dir: './logs',
                 log_with: 'tensorboard'
             };
             
             Object.keys(defaults).forEach(key => {
                 const element = document.getElementById(key);
                 if (element && element.type !== 'checkbox') {
                     // å¯¹äºlearning_rateï¼Œå¼ºåˆ¶è®¾ç½®ä¸ºç§‘å­¦è®¡æ•°æ³•æ ¼å¼
                     if (key === 'learning_rate') {
                         element.value = defaults[key];
                     } else if (!element.value) {
                         element.value = defaults[key];
                     }
                 } else if (element && element.type === 'checkbox' && element.checked === false) {
                     element.checked = defaults[key];
                 }
             });
         }

         document.addEventListener('DOMContentLoaded', function() {
             // å…ˆè®¾ç½®é»˜è®¤å€¼
             initializeDefaults();
             
             // Learning Rateè¾“å…¥æ¡†äº‹ä»¶ç›‘å¬å™¨ - è‡ªåŠ¨è½¬æ¢ä¸ºç§‘å­¦è®¡æ•°æ³•æ ¼å¼
             const learningRateInput = document.getElementById('learning_rate');
             if (learningRateInput) {
                 learningRateInput.addEventListener('blur', function() {
                     const value = this.value.trim();
                     if (value) {
                         const numValue = parseFloat(value);
                         if (!isNaN(numValue) && numValue === 0.00005) {
                             this.value = '5e-05';
                         }
                     }
                 });
                 
                 learningRateInput.addEventListener('input', function() {
                     const value = this.value.trim();
                     if (value === '0.00005') {
                         this.value = '5e-05';
                     }
                 });
             }
             
             // è™šæ‹Ÿç¯å¢ƒå¼€å…³äº‹ä»¶ç›‘å¬
             const enableVenvCheckbox = document.getElementById('enable_venv');
             const venvPathGroup = document.getElementById('venv_path_group');
             
             function toggleVenvPath() {
                 if (enableVenvCheckbox.checked) {
                     venvPathGroup.style.display = 'block';
                 } else {
                     venvPathGroup.style.display = 'none';
                 }
             }
             
             enableVenvCheckbox.addEventListener('change', toggleVenvPath);
             toggleVenvPath(); // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
             
             // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨é™é»˜åŠ è½½é…ç½®
             loadConfigSilently();
         });
    </script>
</body>
</html>